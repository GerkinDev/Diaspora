/*! diaspora build on 2017-09-27 05:14:08 for v0.0.1 */
"use strict";function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(r=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,a=e}finally{try{!r&&o.return&&o.return()}finally{if(i)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Diaspora=e()}}(function(){return function e(t,n,r){function i(s,o){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!o&&u)return u(s,!0);if(a)return a(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return i(n||e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var a="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){var r=e("./lib/diaspora");t.exports=r},{"./lib/diaspora":8}],2:[function(e,t,n){var r=e("sequential-event"),i=e("lodash"),a=e("check-types"),s=e("bluebird"),o=function(e){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.remaps=n,a.remapsInverted=i.invert(n),a.classEntity=e,a.filters=r,a.on("ready",function(){a.state="ready"}).on("error",function(e){a.state="error",a.error=e}),a}return _inherits(t,r),_createClass(t,[{key:"waitReady",value:function(){var e=this;return new s(function(t,n){return"ready"===e.state?t(e):"error"===e.state?n(e.error):void e.on("ready",function(){return t(e)}).on("error",function(e){return n(e)})})}},{key:"remapInput",value:function(e,t){var n=this;if(!a.assigned(t))return t;var r=i.mapValues(t,function(e,t){return n.filters.input.hasOwnProperty(t)?n.filters.input[t](e):e});return i.mapKeys(r,function(e,t){return n.remaps.hasOwnProperty(t)?n.remaps[t]:t})}},{key:"remapOutput",value:function(e,t){var n=this;if(!a.assigned(t))return t;var r=i.mapValues(t,function(e,t){return n.filters.output.hasOwnProperty(t)?n.filters.output[t](e):e});return i.mapKeys(r,function(e,t){return n.remapsInverted.hasOwnProperty(t)?n.remapsInverted[t]:t})}},{key:"setIdHash",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"id";return e.idHash=i.assign({},e.idHash,_defineProperty({},this.name,e[t])),e}},{key:"matchEntity",value:function(e,t){return i.every(i.toPairs(e),function(e){var n=_slicedToArray(e,2),r=n[0],s=n[1];if(a.object(s)){var o=t[r];return i.every(s,function(e,t){switch(t){case"$exists":return e===!a.undefined(o);case"$equal":return!a.undefined(o)&&o===e;case"$diff":return!a.undefined(o)&&o!==e;case"$less":return!a.undefined(o)&&o<e;case"$lessEqual":return!a.undefined(o)&&o<=e;case"$greater":return!a.undefined(o)&&o>e;case"$greaterEqual":return!a.undefined(o)&&o>=e}return!1})}return!1})}},{key:"applyUpdateEntity",value:function(e,t){i.forEach(e,function(e,n){a.undefined(e)?delete t[n]:t[n]=e})}},{key:"normalizeOptions",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if((e=i.cloneDeep(e)).hasOwnProperty("limit")){var t=e.limit;if(a.string(t)&&(t=parseInt(t)),!a.integer(t)&&1/0!==t||t<0)throw new TypeError('Expect "options.limit" to be an integer equal to or above 0, have '+t);e.limit=t}if(e.hasOwnProperty("skip")){var n=e.skip;if(a.string(n)&&(n=parseInt(n)),!a.integer(n)||n<0||!isFinite(n))throw new TypeError('Expect "options.skip" to be a finite integer equal to or above 0, have '+n);e.skip=n}if(e.hasOwnProperty("page")){if(!e.hasOwnProperty("limit"))throw new ReferenceError('Usage of "options.page" requires "options.limit" to be defined.');if(!isFinite(e.limit))throw new ReferenceError('Usage of "options.page" requires "options.limit" to not be infinite');if(e.hasOwnProperty("skip"))throw new Error('Use either "options.page" or "options.skip"');var r=e.page;if(a.string(r)&&(r=parseInt(r)),!a.integer(r)||r<0)throw new TypeError('Expect "options.page" to be an integer equal to or above 0, have '+r);e.skip=r*e.limit,delete e.page}return i.defaults(e,{skip:0,remapInput:!0,remapOutput:!0}),e}},{key:"normalizeQuery",value:function(e,t){var n={"~":"$exists","==":"$equal","!=":"$diff","<":"$less","<=":"$lessEqual",">":"$greater",">=":"$greaterEqual"};return!0===t.remapInput?i(i.cloneDeep(e)).mapValues(function(e,t){return a.assigned(e)&&e instanceof Object?(i.forEach(n,function(t,n){if(e.hasOwnProperty(n)){if(e.hasOwnProperty(t))throw new Error("Search can't have both \""+n+'" and "'+t+'" keys, as they are synonyms');e[t]=e[n],delete e[n]}}),i.forEach(["$less","$lessEqual","$greater","$greaterEqual"],function(t){if(e.hasOwnProperty(t)&&!a.number(e[t]))throw new TypeError('Expect "'+t+'" in '+JSON.stringify(e)+" to be a numeric value")}),e):a.assigned(e)?{$equal:e}:{$exists:!1}}).value():i.cloneDeep(e)}},{key:"insertOne",value:function(e,t){return this.insertMany(e,[t]).then(function(e){return s.resolve(i.first(e))})}},{key:"insertMany",value:function(e,t){var n=this;return s.mapSeries(t,function(t){return n.insertOne(e,t||{})})}},{key:"findOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.limit=1,this.findMany(e,t,n).then(function(e){return s.resolve(i.first(e))})}},{key:"findMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=[],o=0,u=(r=this.normalizeOptions(r)).skip;return function c(l){return a.assigned(l)?(!0!==l&&i.push(l),o===r.limit?s.resolve(i):(r.skip=u+o,o++,n.findOne(e,t,r).then(c))):s.resolve(i)}(!0)}},{key:"updateOne",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return r.limit=1,this.updateMany(e,t,n,r).then(function(e){return s.resolve(i.first(e))})}},{key:"updateMany",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=[],u=0;return function c(l){return a.assigned(l)?(!0!==l&&o.push(l),u===i.limit?s.resolve(o):(i.skip=u,u++,r.updateOne(e,t,n,i).then(c))):s.resolve(o)}(!0)}},{key:"deleteOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.limit=1,this.deleteMany(e,t,n)}},{key:"deleteMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=0;return function o(){return n.findOne(e,t,r).then(function(u){return a.assigned(u)?i===r.limit?s.resolve():(i++,n.deleteOne(e,t,r).then(o)):s.resolve()})}()}}]),t}();t.exports=o},{bluebird:"bluebird","check-types":"check-types",lodash:"lodash","sequential-event":"sequential-event"}],3:[function(e,t,n){var r=e("lodash"),i=(e("check-types"),e("bluebird")),a=e("./baseAdapter.js"),s=e("../dataStoreEntities/inMemoryEntity.js"),o=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,s));return n.state="ready",n.store={},n}return _inherits(t,a),_createClass(t,[{key:"generateUUID",value:function(){var e=(new Date).getTime();return"undefined"!=typeof window&&window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}},{key:"getSafeTableExists",value:function(e){return this.store.hasOwnProperty(e)?this.store[e]:this.store[e]={items:[]}}},{key:"insertOne",value:function(e,t){t=r.cloneDeep(t);var n=this.getSafeTableExists(e);return t.id=this.generateUUID(),this.setIdHash(t),n.items.push(t),i.resolve(new this.classEntity(t,this))}},{key:"findOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=this.getSafeTableExists(e),s=r.filter(a.items,r.partial(this.matchEntity,t)),o=this.constructor.applyOptionsToSet(s,n);return i.resolve(o.length>0?new this.classEntity(r.first(o),this):void 0)}},{key:"findMany",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.getSafeTableExists(e),o=r.filter(s.items,r.partial(this.matchEntity,t)),u=this.constructor.applyOptionsToSet(o,a);return i.resolve(r.map(u,function(e){return new n.classEntity(e,n)}))}},{key:"updateOne",value:function(e,t,n){arguments.length>3&&void 0!==arguments[3]&&arguments[3];var a=this.getSafeTableExists(e),s=r.filter(a.items,r.partial(this.matchEntity,t)),o=r.first(s);return this.applyUpdateEntity(n,o),i.resolve(new this.classEntity(o))}},{key:"updateMany",value:function(e,t,n){var a=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=this.getSafeTableExists(e),u=r.filter(o.items,r.partial(this.matchEntity,t)),c=this.constructor.applyOptionsToSet(u,s);return r.forEach(c,function(e){a.applyUpdateEntity(n,e)}),i.resolve(r.map(c,function(e){return new a.classEntity(e,a)}))}},{key:"deleteOne",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.getSafeTableExists(e);return this.findOne(e,t,a).then(function(e){return s.items=r.reject(s.items,function(t){return t.id===e.idHash[n.name]}),i.resolve()})}},{key:"deleteMany",value:function(e,t){var n=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.getSafeTableExists(e);return this.findMany(e,t,a).then(function(e){var t=r.map(e,function(e){return r.get(e,"idHash."+n.name)});return s.items=r.reject(s.items,function(e){return r.includes(t,e.id)}),i.resolve()})}}],[{key:"applyOptionsToSet",value:function(e,t){return r.defaults(t,{limit:1/0,skip:0}),(e=e.slice(t.skip)).length>t.limit&&(e=e.slice(0,t.limit)),e}}]),t}();t.exports=o},{"../dataStoreEntities/inMemoryEntity.js":6,"./baseAdapter.js":2,bluebird:"bluebird","check-types":"check-types",lodash:"lodash"}],4:[function(e,t,n){var r=e("lodash"),i=e("check-types"),a=e("bluebird"),s=e("./baseAdapter.js"),o=e("../dataStoreEntities/localStorageEntity.js"),u=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,o));return r.defaults(e,{session:!1}),n.state="ready",n.source=!0===e.session?sessionStorage:localStorage,n}return _inherits(t,s),_createClass(t,[{key:"generateUUID",value:function(){var e=(new Date).getTime();return"undefined"!=typeof window&&window.performance&&"function"==typeof window.performance.now&&(e+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}},{key:"ensureTableExists",value:function(e){i.assigned(this.source.getItem(e))||this.source.setItem(e,"[]")}},{key:"getItemName",value:function(e,t){return e+".id="+t}},{key:"insertOne",value:function(e,t){t=r.cloneDeep(t||{}),this.ensureTableExists(e),t.id=this.generateUUID(),this.setIdHash(t);try{var n=JSON.parse(this.source.getItem(e));n.push(t.id),this.source.setItem(e,JSON.stringify(n)),this.source.setItem(this.getItemName(e,t.id),JSON.stringify(t))}catch(e){return a.reject(e)}return a.resolve(new this.classEntity(t,this))}},{key:"insertMany",value:function(e,t){var n=this;t=r.cloneDeep(t),this.ensureTableExists(e);try{var i=JSON.parse(this.source.getItem(e));t=t.map(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};arguments[1];return t.id=n.generateUUID(),n.setIdHash(t),i.push(t.id),n.source.setItem(n.getItemName(e,t.id),JSON.stringify(t)),new n.classEntity(t,n)}),this.source.setItem(e,JSON.stringify(i))}catch(e){return a.reject(e)}return a.resolve(t)}},{key:"findOneById",value:function(e,t){var n=this.source.getItem(this.getItemName(e,t));return i.assigned(n)?a.resolve(new this.classEntity(JSON.parse(n),this)):a.resolve()}},{key:"findOne",value:function(e,t){var n=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r.defaults(s,{skip:0}),this.ensureTableExists(e),!i.object(t))return this.findOneById(e,t);if(r.isEqual(r.keys(t),["id"])&&r.isEqual(r.keys(t.id),["$equal"]))return this.findOneById(e,t.id.$equal);var o=JSON.parse(this.source.getItem(e)),u=void 0,c=0;return r.each(o,function(r){var i=JSON.parse(n.source.getItem(n.getItemName(e,r)));if(n.matchEntity(t,i)&&++c>s.skip)return u=i,!1}),a.resolve(i.assigned(u)?new this.classEntity(u,this):void 0)}},{key:"updateOne",value:function(e,t,n,s){var o=this;return r.defaults(s,{skip:0}),this.ensureTableExists(e),this.findOne(e,t,s).then(function(t){if(!i.assigned(t))return a.resolve();t=t.toObject(),o.applyUpdateEntity(n,t);try{return o.source.setItem(o.getItemName(e,t.id),JSON.stringify(t)),a.resolve(t)}catch(e){return a.reject(e)}})}},{key:"deleteOne",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.ensureTableExists(e),this.findOne(e,t,i).then(function(t){try{var i=JSON.parse(n.source.getItem(e));r.pull(i,t.id),n.source.setItem(e,JSON.stringify(i)),n.source.removeItem(n.getItemName(e,t.id))}catch(e){return a.reject(e)}return a.resolve()})}},{key:"deleteMany",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.ensureTableExists(e);try{var s=JSON.parse(this.source.getItem(e));return this.findMany(e,t,i).then(function(t){return r.pullAll(s,r.map(t,"id")),n.source.setItem(e,JSON.stringify(s)),r.forEach(t,function(t){n.source.removeItem(n.getItemName(e,t.id))}),a.resolve()})}catch(e){return a.reject(e)}}}],[{key:"applyOptionsToSet",value:function(e,t){return t.hasOwnProperty("limit")&&(i.integer(t.limit)?e=e.slice(0,t.limit):ModelExtension.log.warn('Trying to apply a non-integer limit "'+t.limit+'".')),e}}]),t}();t.exports=u},{"../dataStoreEntities/localStorageEntity.js":7,"./baseAdapter.js":2,bluebird:"bluebird","check-types":"check-types",lodash:"lodash"}],5:[function(e,t,n){var r=e("lodash"),i=e("check-types"),a=function(){function e(t,n){_classCallCheck(this,e),i.assigned(t)&&(Object.defineProperties(this,{dataSource:{value:n,enumerable:!1,configurable:!1}}),r.assign(this,t))}return _createClass(e,[{key:"toObject",value:function(){return r.omit(this,"dataSource")}}]),e}();t.exports=a},{"check-types":"check-types",lodash:"lodash"}],6:[function(e,t,n){var r=e("./baseEntity.js"),i=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,r),t}();t.exports=i},{"./baseEntity.js":5}],7:[function(e,t,n){var r=e("./baseEntity.js"),i=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,r),t}();t.exports=i},{"./baseEntity.js":5}],8:[function(e,t,n){function r(e,t){var n=i.clone(e);return n.push(t),n}var i=e("lodash"),a=e("check-types"),s=e("./adapters/baseAdapter.js"),o={"in-memory":e("./adapters/inMemoryAdapter"),localstorage:e("./adapters/localStorageAdapter")},u={},c={},l=function(e,t,n){var r=function(e,t){return e instanceof n.classEntity||!a.assigned(e)?e:new n.classEntity(e,n)};return function(s){for(var o=arguments.length,u=Array(o>1?o-1:0),c=1;c<o;c++)u[c-1]=arguments[c];var l=!1,f=!1;["find","delete"].indexOf(t.query)>=0?l=1:"update"===t.query&&(l=2,f=!0);try{!1!==l&&(u[l]=n.normalizeOptions(u[l]),u[0]=n.normalizeQuery(u[0],u[l]),!0===u[l].remapInputs&&(u[0]=n.remapFields(u[0]),!0===f&&(u[1]=n.remapFields(u[1]))),u[l].remapInput=!1)}catch(e){return Promise.reject(e)}return e.call.apply(e,[n,s].concat(u)).then(function(e){return e=a.array(e)?i.map(e,r):r(e),Promise.resolve(e)})}},f={check:function(e,t){var n=this;return i(t).mapValues(function(t,r){return n.checkField.call(n,e[r],t,[r])}).values().flatten().compact().value()},checkField:function(e,t,n){var s=this;if(!a.not.object(t)){i.defaults(t,{required:!1});var o=[];if(t.validate&&(t.validate.call(this,e,t)||o.push(n.join(".")+" custom validation failed")),a.assigned(t.type)&&a.assigned(t.model))o.push(n.join(".")+" spec can't have both a type and a model");else{var u=a;if(!0!==t.required&&(u=a.maybe),a.assigned(t.model)){a.string(t.model)?o.push(n.join(".")+' spec "model" string does not match with any registered model'):o.push(n.join(".")+' spec "model" must be either a string or a Backbone.RelationalModel instance')}else if(a.string(t.type))switch(t.type){case"string":u.string(e)||o.push(n.join(".")+" expected to be a "+t.type);break;case"integer":u.integer(e)||o.push(n.join(".")+" expected to be a "+t.type);break;case"float":u.number(e)||o.push(n.join(".")+" expected to be a "+t.type);break;case"date":u.date(e)||o.push(n.join(".")+" expected to be a "+t.type);break;case"object":if(u.object(e)){var c=a.object(t.attributes)?i(e).mapValues(function(e,i){return s.checkField(e,t.attributes[i],r(n,i))}).values().flatten().compact().value():[];0!==c.length&&(o=o.concat(c))}else o.push(n.join(".")+" expected to be a "+t.type);break;case"array":if(u.array(e)){var l=a.object(t.of)?i(e).map(function(e,o){if(!a.array(t.of))return s.checkField(e,t.of,r(n,o));var u=i(t.of).map(function(t){return s.checkField(e,t,r(n,o))});return i.find(u,function(e){return 0===e.length})?void 0:u}).flatten().compact().value():[];0!==l.length&&(o=o.concat(l))}else o.push(n.join(".")+" expected to be a "+t.type);break;case"any":u.assigned(e)||o.push(n.join(".")+" expected to be assigned with any type");break;default:o.push(n.join(".")+" requires to be unhandled type "+t.type)}else o.push(n.join(".")+' spec "type" must be a string')}return a.assigned(t.enum)&&!1===i.some(t.enum,function(t){return a.instance(t,RegExp)?a.match(e,t):a.equal(e,t)})&&o.push(n.join(".")+" expected to have a value"),o}},default:function(e,t){var n=this;return i.defaults(e,i.mapValues(t,function(t,r){return n.defaultField(e[r],t)}))},defaultField:function(e,t){var n;return n=a.not.undefined(e)?e:a.function(t.default)?t.default():t.default,"object"===t.type&&a.nonEmptyObject(t.attributes)&&a.assigned(n)?this.default(n,t.attributes):n},createDataSource:function(e,t){if(!o.hasOwnProperty(e))throw new Error('Unknown adapter "'+e+'". Available currently are '+Object.keys(o).join(", "));var n=new o[e](t);return new Proxy(n,{get:function(e,t){var n=void 0;return a.string(t)&&(n=t.match(/^(find|update|insert|delete)(Many|One)$/))?(n[2]=n[2].toLowerCase(),n=i.mapKeys(n.slice(0,3),function(e,t){return["full","query","number"][t]}),l(e[t],n,e)):e[t]}})},registerDataSource:function(e,t,n){if(!a.nonEmptyString(e))throw new Error('Module name must be a non empty string, had "'+e+'"');if(!a.nonEmptyString(t))throw new Error('DataSource name must be a non empty string, had "'+t+'"');if(u.hasOwnProperty(t))throw new Error('DataSource name already used, had "'+t+'"');if(!(n instanceof s))throw new Error('DataSource must be an instance inheriting "DiasporaAdapter"');n.name=t,i.merge(u,_defineProperty({},e,_defineProperty({},t,n)))},declareModel:function(e,t,n){if(!a.nonEmptyString(e))throw new Error('Module name must be a non empty string, had "'+e+'"');if(!a.nonEmptyString(t))throw new Error('DataSource name must be a non empty string, had "'+t+'"');if(!a.object(n))throw new Error('"modelDesc" must be an object');var r=new d(e,t,n);return i.assign(c,_defineProperty({},e,{})),c[e][t]=r,r},models:c,dataSources:u,adapters:o};t.exports=f;var d=e("./model")},{"./adapters/baseAdapter.js":2,"./adapters/inMemoryAdapter":3,"./adapters/localStorageAdapter":4,"./model":10,"check-types":"check-types",lodash:"lodash"}],9:[function(e,t,n){function r(e,t,n){var r=i.keys(t);return Object.defineProperties(function(){var u=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l="orphan",f=null,d=Object.seal(i.mapValues(n.dataSources,function(){}));u instanceof o&&(l="sync",d[f=u.dataSource.name]=u,u=u.toObject());i.keys(u);var h=i.intersection(u,c);if(0!==h.length)throw new Error("Source has reserved keys: "+JSON.stringify(h)+" in "+JSON.stringify(u));var p=i.difference(u,r);if(0!==p.length)throw new Error("Source has unknown keys: "+JSON.stringify(p)+" in "+JSON.stringify(u));var y=i.cloneDeep(u);u=null,s.default(y,t);var v=Object.defineProperties(this,i.extend({model:{value:n},dataSources:{value:d},toObject:{value:function(){return i.omit(y,c)}},persist:{value:function(e){var t=this,n=this.model.getDataSource(e),r=void 0;return r="orphan"===l?n.insertOne(this.getTable(e),this.toObject()):n.updateOne(this.getTable(e),this.getUidQuery(n),this.toObject()),l="syncing",f=n.name,r.then(function(e){return l="sync",v.dataSources[n.name]=e,y=e.toObject(),a.resolve(t)})}},fetch:{value:function(e){var t=this,n=this.model.getDataSource(e),r=void 0;return r="orphan"===l?a.reject("Can't fetch an orphan entity"):n.findOne(this.getTable(e),this.getUidQuery(n)),l="syncing",f=n.name,r.then(function(e){return l="sync",v.dataSources[n.name]=e,y=e.toObject(),a.resolve(t)})}},destroy:{value:function(e){var t=this,r=this.model.getDataSource(e),s=void 0;return s="orphan"===l?a.reject("Can't destroy an orphan entity"):r.deleteOne(this.getTable(e),this.getUidQuery(r)),l="syncing",f=r.name,s.then(function(e){return 0===i.without(n.dataSources,r.name).length?(l="orphan",delete y.id,delete y.idHash):(l="sync",delete y.idHash[r.name]),v.dataSources[r.name]=void 0,a.resolve(t)})}},getState:{value:function(){return l}},getLastDataSource:{value:function(){return f}},getUidQuery:{value:function(e){return{id:y.idHash[e.name]}}},getTable:{value:function(t){return e}}}));return new Proxy(v,{get:function(e,t){return"constructor"===t?v[t]:v.hasOwnProperty(t)?v[t]:y[t]},set:function(e,t,n){return v.hasOwnProperty(t)?(console.warn("Trying to define read-only key "+t+"."),n):y[t]=n},enumerate:function(e){return i.keys(y)},ownKeys:function(e){return i(y).keys().concat(c).value()},has:function(e,t){return y.hasOwnProperty(t)}})},{name:{value:e+"Entity",writable:!1,enumerable:!0},model:{value:n,writable:!1,enumerable:!0}})}var i=e("lodash"),a=e("bluebird"),s=e("./diaspora"),o=e("./dataStoreEntities/baseEntity"),u={model:{writable:!1,enumerable:!0},dataSources:{writable:!1,enumerable:!0},toObject:{writable:!1,enumerable:!0},persist:{writable:!1,enumerable:!0},fetch:{writable:!1,enumerable:!0},destroy:{writable:!1,enumerable:!0},getState:{writable:!1,enumerable:!0},getLastDataSource:{writable:!1,enumerable:!0},getUidQuery:{writable:!1,enumerable:!0},getTable:{writable:!1,enumerable:!0}},c=i.keys(u);i.assign(r,{entityPrototype:u,entityPrototypeProperties:c}),t.exports=r},{"./dataStoreEntities/baseEntity":5,"./diaspora":8,bluebird:"bluebird",lodash:"lodash"}],10:[function(e,t,n){var r=e("lodash"),i=e("check-types"),a=e("bluebird"),s=e("./entityFactory"),o=e("./diaspora"),u=s.entityPrototypeProperties,c=function(){function e(t,n,a){_classCallCheck(this,e);var c=r.intersection(u,r.keys(a.attributes));if(0!==c.length)throw new Error(JSON.stringify(c)+" is/are reserved property names. To match those column names in data source, please use the data source mapper property");if(!a.hasOwnProperty("sources")||!i.array(a.sources)&&!i.object(a.sources))throw new TypeError("Expect model sources to be either an array or an object, had "+JSON.stringify(a.sources)+".");var l=i.object(a.sources)?r.keys(a.sources):a.sources,f=o.dataSources[t],d=r.pick(f,l),h=r.difference(l,r.keys(d));if(0!==h.length)throw new Error("Missing data sources "+h.map(function(e){return'"'+e+'"'}).join(", "));this.dataSources=d,this.defaultDataSource=l[0],this.name=n,this.entityFactory=s(n,a.attributes,this)}return _createClass(e,[{key:"getDataSource",value:function(e){if(i.assigned(e)){if(!this.dataSources.hasOwnProperty(e))throw new Error('Unknown data source "'+e+'" in model "'+this.name+'", available are '+r.keys(this.dataSources).map(function(e){return'"'+e+'"'}).join(", "))}else e=this.defaultDataSource;return this.dataSources[e]}},{key:"spawn",value:function(e){return new this.entityFactory(e)}},{key:"spawnMulti",value:function(e){var t=this;return r.map(e,function(e){return t.spawn(e)})}},{key:"insert",value:function(e,t){var n=this;return this.getDataSource(t).insertOne(this.name,e).then(function(e){return a.resolve(new n.entityFactory(e))})}},{key:"insertMany",value:function(e,t){var n=this;return this.getDataSource(t).insertMany(this.name,e).then(function(e){return a.resolve(r.map(e,function(e){return new n.entityFactory(e)}))})}},{key:"find",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];i.string(n)&&!i.assigned(r)?(r=n,n={}):!i.string(e)||i.assigned(n)||i.assigned(r)||(r=e,e={},n={});var s=this.getDataSource(r);return s.findOne(this.name,e,n).then(function(e){if(!i.assigned(e))return a.resolve();var n=new t.entityFactory(e.toObject());return n.dataSources[s.name]=e,a.resolve(n)})}},{key:"findMany",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments[2];i.string(n)&&!i.assigned(s)?(s=n,n={}):!i.string(e)||i.assigned(n)||i.assigned(s)||(s=e,e={},n={});var o=this.getDataSource(s);return o.findMany(this.name,e,n).then(function(e){var n=r.map(e,function(e){var n=new t.entityFactory(e.toObject());return n.dataSources[o.name]=e,n});return a.resolve(n)})}},{key:"update",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments[3];i.string(r)&&!i.assigned(s)&&(s=r,r={});var o=this.getDataSource(s);return o.updateOne(this.name,e,t,r).then(function(e){var t=new n.entityFactory(e.toObject());return t.dataSources[o.name]=e,a.resolve(t)})}},{key:"updateMany",value:function(e,t){var n=this,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments[3];i.string(s)&&!i.assigned(o)&&(o=s,s={});var u=this.getDataSource(o);return u.updateMany(this.name,e,t,s).then(function(e){var t=r.map(e,function(e){var t=new n.entityFactory(e.toObject());return t.dataSources[u.name]=e,t});return a.resolve(t)})}},{key:"delete",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];return i.string(t)&&!i.assigned(n)&&(n=t,t={}),this.getDataSource(n).deleteOne(this.name,e,t)}},{key:"deleteMany",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];return i.string(t)&&!i.assigned(n)&&(n=t,t={}),this.getDataSource(n).deleteMany(this.name,e,t)}}]),e}();t.exports=c},{"./diaspora":8,"./entityFactory":9,bluebird:"bluebird","check-types":"check-types",lodash:"lodash"}]},{},[1])(1)});
//# sourceMappingURL=diaspora.min.js.map