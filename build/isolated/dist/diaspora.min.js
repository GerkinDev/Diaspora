/**
* @file diaspora
*
* Multi-Layer ORM for Javascript Client+Server
* Isolated build compiled on 2017-11-02 05:05:55
*
* @license GPL-3.0
* @version 0.2.0-rc.3
* @author Gerkin
*/
function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _get=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(n)},_slicedToArray=function(){function e(e,t){var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{!n&&s.return&&s.return()}finally{if(i)throw o}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Diaspora=e()}}(function(){return function e(t,r,n){function i(a,s){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[a]={exports:{}};t[a][0].call(l.exports,function(e){var r=t[a][1][e];return i(r||e)},l,l.exports,e,t,r,n)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(e,t,r){"use strict";var n=e("./lib/diaspora");t.exports=n},{"./lib/diaspora":10}],2:[function(e,t,r){"use strict";var n=e("../dependencies")._;t.exports={OPERATORS:{$exists:function(e,t){return t===!n.isUndefined(e)},$equal:function(e,t){return!n.isUndefined(e)&&e===t},$diff:function(e,t){return!n.isUndefined(e)&&e!==t},$less:function(e,t){return!n.isUndefined(e)&&e<t},$lessEqual:function(e,t){return!n.isUndefined(e)&&e<=t},$greater:function(e,t){return!n.isUndefined(e)&&e>t},$greaterEqual:function(e,t){return!n.isUndefined(e)&&e>=t}},CANONICAL_OPERATORS:{"~":"$exists","==":"$equal","!=":"$diff","<":"$less","<=":"$lessEqual",">":"$greater",">=":"$greaterEqual"},QUERY_OPTIONS_TRANSFORMS:{limit:function(e){var t=e.limit;if(n.isString(t)&&(t=parseInt(t)),!n.isInteger(t)&&1/0!==t||t<0)throw new TypeError('Expect "options.limit" to be an integer equal to or above 0, have '+t);e.limit=t},skip:function(e){var t=e.skip;if(n.isString(t)&&(t=parseInt(t)),!n.isInteger(t)||t<0||!isFinite(t))throw new TypeError('Expect "options.skip" to be a finite integer equal to or above 0, have '+t);e.skip=t},page:function(e){if(!e.hasOwnProperty("limit"))throw new ReferenceError('Usage of "options.page" requires "options.limit" to be defined.');if(!isFinite(e.limit))throw new ReferenceError('Usage of "options.page" requires "options.limit" to not be infinite');if(e.hasOwnProperty("skip"))throw new Error('Use either "options.page" or "options.skip"');var t=e.page;if(n.isString(t)&&(t=parseInt(t)),!n.isInteger(t)||t<0)throw new TypeError('Expect "options.page" to be an integer equal to or above 0, have '+t);e.skip=t*e.limit,delete e.page}}}},{"../dependencies":9}],3:[function(e,t,r){"use strict";var n=e("../dependencies"),i=n._,o=n.Promise,a=n.SequentialEvent,s=function(e,t){var r=[],n=0,a=e.skip;return function s(u){return i.isNil(u)?o.resolve(r):(!0!==u&&r.push(u),n===e.limit?o.resolve(r):(e.skip=a+n,n++,t(e).then(s)))}},u=e("./baseAdapter-utils"),c=u.OPERATORS,l=u.CANONICAL_OPERATORS,f=u.QUERY_OPTIONS_TRANSFORMS,d=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.state="preparing",r.remaps={},r.remapsInverted={},r.filters={},r.classEntity=e,r.error=void 0,r.on("ready",function(){r.state="ready"}).on("error",function(e){r.state="error",r.error=e}),r}return _inherits(t,a),_createClass(t,[{key:"configureCollection",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.remaps[e]=t,this.remapsInverted[e]=i.invert(t),this.filters=r||{}}},{key:"waitReady",value:function(){var e=this;return new o(function(t,r){return"ready"===e.state?t(e):"error"===e.state?r(e.error):void e.on("ready",function(){return t(e)}).on("error",function(e){return r(e)})})}},{key:"remapFields",value:function(e,t){var r=(arguments.length>2&&void 0!==arguments[2]&&arguments[2]?this.remapsInverted:this.remaps)[e];return i.isNil(r)?t:i.mapKeys(t,function(e,t){return r.hasOwnProperty(t)?r[t]:t})}},{key:"remapInput",value:function(e,t){return this.remapIO(e,t,!0)}},{key:"remapOutput",value:function(e,t){return this.remapIO(e,t,!1)}},{key:"remapIO",value:function(e,t,r){var n=this;if(i.isNil(t))return t;var o=!0===r?"input":"output",a=i.mapValues(t,function(e,t){return i.isObject(i.get(n,["filters",o]))&&n.filters[o].hasOwnProperty(t)?n.filters.output[t](e):e}),s=!0===r?this.remaps:this.remapsInverted;return i.mapKeys(a,function(e,t){return s.hasOwnProperty(t)?s[t]:t})}},{key:"setIdHash",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"id";return e.idHash=i.assign({},e.idHash,_defineProperty({},this.name,e[t])),e}},{key:"matchEntity",value:function(e,t){return i.every(i.toPairs(e),function(e){var r=_slicedToArray(e,2),n=r[0],o=r[1];if(i.isObject(o)){var a=t[n];return i.every(o,function(e,t){return!!c.hasOwnProperty(t)&&c[t](a,e)})}return!1})}},{key:"normalizeOptions",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e=i.cloneDeep(e),i.forEach(f,function(t,r){e.hasOwnProperty(r)&&f[r](e)}),i.defaults(e,{skip:0,remapInput:!0,remapOutput:!0}),e}},{key:"normalizeQuery",value:function(e,t){return!0===t.remapInput?i(i.cloneDeep(e)).mapValues(function(e){return i.isUndefined(e)?{$exists:!1}:e instanceof Object?(e=i.mapKeys(e,function(e,t,r){if(l.hasOwnProperty(t)){if(r.hasOwnProperty(l[t]))throw new Error("Search can't have both \""+t+'" and "'+l[t]+'" keys, as they are synonyms');return l[t]}return t}),i.forEach(["$less","$lessEqual","$greater","$greaterEqual"],function(t){if(e.hasOwnProperty(t)&&!i.isNumber(e[t]))throw new TypeError('Expect "'+t+'" in '+JSON.stringify(e)+" to be a numeric value")}),e):{$equal:e}}).value():i.cloneDeep(e)}},{key:"insertOne",value:function(e,t){return this.insertMany(e,[t]).then(function(e){return o.resolve(i.first(e))})}},{key:"insertMany",value:function(e,t){var r=this;return o.mapSeries(t,function(t){return r.insertOne(e,t||{})})}},{key:"findOne",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.limit=1,this.findMany(e,t,r).then(function(e){return o.resolve(i.first(e))})}},{key:"findMany",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r=this.normalizeOptions(r),s(r,i.partial(this.findOne,e,t,i))(!0)}},{key:"updateOne",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return n=this.normalizeOptions(n),n.limit=1,this.updateMany(e,t,r,n).then(function(e){return o.resolve(i.first(e))})}},{key:"updateMany",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return n=this.normalizeOptions(n),s(n,i.partial(this.updateOne,e,t,r,i))(!0)}},{key:"deleteOne",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.limit=1,this.deleteMany(e,t,r)}},{key:"deleteMany",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=0;return function s(){return r.findOne(e,t,n).then(function(u){return i.isNil(u)?o.resolve():a===n.limit?o.resolve():(a++,r.deleteOne(e,t,n).then(s))})}()}}]),t}();t.exports=d},{"../dependencies":9,"./baseAdapter-utils":2}],4:[function(e,t,r){"use strict";var n=e("../dependencies"),i=n._,o=n.Promise,a=e("../utils"),s=e("./baseAdapter.js"),u=e("../dataStoreEntities/inMemoryEntity.js"),c=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u));return e.state="ready",e.store={},e}return _inherits(t,s),_createClass(t,[{key:"configureCollection",value:function(e,r){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"configureCollection",this).call(this,e,r),this.ensureCollectionExists(e)}},{key:"ensureCollectionExists",value:function(e){return this.store.hasOwnProperty(e)?this.store[e]:this.store[e]={items:[]}}},{key:"insertOne",value:function(e,t){t=i.cloneDeep(t);var r=this.ensureCollectionExists(e);return t.id=a.generateUUID(),this.setIdHash(t),r.items.push(t),o.resolve(new this.classEntity(t,this))}},{key:"findOne",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=this.ensureCollectionExists(e),s=i.filter(n.items,i.partial(this.matchEntity,t)),u=a.applyOptionsToSet(s,r);return o.resolve(u.length>0?new this.classEntity(i.first(u),this):void 0)}},{key:"findMany",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.ensureCollectionExists(e),u=i.filter(s.items,i.partial(this.matchEntity,t)),c=a.applyOptionsToSet(u,n);return o.resolve(i.map(c,function(e){return new r.classEntity(e,r)}))}},{key:"updateOne",value:function(e,t,r){var n=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.findOne(e,t,s).then(function(t){if(i.isNil(t))return o.resolve();var s=n.ensureCollectionExists(e),u=i.find(s.items,{id:t.id});return a.applyUpdateEntity(r,u),o.resolve(new n.classEntity(u,n))})}},{key:"updateMany",value:function(e,t,r){var n=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.findMany(e,t,s).then(function(t){if(!i.isNil(t)&&t.length>0){var s=n.ensureCollectionExists(e),u=i.map(t,"id"),c=i.filter(s.items,function(e){return-1!==u.indexOf(e.id)});return o.resolve(i.map(c,function(e){return a.applyUpdateEntity(r,e),new n.classEntity(e,n)}))}return o.resolve()})}},{key:"deleteOne",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=this.ensureCollectionExists(e);return this.findOne(e,t,n).then(function(e){return a.items=i.reject(a.items,function(t){return t.id===e.idHash[r.name]}),o.resolve()})}},{key:"deleteMany",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=this.ensureCollectionExists(e);return this.findMany(e,t,n).then(function(e){var t=i.map(e,function(e){return i.get(e,"idHash."+r.name)});return a.items=i.reject(a.items,function(e){return i.includes(t,e.id)}),o.resolve()})}}]),t}();t.exports=c},{"../dataStoreEntities/inMemoryEntity.js":7,"../dependencies":9,"../utils":18,"./baseAdapter.js":3}],5:[function(e,t,r){(function(r){"use strict";var n=e("../dependencies"),i=n._,o=n.Promise,a=e("../utils"),s=e("./baseAdapter.js"),u=e("../dataStoreEntities/webStorageEntity.js"),c=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,u));return i.defaults(e,{session:!1}),n.state="ready",n.source=!0===e.session?r.sessionStorage:r.localStorage,n}return _inherits(t,s),_createClass(t,[{key:"configureCollection",value:function(e,r){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"configureCollection",this).call(this,e,r),this.ensureCollectionExists(e)}},{key:"ensureCollectionExists",value:function(e){var t=this.source.getItem(e);return i.isNil(t)?(t=[],this.source.setItem(e,JSON.stringify(t))):t=JSON.parse(t),t}},{key:"getItemName",value:function(e,t){return e+".id="+t}},{key:"insertOne",value:function(e,t){(t=i.cloneDeep(t||{})).id=a.generateUUID(),this.setIdHash(t);try{var r=this.ensureCollectionExists(e);r.push(t.id),this.source.setItem(e,JSON.stringify(r)),this.source.setItem(this.getItemName(e,t.id),JSON.stringify(t))}catch(e){return o.reject(e)}return o.resolve(new this.classEntity(t,this))}},{key:"insertMany",value:function(e,t){var r=this;t=i.cloneDeep(t);try{var n=this.ensureCollectionExists(e);t=t.map(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.id=a.generateUUID(),r.setIdHash(t),n.push(t.id),r.source.setItem(r.getItemName(e,t.id),JSON.stringify(t)),new r.classEntity(t,r)}),this.source.setItem(e,JSON.stringify(n))}catch(e){return o.reject(e)}return o.resolve(t)}},{key:"findOneById",value:function(e,t){var r=this.source.getItem(this.getItemName(e,t));return i.isNil(r)?o.resolve():o.resolve(new this.classEntity(JSON.parse(r),this))}},{key:"findOne",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.defaults(n,{skip:0}),!i.isObject(t))return this.findOneById(e,t);if(i.isEqual(i.keys(t),["id"])&&i.isEqual(i.keys(t.id),["$equal"]))return this.findOneById(e,t.id.$equal);var a=this.ensureCollectionExists(e),s=void 0,u=0;return i.each(a,function(i){var o=JSON.parse(r.source.getItem(r.getItemName(e,i)));if(r.matchEntity(t,o)&&++u>n.skip)return s=o,!1}),o.resolve(i.isNil(s)?void 0:new this.classEntity(s,this))}},{key:"updateOne",value:function(e,t,r,n){var s=this;return i.defaults(n,{skip:0}),this.findOne(e,t,n).then(function(t){if(i.isNil(t))return o.resolve();a.applyUpdateEntity(r,t);try{return s.source.setItem(s.getItemName(e,t.id),JSON.stringify(t)),o.resolve(t)}catch(e){return o.reject(e)}})}},{key:"deleteOne",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.findOne(e,t,n).then(function(t){try{var n=r.ensureCollectionExists(e);i.pull(n,t.id),r.source.setItem(e,JSON.stringify(n)),r.source.removeItem(r.getItemName(e,t.id))}catch(e){return o.reject(e)}return o.resolve()})}},{key:"deleteMany",value:function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{return this.findMany(e,t,n).then(function(t){var n=r.ensureCollectionExists(e);return i.pullAll(n,i.map(t,"id")),r.source.setItem(e,JSON.stringify(n)),i.forEach(t,function(t){r.source.removeItem(r.getItemName(e,t.id))}),o.resolve()})}catch(e){return o.reject(e)}}}]),t}();t.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../dataStoreEntities/webStorageEntity.js":8,"../dependencies":9,"../utils":18,"./baseAdapter.js":3}],6:[function(e,t,r){"use strict";var n=e("../dependencies")._,i=function(){function e(t,r){if(_classCallCheck(this,e),!n.isNil(t)){if(n.isNil(r))throw new TypeError('Expect 2nd argument to be the parent of this entity, have "'+r+'"');Object.defineProperties(this,{dataSource:{value:r,enumerable:!1,configurable:!1}}),n.assign(this,t)}}return _createClass(e,[{key:"toObject",value:function(){return n.omit(this,["dataSource","id"])}}]),e}();t.exports=i},{"../dependencies":9}],7:[function(e,t,r){"use strict";var n=e("./baseEntity.js"),i=function(e){function t(e,r){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return _inherits(t,n),t}();t.exports=i},{"./baseEntity.js":6}],8:[function(e,t,r){"use strict";var n=e("./baseEntity.js"),i=function(e){function t(e,r){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r))}return _inherits(t,n),t}();t.exports=i},{"./baseEntity.js":6}],9:[function(e,t,r){(function(r){"use strict";t.exports={_:r._||e("lodash"),SequentialEvent:r.SequentialEvent||e("sequential-event"),Promise:r.Promise&&r.Promise.version?r.Promise:e("bluebird")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{bluebird:void 0,lodash:void 0,"sequential-event":void 0}],10:[function(e,t,r){(function(r){"use strict";var n=e("./dependencies"),i=n._,o=n.Promise,a=function(){if(r.browser)return console;var t=e("winston"),n=t.createLogger({level:"silly",format:t.format.json(),transports:[]});return"production"!==r.env.NODE_ENV&&n.add(new t.transports.Console({format:t.format.simple()})),n}(),s={},u={},c={},l=function(e,t,r){return function(n){for(var a=arguments.length,s=Array(a>1?a-1:0),u=1;u<a;u++)s[u-1]=arguments[u];var c=function(e){return(e=r.remapFields(n,e,!0))instanceof r.classEntity||i.isNil(e)?e:new r.classEntity(e,r)},l=!1,f=!1;["find","delete"].indexOf(t.query)>=0?l=1:"update"===t.query&&(l=2,f=!0);try{!1!==l?(s[l]=r.normalizeOptions(s[l]),!0===s[l].remapInput&&(s[0]=r.remapFields(n,s[0],!1),!0===f&&(s[1]=r.remapFields(n,s[1],!1))),s[0]=r.normalizeQuery(s[0],s[l]),s[l].remapInput=!1):"insert"===t.query&&("many"===t.number?s[0]=i.map(s[0],function(e){return r.remapFields(n,e,!1)}):s[0]=r.remapFields(n,s[0],!1))}catch(e){return o.reject(e)}return e.call.apply(e,[r,n].concat(s)).then(function(e){return i.isArrayLike(e)?e=i.map(e,c):i.isNil(e)||(e=c(e)),o.resolve(e)})}},f=function(e){return function(t,r,n){if(!e(n))return{type:t.join(".")+' expected to be a "'+r.type+'"'}}},d={TYPE:{string:f(i.isString),integer:f(i.isInteger),float:f(i.isNumber),date:f(i.isDate),object:function(e,t,r){if(!i.isObject(r))return{type:e.join(".")+' expected to be a "'+t.type+'"'};var n=i.isObject(t.attributes)?i(r).mapValues(function(r,n){return p.checkField(r,t.attributes[n],i.concat(e,[n]))}).omitBy(i.isEmpty).value():{};return i.isEmpty(n)?void 0:{children:n}},array:function(e,t,r){if(!i.isArray(r))return{type:e.join(".")+' expected to be a "'+t.type+'"'};var n=i.isObject(t.of)?i(r).map(function(r,n){if(!i.isArrayLike(t.of))return p.checkField(r,t.of,i.concat(e,[n]));var o=i(t.of).map(function(t){return p.checkField(r,t,i.concat(e,[n]))});return i.find(o,function(e){return 0===e.length})?void 0:o}).omitBy(i.isEmpty).value():{};return i.isEmpty(n)?void 0:{children:n}},any:function(e,t,r){if(!i.stubTrue(r))return{type:e.join(".")+" expected to be assigned with any type"}},_:function(e,t){return{type:e.join(".")+' requires to be unhandled type "'+t.type+'"'}}}},p={check:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return i(r).mapValues(function(r,n){return t.checkField.call(t,e[n],r,i.concat([],[n]))}).omitBy(i.isEmpty).value()},checkField:function(e,t,r){if(i.isObject(t)){i.defaults(t,{required:!1});var n={};if(t.validate&&(t.validate.call(this,e,t)||(n.validate=r.join(".")+" custom validation failed")),i.isNil(t.type)||i.isNil(t.model)){if(!0===t.required&&i.isNil(e))n.required=r.join(".")+' is a required property of type "'+t.type+'"';else if(!i.isNil(e))if(i.isString(t.type)){var o=i.get(d,["TYPE",t.type],t.type._);i.assign(n,o(r,t,e))}else n.spec=r.join(".")+' spec "type" must be a string'}else n.spec=r.join(".")+" spec can't have both a type and a model";return i.isNil(t.enum)||!1===i.some(t.enum,function(t){return t instanceof RegExp?null!==e.match(t):e===t})&&(n.enum=r.join(".")+' expected to have one of enumerated values "'+JSON.stringify(t.enum)+'"'),i.isEmpty(n)?void 0:(n.value=e,n)}},default:function(e,t){var r=this;return i.defaults(e,i.mapValues(t,function(t,n){return r.defaultField(e[n],t)}))},defaultField:function(e,t){var r=void 0;return r=i.isUndefined(e)?i.isFunction(t.default)?t.default():t.default:e,"object"===t.type&&i.isObject(t.attributes)&&i.keys(t.attributes).length>0&&!i.isNil(r)?this.default(r,t.attributes):r},createDataSource:function(e,t){if(!s.hasOwnProperty(e))throw new Error('Unknown adapter "'+e+'". Available currently are '+Object.keys(s).join(", "));var r=new s[e](t);return new Proxy(r,{get:function(e,t){if(i.isString(t)){var r=t.match(/^(find|update|insert|delete)(Many|One)$/);if(null!==r)return r[2]=r[2].toLowerCase(),r=i.mapKeys(r.slice(0,3),function(e,t){return["full","query","number"][t]}),l(e[t],r,e)}return e[t]}})},registerDataSource:function(e,t){if(!i.isString(e)&&e.length>0)throw new Error('DataSource name must be a non empty string, had "'+e+'"');if(u.hasOwnProperty(e))throw new Error('DataSource name already used, had "'+e+'"');if(!(t instanceof p.components.DiasporaAdapter))throw new Error('DataSource must be an instance inheriting "DiasporaAdapter"');t.name=e,i.merge(u,_defineProperty({},e,t))},createNamedDataSource:function(e,t,r){var n=p.createDataSource(t,r);p.registerDataSource(e,n)},declareModel:function(e,t){if(!i.isString(e)&&e.length>0)throw new Error('DataSource name must be a non empty string, had "'+e+'"');if(!i.isObject(t))throw new Error('"modelDesc" must be an object');var r=new p.components.Model(e,t);return i.assign(c,_defineProperty({},e,r)),r},registerAdapter:function(e,t){if(s[e])throw new Error('Adapter with label "'+e+'" already exists.');if(!(t.prototype instanceof p.components.DiasporaAdapter))throw new TypeError('Trying to register an adapter with label "'+e+'", but it does not extends DiasporaAdapter.');s[e]=t},models:c,dataSources:u,adapters:s,dependencies:n,logger:a};t.exports=p,p.components={EntityFactory:e("./entityFactory"),Entity:e("./entityFactory").Entity,Set:e("./set"),Model:e("./model"),Errors:{ExtendableError:e("./errors/extendableError"),EntityValidationError:e("./errors/entityValidationError"),SetValidationError:e("./errors/setValidationError"),EntityStateError:e("./errors/entityStateError")},DiasporaAdapter:e("./adapters/baseAdapter"),DataStoreEntity:e("./dataStoreEntities/baseEntity")},p.registerAdapter("inMemory",e("./adapters/inMemoryAdapter")),r.browser&&p.registerAdapter("webStorage",e("./adapters/webStorageAdapter"))}).call(this,e("_process"))},{"./adapters/baseAdapter":3,"./adapters/inMemoryAdapter":4,"./adapters/webStorageAdapter":5,"./dataStoreEntities/baseEntity":6,"./dependencies":9,"./entityFactory":11,"./errors/entityStateError":12,"./errors/entityValidationError":13,"./errors/extendableError":14,"./errors/setValidationError":15,"./model":16,"./set":17,_process:19,winston:void 0}],11:[function(e,t,r){"use strict";var n=e("./dependencies"),i=n._,o=n.Promise,a=n.SequentialEvent,s=e("./diaspora"),u=e("./dataStoreEntities/baseEntity"),c=e("./errors/entityValidationError"),l=e("./errors/entityStateError"),f={skipEvents:!1},d=Symbol("PRIVATE"),p=function e(t,r,n,a){return a=i.castArray(a),r.skipEvents?o.resolve(t):t.emit.apply(t,[a[0]].concat(_toConsumableArray(n))).then(function(){return a.length>1?e(t,r,n,i.slice(a,1)):o.resolve(t)})},h=function(e,t,r,n){return function(){return"orphan"===t?o.reject(new l("Can't fetch an orphan entity.")):(e[d].lastDataSource=r.name,r[n](e.table(r.name),e.uidQuery(r)))}},y={bindLifecycleEvents:function(e,t){i.forEach(t.lifecycleEvents,function(t,r){i.forEach(i.castArray(t),function(t){e.on(r,t)})})},loadSource:function(e,t){return t instanceof u&&(i.assign(e,{state:"sync",lastDataSource:t.dataSource.name}),e.dataSources[e.lastDataSource]=t,t=i.omit(t.toObject(),["id"])),t}},v=function(e){function t(e,r,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};_classCallCheck(this,t);var a=i.keys(r.attributes),u=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),c={state:"orphan",lastDataSource:null,dataSources:Object.seal(i.mapValues(n.dataSources,function(){})),name:e,modelDesc:r,model:n};u[d]=c,o=y.loadSource(c,o);var l=i.difference(o,a);if(0!==l.length)throw new Error("Source has unknown keys: "+JSON.stringify(l)+" in "+JSON.stringify(o));return c.attributes=s.default(i.cloneDeep(o),r.attributes),o=null,y.bindLifecycleEvents(u,r),u}return _inherits(t,a),_createClass(t,[{key:"uidQuery",value:function(e){return{id:this[d].attributes.idHash[e.name]}}},{key:"table",value:function(){return this[d].name}},{key:"validate",value:function(){var e=s.check(this[d].attributes,this[d].modelDesc.attributes);if(!i.isEmpty(e))throw new c(e,"Validation failed")}},{key:"replaceAttributes",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return e.idHash=this[d].attributes.idHash,this[d].attributes=e,this}},{key:"getDiff",value:function(e){var t=this,r=this[d].dataSources[e.name].toObject(),n=i(this[d].attributes).keys().concat(i.keys(r)).uniq().difference(["idHash"]).value(),o=i(n).filter(function(e){return t[d].attributes[e]!==r[e]}).map(function(e){return t[d].attributes[e]}).value();return i.zipObject(n,o)}},{key:"toObject",value:function(){return this[d].attributes}},{key:"persist",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i.defaults(r,f);var n=this[d].state;this[d].state="syncing";var o=this.constructor.model.getDataSource(e),a=[o.name],s=i.partial(p,this,r,a),u="orphan"===n?"Create":"Update";return s(["beforePersist","beforeValidate"]).then(function(){return t.validate()}).then(function(){return s(["afterValidate","beforePersist"+u])}).then(function(){return t[d].lastDataSource=o.name,"orphan"===n?o.insertOne(t.table(e),t.toObject()):o.updateOne(t.table(e),t.uidQuery(o),t.getDiff(o))}).then(function(e){return t[d].state="sync",t[d].attributes=e.toObject(),t[d].dataSources[o.name]=e,s(["afterPersist"+u,"afterPersist"])})}},{key:"fetch",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i.defaults(r,f);var n=this[d].state;this[d].state="syncing";var o=this.constructor.model.getDataSource(e),a=[o.name],s=i.partial(p,this,r,a);return s("beforeFetch").then(h(this,n,o,"findOne")).then(function(e){return t[d].state="sync",t[d].attributes=e.toObject(),t[d].dataSources[o.name]=e,s("afterFetch")})}},{key:"destroy",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i.defaults(r,f);var n=this[d].state;this[d].state="syncing";var o=this.constructor.model.getDataSource(e),a=[o.name],s=i.partial(p,this,r,a);return s("beforeDestroy").then(h(this,n,o,"deleteOne")).then(function(){return 0===i.without(t[d].model.dataSources,o.name).length?t[d].state="orphan":(t[d].state="sync",delete t[d].attributes.idHash[o.name]),t[d].dataSources[o.name]=void 0,s("afterDestroy")})}},{key:"dataSources",get:function(){return this[d].dataSources}},{key:"attributes",get:function(){return this[d].attributes}},{key:"state",get:function(){return this[d].state}},{key:"lastDataSource",get:function(){return this[d].lastDataSource}}]),t}();t.exports=function(e,t,r){var n=function(t){function n(){return _classCallCheck(this,n),_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).apply(this,arguments))}return _inherits(n,v),_createClass(n,null,[{key:"name",get:function(){return e+"Entity"}},{key:"model",get:function(){return r}}]),n}();return i.forEach(t.methods,function(e,t){n.__proto__[e]=t}),i.forEach(t.staticMethods,function(e,t){n[e]=t}),n.bind(v,e,t,r)}},{"./dataStoreEntities/baseEntity":6,"./dependencies":9,"./diaspora":10,"./errors/entityStateError":12,"./errors/entityValidationError":13}],12:[function(e,t,r){"use strict";var n=e("./extendableError"),i=function(e){function t(){var e;_classCallCheck(this,t);for(var r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return _possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(n)))}return _inherits(t,n),t}();t.exports=i},{"./extendableError":14}],13:[function(e,t,r){"use strict";var n=e("../dependencies")._,i=e("./extendableError"),o=function(e){return n(e).mapValues(function(e,t){return t+" => "+JSON.stringify(e.value)+"\n* "+n(e).omit(["value"]).values().map(n.identity).value()}).values().join("\n* ")},a=function(e){function t(e,r){var n;_classCallCheck(this,t),r+="\n"+o(e);for(var i=arguments.length,a=Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];var u=_possibleConstructorReturn(this,(n=t.__proto__||Object.getPrototypeOf(t)).call.apply(n,[this,r].concat(a)));return u.validationErrors=e,u}return _inherits(t,i),t}();t.exports=a},{"../dependencies":9,"./extendableError":14}],14:[function(e,t,r){"use strict";var n=function(e){function t(e){var r;_classCallCheck(this,t);for(var n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];var a=_possibleConstructorReturn(this,(r=t.__proto__||Object.getPrototypeOf(t)).call.apply(r,[this,e].concat(i)));return a.constructor=_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"target",a),"function"==typeof Error.captureStackTrace?Error.captureStackTrace(a,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"target",a)):a.stack=new Error(e).stack,a}return _inherits(t,Error),t}();t.exports=n},{}],15:[function(e,t,r){"use strict";var n=e("../dependencies")._,i=e("./extendableError"),o=function(e){function t(e,r){var i;_classCallCheck(this,t),e+="[\n"+n(r).map(function(e,t){return!n.isNil(e)&&t+": "+e.message.replace(/\n/g,"\n\t")}).filter(n.identity).join(",\n")+"\n]";for(var o=arguments.length,a=Array(o>2?o-2:0),s=2;s<o;s++)a[s-2]=arguments[s];var u=_possibleConstructorReturn(this,(i=t.__proto__||Object.getPrototypeOf(t)).call.apply(i,[this,e].concat(a)));return u.validationErrors=r,u}return _inherits(t,i),t}();t.exports=o},{"../dependencies":9,"./extendableError":14}],16:[function(e,t,r){"use strict";var n=e("./dependencies"),i=n._,o=n.Promise,a=e("./entityFactory"),s=e("./diaspora"),u=e("./set"),c=a.entityPrototypeProperties,l=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3],o=void 0;return o=i.isString(r)&&i.isNil(n)?{dataSourceName:r,options:{}}:i.isString(t)&&i.isNil(r)&&i.isNil(n)?{dataSourceName:t,queryFind:{},options:{}}:{queryFind:t,options:r,dataSourceName:n},o.dataSource=e.getDataSource(o.dataSourceName),o},f=function(e){return function(t){var r=i.map(t,function(t){return new e.entityFactory(t)}),n=new u(e,r);return o.resolve(n)}},d=function(e){return function(t){if(i.isNil(t))return o.resolve();var r=new e.entityFactory(t);return o.resolve(r)}},p=function(e,t){return function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments[2],o=l(t,r,n,i);return o.dataSource[e](t.name,o.queryFind,o.options)}},h=function(e,t,r,n,o,a){var s,u=l(e,r,n,o),c=i([e.name,u.queryFind]).push(a).push(u.options).compact().value();return(s=u.dataSource)[(a?"update":"find")+(t?"Many":"One")].apply(s,_toConsumableArray(c)).then((t?f:d)(e))},y=function(e,t){if(!0===e)return{};if(i.isObject(e))return e;throw new TypeError('Datasource "'+t+'" value is invalid: expect `true` or a remap hash, but have '+JSON.stringify(e))},v=function(){function e(t,r){_classCallCheck(this,e);var n=i.intersection(c,i.keys(r.attributes));if(0!==n.length)throw new Error(JSON.stringify(n)+" is/are reserved property names. To match those column names in data source, please use the data source mapper property");if(!r.hasOwnProperty("sources")||!i.isArrayLike(r.sources)&&!i.isObject(r.sources))throw new TypeError("Expect model sources to be either an array or an object, had "+JSON.stringify(r.sources)+".");var o=i.isArrayLike(r.sources)?i.zipObject(r.sources,i.times(r.sources.length,i.constant({}))):i.mapValues(r.sources,y),u=[i.keys(o),s.dataSources],l=u[0],f=u[1],d=i.pick(f,l),p=i.difference(l,i.keys(d));if(0!==p.length)throw new Error("Missing data sources "+p.map(function(e){return'"'+e+'"'}).join(", "));i.forEach(o,function(e,r){d[r].configureCollection(t,e)}),i.assign(this,{dataSources:d,defaultDataSource:l[0],name:t,entityFactory:a(t,r,this)})}return _createClass(e,[{key:"getDataSource",value:function(e){if(i.isNil(e))e=this.defaultDataSource;else if(!this.dataSources.hasOwnProperty(e))throw new Error('Unknown data source "'+e+'" in model "'+this.name+'", available are '+i.keys(this.dataSources).map(function(e){return'"'+e+'"'}).join(", "));return this.dataSources[e]}},{key:"spawn",value:function(e){return new this.entityFactory(e)}},{key:"spawnMany",value:function(e){var t=this;return new u(this,i.map(e,function(e){return t.spawn(e)}))}},{key:"insert",value:function(e,t){var r=this;return this.getDataSource(t).insertOne(this.name,e).then(function(e){return o.resolve(new r.entityFactory(e))})}},{key:"insertMany",value:function(e,t){return this.getDataSource(t).insertMany(this.name,e).then(f(this))}},{key:"find",value:function(e,t,r){return h(this,!1,e,t,r)}},{key:"findMany",value:function(e,t,r){return h(this,!0,e,t,r)}},{key:"update",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3];return h(this,!1,e,r,n,t)}},{key:"updateMany",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments[3];return h(this,!0,e,r,n,t)}},{key:"delete",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];return p("deleteOne",this)(e,t,r)}},{key:"deleteMany",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];return p("deleteMany",this)(e,t,r)}}]),e}();t.exports=v},{"./dependencies":9,"./diaspora":10,"./entityFactory":11,"./set":17}],17:[function(e,t,r){"use strict";function n(e,t,r){var n=this,i=o.partial(l,this.entities,r);return i("before").then(function(){return a.all(n.entities.map(function(r){return r[t](e,{skipEvents:!0})}))}).then(function(){return i("after")})}var i=e("./dependencies"),o=i._,a=i.Promise,s=e("./utils"),u=e("./errors/setValidationError"),c=function(e,t){return o.isArray(e)?e[t]:e},l=function(e,t,r){return a.all(e.map(function(e,n){return e.emit(""+r+c(t,n))}))},f={get:function(e,t){return t in e?e[t]:t in e.entities?e.entities[t]:"string"==typeof t&&t.match(/^-?\d+$/)&&e.entities.nth(parseInt(t))?e.entities.nth(parseInt(t)):void 0},set:function(e,t,r){if("model"===t)return new Error('Can\'t assign to read-only property "model".');"entities"===t&&(d.checkEntitiesFromModel(r,e.model),e.entities=o(r))}},d=function(){function e(t){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];_classCallCheck(this,e),n=o(n).flatten(),e.checkEntitiesFromModel(n.value(),t);var a=s.defineEnumerableProperties(this,{entities:n,model:t,length:{get:function(){return this.entities.size()}}});return new Proxy(a,f)}return _createClass(e,[{key:"persist",value:function(e){var t=this,r=this.entities.map(function(e){return"orphan"===e.state?"Create":"Update"}).value(),i=o.partial(l,this.entities);return i("Persist","before").then(function(){return i("Validate","before")}).then(function(){var e=0,r=t.entities.map(function(t){try{return void t.validate()}catch(t){return e++,t}}).value();return e>0?a.reject(new u("Set validation failed for "+e+" elements (on "+t.length+"): ",r)):a.resolve()}).then(function(){return i("Validate","after")}).then(function(){return n.call(t,e,"persist",o.map(r,function(e){return"Persist"+e}))}).then(function(){return i("Persist","after")}).then(function(){return t})}},{key:"fetch",value:function(e){var t=this;return n.call(this,e,"fetch","Fetch").then(function(){return t})}},{key:"destroy",value:function(e){var t=this;return n.call(this,e,"destroy","Destroy").then(function(){return t})}},{key:"update",value:function(e){return this.entities.forEach(function(t){s.applyUpdateEntity(e,t)}),this}},{key:"toObject",value:function(){return this.entities.map(function(e){return e.toObject()})}}],[{key:"checkEntitiesFromModel",value:function(e,t){e.forEach(function(e,r){if(e.constructor.model!==t)throw new TypeError("Provided entity n°"+r+" "+e+" is not from model "+t+" ("+t.modelName+")")})}}]),e}();t.exports=d},{"./dependencies":9,"./errors/setValidationError":15,"./utils":18}],18:[function(e,t,r){(function(r){"use strict";var n=e("./dependencies")._;t.exports={defineEnumerableProperties:function(e,t){var r=n.mapValues(t,function(e){(n.isNil(e)||"object"!==(void 0===e?"undefined":_typeof(e))||Object.getPrototypeOf(e)!==Object.prototype)&&(e={value:e});var t={enumerable:!0};return e.hasOwnProperty("get")||(t.writable=!1),n.defaults(e,t),e});return Object.defineProperties(e,r)},applyUpdateEntity:function(e,t){return n.forEach(e,function(e,r){n.isUndefined(e)?delete t[r]:t[r]=e}),t},generateUUID:function(){var e=(new Date).getTime();return r.performance&&"function"==typeof r.performance.now&&(e+=r.performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?r:3&r|8).toString(16)})},applyOptionsToSet:function(e,t){return n.defaults(t,{limit:1/0,skip:0}),(e=e.slice(t.skip)).length>t.limit&&(e=e.slice(0,t.limit)),e}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./dependencies":9}],19:[function(e,t,r){function n(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(f===setTimeout)return setTimeout(e,0);if((f===n||!f)&&setTimeout)return f=setTimeout,setTimeout(e,0);try{return f(e,0)}catch(t){try{return f.call(null,e,0)}catch(t){return f.call(this,e,0)}}}function a(e){if(d===clearTimeout)return clearTimeout(e);if((d===i||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function s(){v&&h&&(v=!1,h.length?y=h.concat(y):m=-1,y.length&&u())}function u(){if(!v){var e=o(s);v=!0;for(var t=y.length;t;){for(h=y,y=[];++m<t;)h&&h[m].run();m=-1,t=y.length}h=null,v=!1,a(e)}}function c(e,t){this.fun=e,this.array=t}function l(){}var f,d,p=t.exports={};!function(){try{f="function"==typeof setTimeout?setTimeout:n}catch(e){f=n}try{d="function"==typeof clearTimeout?clearTimeout:i}catch(e){d=i}}();var h,y=[],v=!1,m=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];y.push(new c(e,t)),1!==y.length||v||o(u)},c.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=l,p.addListener=l,p.once=l,p.off=l,p.removeListener=l,p.removeAllListeners=l,p.emit=l,p.prependListener=l,p.prependOnceListener=l,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=diaspora.min.js.map