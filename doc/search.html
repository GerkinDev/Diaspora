---
layout: default
title: Search results
search:
    exclude: 'yes'
---
<div id="searchResults">
</div>
<script>
	var data = [];
	{% for post in site.posts %}
	{% unless post.search.exclude == "yes" or post.published == false %}
	data.push(        {
		"title"    : "{{ post.title }}",
		"url"     : "{{ post.url | remove_first: "/" | relative_path_to_url }}",
		"date"     : "{{ post.date | date: "%B %d, %Y" }}",
		"html"  : {{ page.content | escape | jsonify }},
			  "content"  : {{ post.content | strip_html | escape | jsonify }}
			  })
	 {% endunless %}
	 {% endfor %}

	 {% for page in site.pages %}
	 {% unless page.search.exclude == "yes" or page.url contains '/assets/' %}
	 data.push(        {
		 "title"    : "{{ page.title | escape  }}",
		 "url"     : "{{ page.url | remove_first: "/" | relative_path_to_url }}",
		 "date"     : "{{ page.date | date: "%B %d, %Y" }}",
		 "html"  : {{ page.content | escape | jsonify }},
			   "content"  : {{ page.content | strip_html | escape | jsonify }}
			   });
	  {% endunless %}
	  {% endfor %}
	  data = data.map(function(pageInfos){
		  pageInfos.normalizedTitle = pageInfos.title.replace( /\s\s+/g, ' ' ).toLowerCase();
		  pageInfos.trimedContent = pageInfos.content.replace( /\s\s+/g, ' ' );
		  pageInfos.normalizedContent = pageInfos.trimedContent.toLowerCase();
		  return pageInfos;
	  });
	   /**
	  * @see https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
	  */
	   function getParameterByName(name, url) {
		   if (!url) url = window.location.href;
		   name = name.replace(/[\[\]]/g, "\\$&");
		   var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
			   results = regex.exec(url);
		   if (!results) return null;
		   if (!results[2]) return '';
		   return decodeURIComponent(results[2].replace(/\+/g, " "));
	   }
	   var search = getParameterByName('q', window.location.search).replace( /\s\s+/g, ' ' );
	   $('#search-input').val(search);
	   var quoted = (search.match(/".*?"/g) || []);
	   quoted.forEach(function(quote){
		   search = search.replace(quoted, '');
	   });
	   var searches = quoted.map(function(quote){
		   return quote.slice(1).slice(0,-1);
	   }).concat(search.split(/\s/)).filter(function(item){
		   return !!item;
	   }).map(function(search){
		   return search.toLowerCase();
	   });
	   var scores = data.map(function(page){
		   var score = 0;
		   searches.map(function(search){
			   var urlRegex = new RegExp(search.replace(/\s/g, '-'), 'gi');
			   score += (page.normalizedTitle.split(search).length - 1) * 5;
			   score += ((page.url.match(urlRegex) || []).length) * 4;
			   score += Math.min(page.normalizedContent.split(search).length - 1, 10) * 1;
		   });
		   return {
			   page: page,
			   score: score
		   };
	   });
	   scores = scores.filter(function(pageScore){
		   return pageScore.score > 0;
	   }).sort(function(a, b){
		   return b.score - a.score;
	   });
	   var $resultArea = $('#searchResults');

	   function encodeHtml(text){
		   return $('<textarea />').text(text).html();
	   }
	   function decodeHtml(text){
		   return $('<textarea />').html(text).text();
	   }
	   scores.forEach(function(score){
		   var fullHtml = $($.parseHTML(decodeHtml(score.page.html)));
		   console.log(fullHtml);
		   var htmlcontent = fullHtml.find('#main > section > article');
		   console.log(htmlcontent);
		   if(htmlcontent.length === 0){
			   htmlcontent = fullHtml.filter(function(index, item){
				   console.log(item);
				   return !item.tagName || !item.tagName.match(/^h\d/i);
			   });
		   }
		   $resultArea.append($.parseHTML('<div><h4>'+score.page.title + '</h4><div>' + encodeHtml(htmlcontent.text().replace( /\s\s+/g, ' ' ).slice(0, 500)) + '&hellip;</div><a class="btn" href="' + score.page.url + '">Go to this page</a></div><hr/>'));
	   });
</script>