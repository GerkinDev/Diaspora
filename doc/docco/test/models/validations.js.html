---
layout: doccopage
title: "validations.js"
toc: false
---
<div id="container"><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>validations.js</h1><div class="filepath">test/models/validations.js</div></th><th class="code"></th></tr></thead><tbody><tr class="section" id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span></span><span id="line-1"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span id="line-2">
</span><span id="line-3">
</span><span id="line-4"></pre></div></td></tr><tr class="section" id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><div class="dox"><div class="summary"><p>globals it: false, require: false, expect: false, Diaspora: false</p></div><div class="body"></div></div></td><td class="code"><div class="highlight"><pre></span><span id="line-5">
</span><span id="line-6"><span class="kd">let</span> <span class="nx">testModel</span><span class="p">;</span>
</span><span id="line-7"><span class="kr">const</span> <span class="nx">MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;validatedModel&#39;</span><span class="p">;</span>
</span><span id="line-8"><span class="kr">const</span> <span class="nx">SOURCE</span> <span class="o">=</span> <span class="s1">&#39;inMemory&#39;</span><span class="p">;</span>
</span><span id="line-9"><span class="kr">const</span> <span class="p">{</span>
</span><span id="line-10">    <span class="nx">EntityValidationError</span><span class="p">,</span> <span class="nx">SetValidationError</span><span class="p">,</span>
</span><span id="line-11"><span class="p">}</span> <span class="o">=</span> <span class="nx">Diaspora</span><span class="p">.</span><span class="nx">components</span><span class="p">.</span><span class="nx">Errors</span><span class="p">;</span>
</span><span id="line-12">
</span><span id="line-13">
</span><span id="line-14"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should create a model&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-15">    <span class="nx">testModel</span> <span class="o">=</span> <span class="nx">Diaspora</span><span class="p">.</span><span class="nx">declareModel</span><span class="p">(</span> <span class="nx">MODEL_NAME</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-16">        <span class="nx">sources</span><span class="o">:</span>    <span class="p">[</span> <span class="nx">SOURCE</span> <span class="p">],</span>
</span><span id="line-17">        <span class="nx">schema</span><span class="o">:</span>     <span class="kc">false</span><span class="p">,</span>
</span><span id="line-18">        <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-19">            <span class="nx">prop1</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-20">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span id="line-21">            <span class="p">},</span>
</span><span id="line-22">            <span class="nx">prop2</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-23">                <span class="nx">type</span><span class="o">:</span>     <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
</span><span id="line-24">                <span class="kr">enum</span><span class="o">:</span>     <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span> <span class="p">],</span>
</span><span id="line-25">                <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span id="line-26">            <span class="p">},</span>
</span><span id="line-27">            <span class="nx">prop3</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-28">                <span class="nx">type</span><span class="o">:</span>    <span class="s1">&#39;float&#39;</span><span class="p">,</span>
</span><span id="line-29">                <span class="k">default</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="line-30">            <span class="p">},</span>
</span><span id="line-31">        <span class="p">},</span>
</span><span id="line-32">    <span class="p">});</span>
</span><span id="line-33">    <span class="nx">expect</span><span class="p">(</span> <span class="nx">testModel</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span> <span class="s1">&#39;object&#39;</span> <span class="p">);</span>
</span><span id="line-34">    <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="p">)</span> <span class="p">{</span>
</span><span id="line-35">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span> <span class="s1">&#39;Model&#39;</span> <span class="p">);</span>
</span><span id="line-36">    <span class="p">}</span>
</span><span id="line-37"><span class="p">});</span>
</span><span id="line-38"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should reject persistance of badly configured entities (spawn).&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-39">    <span class="kr">const</span> <span class="nx">fail1</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span>
</span><span id="line-40">        <span class="nx">prop1</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="line-41">        <span class="nx">prop2</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="line-42">    <span class="p">}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-43">    <span class="kr">const</span> <span class="nx">fail2</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span>
</span><span id="line-44">        <span class="nx">prop2</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="line-45">    <span class="p">}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-46">    <span class="kr">const</span> <span class="nx">fail3</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span>
</span><span id="line-47">        <span class="nx">prop2</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
</span><span id="line-48">    <span class="p">}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-49">    <span class="kr">const</span> <span class="nx">fail4</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-50">    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span><span id="line-51">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail1</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop1\W(.|\s)*\Wstring(\W|$)/m</span> <span class="p">),</span>
</span><span id="line-52">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail2</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop2\W(.|\s)*\Wenumerat(ed|ion)(\W|$)/m</span> <span class="p">),</span>
</span><span id="line-53">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail3</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop2\W(.|\s)*\Winteger(\W|$)/m</span> <span class="p">),</span>
</span><span id="line-54">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail4</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop2\W(?=(.|\s)*\Winteger(\W|$))(?=(.|\s)*\Wrequired(\W|$))/m</span> <span class="p">),</span>
</span><span id="line-55">    <span class="p">]);</span>
</span><span id="line-56"><span class="p">});</span>
</span><span id="line-57"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should reject persistance of badly configured entities (spawnMany).&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-58">    <span class="kr">const</span> <span class="nx">fail1</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawnMany</span><span class="p">([</span>
</span><span id="line-59">        <span class="p">{</span>
</span><span id="line-60">            <span class="nx">prop1</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="line-61">            <span class="nx">prop2</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="line-62">        <span class="p">},</span> <span class="p">{</span>
</span><span id="line-63">            <span class="nx">prop2</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="line-64">        <span class="p">},</span>
</span><span id="line-65">    <span class="p">]).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-66">    <span class="kr">const</span> <span class="nx">fail2</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawnMany</span><span class="p">([</span>
</span><span id="line-67">        <span class="p">{</span>
</span><span id="line-68">            <span class="nx">prop2</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="line-69">        <span class="p">},</span> <span class="p">{</span>
</span><span id="line-70">            <span class="nx">prop2</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
</span><span id="line-71">        <span class="p">},</span>
</span><span id="line-72">    <span class="p">]).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-73">    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span><span id="line-74">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail1</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">SetValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">satisfy</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-75">            <span class="kr">const</span> <span class="nx">validationErrors</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
</span><span id="line-76">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="k">instanceof</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">);</span>
</span><span id="line-77">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">message</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop1\W(.|\s)*\Wstring(\W|$)/m</span> <span class="p">);</span>
</span><span id="line-78">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">undefined</span><span class="p">;</span>
</span><span id="line-79">            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-80">        <span class="p">}),</span>
</span><span id="line-81">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail2</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">SetValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">satisfy</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-82">            <span class="kr">const</span> <span class="nx">validationErrors</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
</span><span id="line-83">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="k">instanceof</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">);</span>
</span><span id="line-84">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</</pre></div></td></tr></tbody></table></div>