---
layout: doccopage
title: "validations.js"
toc: false
---
<div id="container"><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>validations.js</h1><div class="filepath">test/models/validations.js</div></th><th class="code"></th></tr></thead><tbody><tr class="section" id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span></span><span id="line-1"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span id="line-2">
</span><span id="line-3">
</span><span id="line-4"></pre></div></td></tr><tr class="section" id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><div class="dox"><div class="summary"><p>globals it: false, require: false, expect: false, Diaspora: false</p></div><div class="body"></div></div></td><td class="code"><div class="highlight"><pre></span><span id="line-5">
</span><span id="line-6"><span class="kd">let</span> <span class="nx">testModel</span><span class="p">;</span>
</span><span id="line-7"><span class="kr">const</span> <span class="nx">MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;validatedModel&#39;</span><span class="p">;</span>
</span><span id="line-8"><span class="kr">const</span> <span class="nx">SOURCE</span> <span class="o">=</span> <span class="s1">&#39;inMemory&#39;</span><span class="p">;</span>
</span><span id="line-9"><span class="kr">const</span> <span class="p">{</span>
</span><span id="line-10">    <span class="nx">EntityValidationError</span><span class="p">,</span> <span class="nx">SetValidationError</span><span class="p">,</span>
</span><span id="line-11"><span class="p">}</span> <span class="o">=</span> <span class="nx">Diaspora</span><span class="p">.</span><span class="nx">components</span><span class="p">.</span><span class="nx">Errors</span><span class="p">;</span>
</span><span id="line-12">
</span><span id="line-13">
</span><span id="line-14"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should create a model&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-15">    <span class="nx">testModel</span> <span class="o">=</span> <span class="nx">Diaspora</span><span class="p">.</span><span class="nx">declareModel</span><span class="p">(</span> <span class="nx">MODEL_NAME</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-16">        <span class="nx">sources</span><span class="o">:</span>    <span class="p">[</span> <span class="nx">SOURCE</span> <span class="p">],</span>
</span><span id="line-17">        <span class="nx">schema</span><span class="o">:</span>     <span class="kc">false</span><span class="p">,</span>
</span><span id="line-18">        <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-19">            <span class="nx">prop1</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-20">                <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span id="line-21">            <span class="p">},</span>
</span><span id="line-22">            <span class="nx">prop2</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-23">                <span class="nx">type</span><span class="o">:</span>     <span class="s1">&#39;integer&#39;</span><span class="p">,</span>
</span><span id="line-24">                <span class="kr">enum</span><span class="o">:</span>     <span class="p">[</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span> <span class="p">],</span>
</span><span id="line-25">                <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span id="line-26">            <span class="p">},</span>
</span><span id="line-27">            <span class="nx">prop3</span><span class="o">:</span> <span class="p">{</span>
</span><span id="line-28">                <span class="nx">type</span><span class="o">:</span>    <span class="s1">&#39;float&#39;</span><span class="p">,</span>
</span><span id="line-29">                <span class="k">default</span><span class="o">:</span> <span class="mf">0.1</span><span class="p">,</span>
</span><span id="line-30">            <span class="p">},</span>
</span><span id="line-31">        <span class="p">},</span>
</span><span id="line-32">    <span class="p">});</span>
</span><span id="line-33">    <span class="nx">expect</span><span class="p">(</span> <span class="nx">testModel</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span> <span class="s1">&#39;object&#39;</span> <span class="p">);</span>
</span><span id="line-34">    <span class="k">if</span> <span class="p">(</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nb">window</span> <span class="p">)</span> <span class="p">{</span>
</span><span id="line-35">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span> <span class="s1">&#39;Model&#39;</span> <span class="p">);</span>
</span><span id="line-36">    <span class="p">}</span>
</span><span id="line-37"><span class="p">});</span>
</span><span id="line-38"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should reject persistance of badly configured entities (spawn).&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-39">    <span class="kr">const</span> <span class="nx">fail1</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span>
</span><span id="line-40">        <span class="nx">prop1</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="line-41">        <span class="nx">prop2</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="line-42">    <span class="p">}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-43">    <span class="kr">const</span> <span class="nx">fail2</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span>
</span><span id="line-44">        <span class="nx">prop2</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="line-45">    <span class="p">}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-46">    <span class="kr">const</span> <span class="nx">fail3</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({</span>
</span><span id="line-47">        <span class="nx">prop2</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
</span><span id="line-48">    <span class="p">}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-49">    <span class="kr">const</span> <span class="nx">fail4</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({}).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-50">    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span><span id="line-51">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail1</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop1\W.*\Wstring(\W|$)/m</span> <span class="p">),</span>
</span><span id="line-52">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail2</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop2\W.*\Wenumerat(ed|ion)(\W|$)/m</span> <span class="p">),</span>
</span><span id="line-53">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail3</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop2\W.*\Winteger(\W|$)/m</span> <span class="p">),</span>
</span><span id="line-54">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail4</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop2\W(?=.*\Winteger(\W|$))(?=.*\Wrequired(\W|$))/m</span> <span class="p">),</span>
</span><span id="line-55">    <span class="p">]);</span>
</span><span id="line-56"><span class="p">});</span>
</span><span id="line-57"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should reject persistance of badly configured entities (spawnMulti).&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-58">    <span class="kr">const</span> <span class="nx">fail1</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawnMulti</span><span class="p">([</span>
</span><span id="line-59">        <span class="p">{</span>
</span><span id="line-60">            <span class="nx">prop1</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="line-61">            <span class="nx">prop2</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="line-62">        <span class="p">},</span> <span class="p">{</span>
</span><span id="line-63">            <span class="nx">prop2</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
</span><span id="line-64">        <span class="p">},</span>
</span><span id="line-65">    <span class="p">]).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-66">    <span class="kr">const</span> <span class="nx">fail2</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawnMulti</span><span class="p">([</span>
</span><span id="line-67">        <span class="p">{</span>
</span><span id="line-68">            <span class="nx">prop2</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="line-69">        <span class="p">},</span> <span class="p">{</span>
</span><span id="line-70">            <span class="nx">prop2</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
</span><span id="line-71">        <span class="p">},</span>
</span><span id="line-72">    <span class="p">]).</span><span class="nx">persist</span><span class="p">();</span>
</span><span id="line-73">    <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
</span><span id="line-74">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail1</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">SetValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">satisfy</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-75">            <span class="kr">const</span> <span class="nx">validationErrors</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
</span><span id="line-76">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="k">instanceof</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">);</span>
</span><span id="line-77">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">message</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span> <span class="sr">/(\W|^)prop1\W.*\Wstring(\W|$)/m</span> <span class="p">);</span>
</span><span id="line-78">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">1</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">undefined</span><span class="p">;</span>
</span><span id="line-79">            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-80">        <span class="p">}),</span>
</span><span id="line-81">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">fail2</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">rejectedWith</span><span class="p">(</span> <span class="nx">SetValidationError</span> <span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eventually</span><span class="p">.</span><span class="nx">satisfy</span><span class="p">(</span> <span class="nx">error</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-82">            <span class="kr">const</span> <span class="nx">validationErrors</span> <span class="o">=</span> <span class="nx">error</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
</span><span id="line-83">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="k">instanceof</span><span class="p">(</span> <span class="nx">EntityValidationError</span> <span class="p">);</span>
</span><span id="line-84">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">validationErrors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">messa</pre></div></td></tr><tr class="section" id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><div class="dox"><div class="summary"><p>it( 'Should be able to create multiple entities.', () =&gt; {<br />
    const objects = [<br />
        {<br />
            foo: 'bar',<br />
        },<br />
        undefined,<br />
    ];<br />
    const entities = testModel.spawnMulti( objects );<br />
    expect( entities ).to.be.a.set.of.entity( testModel, objects, true ).that.have.lengthOf( 2 );<br />
});<br />
describe( 'Should be able to use model methods to find, update, delete &amp; create', () =&gt; {<br />
    describe( '- Create instances', () =&gt; {<br />
        it( 'Create a single instance', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'insert' );<br />
            const object = {<br />
                foo: 'bar',<br />
            };<br />
            return testModel.insert( object ).then( newEntity =&gt; {<br />
                expect( newEntity ).to.be.an.entity( testModel, object, 'inMemory' );<br />
                return Promise.resolve();<br />
            });<br />
        });<br />
        it( 'Create multiple instances', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'insertMany' );<br />
            const objects = [<br />
                {<br />
                    foo: 'baz',<br />
                },<br />
                undefined,<br />
                {<br />
                    foo: undefined,<br />
                },<br />
                {<br />
                    foo: 'baz',<br />
                },<br />
            ];<br />
            return testModel.insertMany( objects ).then( newEntities =&gt; {<br />
                expect( newEntities ).to.be.a.set.of.entity( testModel, objects, 'inMemory' ).that.have.lengthOf( 4 );<br />
                return Promise.resolve();<br />
            });<br />
        });<br />
    });<br />
    describe( '- Find instances', () =&gt; {<br />
        function checkFind( query, many = true ) {<br />
            return testModel<a href="query">many ? 'findMany' : 'find'</a>.then( foundEntities =&gt; {<br />
                if ( many ) {<br />
                    expect( foundEntities ).to.be.a.set.of.entity( testModel, query, SOURCE );<br />
                } else if ( c.assigned( foundEntities )) {<br />
                    expect( foundEntities ).to.be.an.entity( testModel, query, SOURCE );<br />
                }<br />
                return Promise.resolve( foundEntities );<br />
            });<br />
        }<br />
        it( 'Find a single instance', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'find' );<br />
            return Promise.mapSeries([<br />
                {<br />
                    foo: undefined,<br />
                },<br />
                {<br />
                    foo: 'baz',<br />
                },<br />
                {<br />
                    foo: 'bar',<br />
                },<br />
            ], item =&gt; checkFind( item, false ));<br />
        });<br />
        it( 'Find multiple instances', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'findMany' );<br />
            return Promise.mapSeries([<br />
                {<br />
                    query: {<br />
                        foo: undefined,<br />
                    },<br />
                    length: 2,<br />
                },<br />
                {<br />
                    query: {<br />
                        foo: 'baz',<br />
                    },<br />
                    length: 2,<br />
                },<br />
                {<br />
                    query: {<br />
                        foo: 'bar',<br />
                    },<br />
                    length: 1,<br />
                },<br />
            ], item =&gt; checkFind( item.query, true ).then( foundEntities =&gt; {<br />
                expect( foundEntities ).to.have.lengthOf( item.length );<br />
            }));<br />
        });<br />
        it( 'Find all instances', () =&gt; {<br />
            return testModel.findMany({}).then( foundEntities =&gt; {<br />
                expect( foundEntities ).to.have.lengthOf( 5 );<br />
            });<br />
        });<br />
    });<br />
    describe( '- Update instances', () =&gt; {<br />
        function checkUpdate( query, update, many = true ) {<br />
            return testModel[many ? 'updateMany' : 'update']( query, update ).then( updatedEntities =&gt; {<br />
                if ( many ) {<br />
                    expect( updatedEntities ).to.be.a.set.of.entity( testModel, update, SOURCE );<br />
                } else if ( c.assigned( updatedEntities )) {<br />
                    expect( updatedEntities ).to.be.an.entity( testModel, update, SOURCE );<br />
                }<br />
                return Promise.resolve( updatedEntities );<br />
            });<br />
        }<br />
        it( 'Update a single instance', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'update' );<br />
            return Promise.resolve()<br />
                .then(() =&gt; checkUpdate({<br />
                foo: undefined,<br />
            }, {<br />
                foo: 'qux',<br />
            }, false ))<br />
                .then(() =&gt; checkUpdate({<br />
                foo: 'baz',<br />
            }, {<br />
                foo: 'qux',<br />
            }, false ))<br />
                .then(() =&gt; checkUpdate({<br />
                foo: 'bar',<br />
            }, {<br />
                foo: undefined,<br />
            }, false ));<br />
        });<br />
        it( 'Update multiple instances', () =&gt; {<br />
            //process.exit()<br />
            expect( testModel ).to.respondTo( 'updateMany' );<br />
            return Promise.resolve()<br />
                .then(() =&gt; checkUpdate({<br />
                foo: undefined,<br />
            }, {<br />
                foo: 'bar',<br />
            }, true ).then( foundEntities =&gt; {<br />
                expect( foundEntities ).to.have.lengthOf( 2 );<br />
                return Promise.resolve();<br />
            }))<br />
                .then(() =&gt; checkUpdate({<br />
                foo: 'baz',<br />
            }, {<br />
                foo: undefined,<br />
            }, true ).then( foundEntities =&gt; {<br />
                expect( foundEntities ).to.have.lengthOf( 1 );<br />
                return Promise.resolve();<br />
            }))<br />
                .then(() =&gt; checkUpdate({<br />
                foo: 'bat',<br />
            }, {<br />
                foo: 'twy',<br />
            }, true )<br />
                      .then( foundEntities =&gt; {<br />
                expect( foundEntities ).to.have.lengthOf( 0 );<br />
                return Promise.resolve();<br />
            }));<br />
        });<br />
    });<br />
    describe( '- Delete instances', () =&gt; {<br />
        function checkDestroy( query, many = true ) {<br />
            return testModel.findMany( query ).then( entities =&gt; {<br />
                return Promise.resolve( entities.length );<br />
            }).then( beforeCount =&gt; {<br />
                return testModel<a href="query">many ? 'deleteMany' : 'delete'</a>.then(() =&gt; Promise.resolve( beforeCount ));<br />
            }).then( beforeCount =&gt; {<br />
                return testModel.findMany( query ).then( entities =&gt; {<br />
                    return Promise.resolve({<br />
                        before: beforeCount,<br />
                        after:  entities.length,<br />
                    });<br />
                });<br />
            }).then( result =&gt; {<br />
                if ( many || 0 === result.before ) {<br />
                    expect( result.after ).to.be.equal( 0 );<br />
                } else {<br />
                    expect( result.after ).to.be.equal( result.before - 1 );<br />
                }<br />
            });<br />
        }<br />
        it( 'Delete a single instance', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'delete' );<br />
            return Promise.resolve()<br />
                .then(() =&gt; checkDestroy({<br />
                foo: undefined,<br />
            }, false ))<br />
                .then(() =&gt; checkDestroy({<br />
                foo: 'bar',<br />
            }, false ));<br />
        });<br />
        it( 'Delete multiple instances', () =&gt; {<br />
            expect( testModel ).to.respondTo( 'deleteMany' );<br />
            return Promise.resolve().then(() =&gt; checkDestroy({<br />
                foo: undefined,<br />
            }, true )).then(() =&gt; checkDestroy({<br />
                foo: 'baz',<br />
            }, true )).then(() =&gt; checkDestroy({<br />
                foo: 'qux',<br />
            }, true ));<br />
        });<br />
        it( 'Delete all instances', () =&gt; {<br />
            return testModel.deleteMany({});<br />
        });<br />
    });<br />
});<br />
describe( 'Should be able to persist, fetch &amp; delete an entity of the defined model.', () =&gt; {<br />
    it( 'Persist should change the entity', () =&gt; {<br />
        const object = {<br />
            foo: 'bar',<br />
        };<br />
        testedEntity = testModel.spawn( object );<br />
        expect( testedEntity ).to.be.an.entity( testModel, object, true );<br />
        const retPromise = testedEntity.persist();<br />
        expect( testedEntity.state).to.be.eql( 'syncing' );<br />
        expect( testedEntity ).to.be.an.entity( testModel, object, null );<br />
        return retPromise.then(() =&gt; {<br />
            expect( testedEntity ).to.be.an.entity( testModel, object, SOURCE );<br />
        });<br />
    });<br />
    it( 'Fetch should change the entity', () =&gt; {<br />
        const object = {<br />
            foo: 'bar',<br />
        };<br />
        return testModel.find( object ).then( entity =&gt; {<br />
            expect( entity ).to.respondTo( 'fetch' );<br />
            expect( entity ).to.be.an.entity( testModel, object, SOURCE );<br />
            entity.foo = 'baz';<br />
            expect( entity ).to.be.an.entity( testModel, {<br />
                foo: 'baz',<br />
            }, SOURCE );<br />
            const retPromise = entity.fetch();<br />
            expect( entity.state).to.be.eql( 'syncing' );<br />
            return retPromise.then(() =&gt; {<br />
                expect( testedEntity ).to.be.an.entity( testModel, object, SOURCE );<br />
            });<br />
        });<br />
    });<br />
    it( 'Destroy should change the entity', () =&gt; {<br />
        const object = {<br />
            foo: 'bar',<br />
        };<br />
        return testModel.find( object ).then( entity =&gt; {<br />
            expect( entity ).to.respondTo( 'destroy' );<br />
            expect( entity ).to.be.an.entity( testModel, object, SOURCE );<br />
            const retPromise = entity.destroy();<br />
            expect( entity.state).to.be.eql( 'syncing' );<br />
            return retPromise.then(() =&gt; {<br />
                expect( entity.lastDataSource).to.be.eql( SOURCE );<br />
                expect( entity.state).to.be.eql( 'orphan' );<br />
                expect( entity ).to.be.an.entity( testModel, {}, null );<br />
            });<br />
        });<br />
    });<br />
});</p></div><div class="body"></div></div></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr></tbody></table></div>