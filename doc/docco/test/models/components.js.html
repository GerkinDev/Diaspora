---
layout: doccopage
title: "components.js"
toc: false
---
<div id="container"><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>components.js</h1><div class="filepath">test/models/components.js</div></th><th class="code"></th></tr></thead><tbody><tr class="section" id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span></span><span id="line-1"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>
</span><span id="line-2">
</span><span id="line-3">
</span><span id="line-4"></pre></div></td></tr><tr class="section" id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><div class="dox"><div class="summary"><p>globals l: false, it: false, describe: false, require: false, expect: false, Diaspora: false</p></div><div class="body"></div></div></td><td class="code"><div class="highlight"><pre></span><span id="line-5">
</span><span id="line-6"><span class="kd">let</span> <span class="nx">testModel</span><span class="p">;</span>
</span><span id="line-7"><span class="kd">let</span> <span class="nx">testEntity</span><span class="p">;</span>
</span><span id="line-8"><span class="kd">let</span> <span class="nx">testSet</span><span class="p">;</span>
</span><span id="line-9"><span class="kr">const</span> <span class="nx">MODEL_NAME</span> <span class="o">=</span> <span class="s1">&#39;testModelComponents&#39;</span><span class="p">;</span>
</span><span id="line-10"><span class="kr">const</span> <span class="nx">SOURCE</span> <span class="o">=</span> <span class="s1">&#39;inMemory&#39;</span><span class="p">;</span>
</span><span id="line-11">
</span><span id="line-12">
</span><span id="line-13"><span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;Should create a model&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-14">    <span class="nx">testModel</span> <span class="o">=</span> <span class="nx">Diaspora</span><span class="p">.</span><span class="nx">declareModel</span><span class="p">(</span> <span class="nx">MODEL_NAME</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-15">        <span class="nx">sources</span><span class="o">:</span>    <span class="p">[</span> <span class="nx">SOURCE</span> <span class="p">],</span>
</span><span id="line-16">        <span class="nx">schema</span><span class="o">:</span>     <span class="kc">false</span><span class="p">,</span>
</span><span id="line-17">        <span class="nx">attributes</span><span class="o">:</span> <span class="p">{},</span>
</span><span id="line-18">    <span class="p">});</span>
</span><span id="line-19">    <span class="nx">expect</span><span class="p">(</span> <span class="nx">testModel</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span> <span class="s1">&#39;object&#39;</span> <span class="p">);</span>
</span><span id="line-20">    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">process</span><span class="p">.</span><span class="nx">browser</span> <span class="p">)</span> <span class="p">{</span>
</span><span id="line-21">        <span class="nx">expect</span><span class="p">(</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span> <span class="s1">&#39;Model&#39;</span> <span class="p">);</span>
</span><span id="line-22">    <span class="p">}</span>
</span><span id="line-23">    <span class="nx">testEntity</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawn</span><span class="p">({});</span>
</span><span id="line-24">    <span class="nx">testSet</span> <span class="o">=</span> <span class="nx">testModel</span><span class="p">.</span><span class="nx">spawnMulti</span><span class="p">([{},</span> <span class="p">{}]);</span>
</span><span id="line-25"><span class="p">});</span>
</span><span id="line-26"><span class="kr">const</span> <span class="nx">randomTimeout</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">time</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-27">
</span><span id="line-28"></pre></div></td></tr><tr class="section" id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>return Promise.resolve();</p></td><td class="code"><div class="highlight"><pre></span><span id="line-29">    <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span> <span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-30">        <span class="nx">setTimeout</span><span class="p">(</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">time</span> <span class="o">||</span> <span class="nx">l</span><span class="p">.</span><span class="nx">random</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span> <span class="p">));</span>
</span><span id="line-31">    <span class="p">});</span>
</span><span id="line-32"><span class="p">};</span>
</span><span id="line-33"><span class="kr">const</span> <span class="nx">events</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="line-34">    <span class="nx">create</span><span class="o">:</span> <span class="p">[</span>
</span><span id="line-35">        <span class="s1">&#39;beforePersist&#39;</span><span class="p">,</span>
</span><span id="line-36">        <span class="s1">&#39;beforeValidate&#39;</span><span class="p">,</span>
</span><span id="line-37">        <span class="s1">&#39;afterValidate&#39;</span><span class="p">,</span>
</span><span id="line-38">        <span class="s1">&#39;beforePersistCreate&#39;</span><span class="p">,</span>
</span><span id="line-39">        <span class="s1">&#39;afterPersistCreate&#39;</span><span class="p">,</span>
</span><span id="line-40">        <span class="s1">&#39;afterPersist&#39;</span><span class="p">,</span>
</span><span id="line-41">    <span class="p">],</span>
</span><span id="line-42">    <span class="nx">update</span><span class="o">:</span> <span class="p">[</span>
</span><span id="line-43">        <span class="s1">&#39;beforePersist&#39;</span><span class="p">,</span>
</span><span id="line-44">        <span class="s1">&#39;beforeValidate&#39;</span><span class="p">,</span>
</span><span id="line-45">        <span class="s1">&#39;afterValidate&#39;</span><span class="p">,</span>
</span><span id="line-46">        <span class="s1">&#39;beforePersistUpdate&#39;</span><span class="p">,</span>
</span><span id="line-47">        <span class="s1">&#39;afterPersistUpdate&#39;</span><span class="p">,</span>
</span><span id="line-48">        <span class="s1">&#39;afterPersist&#39;</span><span class="p">,</span>
</span><span id="line-49">    <span class="p">],</span>
</span><span id="line-50">    <span class="nx">find</span><span class="o">:</span> <span class="p">[</span>
</span><span id="line-51">        <span class="s1">&#39;beforeFetch&#39;</span><span class="p">,</span>
</span><span id="line-52">        <span class="s1">&#39;afterFetch&#39;</span><span class="p">,</span>
</span><span id="line-53">    <span class="p">],</span>
</span><span id="line-54">    <span class="k">delete</span><span class="o">:</span> <span class="p">[</span>
</span><span id="line-55">        <span class="s1">&#39;beforeDestroy&#39;</span><span class="p">,</span>
</span><span id="line-56">        <span class="s1">&#39;afterDestroy&#39;</span><span class="p">,</span>
</span><span id="line-57">    <span class="p">],</span>
</span><span id="line-58"><span class="p">};</span>
</span><span id="line-59"><span class="nx">describe</span><span class="p">(</span> <span class="s1">&#39;Test entity&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-60">    <span class="nx">describe</span><span class="p">(</span> <span class="s1">&#39;Check lifecycle events&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-61">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after persist (create)&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-62">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;create&#39;</span><span class="p">;</span>
</span><span id="line-63">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-64">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)));</span>
</span><span id="line-65">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-66">                <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-67">                    <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-68">                    <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-69">                <span class="p">});</span>
</span><span id="line-70">                <span class="nx">testEntity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-71">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-72">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-73">                    <span class="p">});</span>
</span><span id="line-74">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-75">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-76">                    <span class="p">});</span>
</span><span id="line-77">                    <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-78">                        <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-79">                    <span class="p">});</span>
</span><span id="line-80">                <span class="p">});</span>
</span><span id="line-81">            <span class="p">});</span>
</span><span id="line-82">            <span class="k">return</span> <span class="nx">testEntity</span><span class="p">.</span><span class="nx">persist</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-83">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-84">                    <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-85">                <span class="p">});</span>
</span><span id="line-86">            <span class="p">});</span>
</span><span id="line-87">        <span class="p">});</span>
</span><span id="line-88">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after persist (update)&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-89">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;update&#39;</span><span class="p">;</span>
</span><span id="line-90">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-91">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)));</span>
</span><span id="line-92">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-93">                <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-94">                    <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-95">                    <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-96">                <span class="p">});</span>
</span><span id="line-97">                <span class="nx">testEntity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-98">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-99">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-100">                    <span class="p">});</span>
</span><span id="line-101">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-102">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-103">                    <span class="p">});</span>
</span><span id="line-104">                    <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-105">                        <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-106">                    <span class="p">});</span>
</span><span id="line-107">                <span class="p">});</span>
</span><span id="line-108">            <span class="p">});</span>
</span><span id="line-109">            <span class="k">return</span> <span class="nx">testEntity</span><span class="p">.</span><span class="nx">persist</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-110">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-111">                    <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-112">                <span class="p">});</span>
</span><span id="line-113">            <span class="p">});</span>
</span><span id="line-114">        <span class="p">});</span>
</span><span id="line-115">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after fetch&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-116">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;find&#39;</span><span class="p">;</span>
</span><span id="line-117">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-118">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)));</span>
</span><span id="line-119">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-120">                <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-121">                    <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-122">                    <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-123">                <span class="p">});</span>
</span><span id="line-124">                <span class="nx">testEntity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-125">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-126">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-127">                    <span class="p">});</span>
</span><span id="line-128">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-129">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-130">                    <span class="p">});</span>
</span><span id="line-131">                    <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-132">                        <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-133">                    <span class="p">});</span>
</span><span id="line-134">                <span class="p">});</span>
</span><span id="line-135">            <span class="p">});</span>
</span><span id="line-136">            <span class="k">return</span> <span class="nx">testEntity</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-137">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-138">                    <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-139">                <span class="p">});</span>
</span><span id="line-140">            <span class="p">});</span>
</span><span id="line-141">        <span class="p">});</span>
</span><span id="line-142">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after destroy&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-143">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;delete&#39;</span><span class="p">;</span>
</span><span id="line-144">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-145">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">)));</span>
</span><span id="line-146">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-147">                <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-148">                    <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-149">                    <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-150">                <span class="p">});</span>
</span><span id="line-151">                <span class="nx">testEntity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-152">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-153">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-154">                    <span class="p">});</span>
</span><span id="line-155">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-156">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-157">                    <span class="p">});</span>
</span><span id="line-158">                    <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-159">                        <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-160">                    <span class="p">});</span>
</span><span id="line-161">                <span class="p">});</span>
</span><span id="line-162">            <span class="p">});</span>
</span><span id="line-163">            <span class="k">return</span> <span class="nx">testEntity</span><span class="p">.</span><span class="nx">destroy</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-164">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-165">                    <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-166">                <span class="p">});</span>
</span><span id="line-167">            <span class="p">});</span>
</span><span id="line-168">        <span class="p">});</span>
</span><span id="line-169">    <span class="p">});</span>
</span><span id="line-170"><span class="p">});</span>
</span><span id="line-171">
</span><span id="line-172"><span class="nx">describe</span><span class="p">(</span> <span class="s1">&#39;Test set&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-173">    <span class="nx">describe</span><span class="p">(</span> <span class="s1">&#39;Check lifecycle events&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-174">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after persist (create)&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-175">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;create&#39;</span><span class="p">;</span>
</span><span id="line-176">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-177">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">))));</span>
</span><span id="line-178">            <span class="nx">testSet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">entityIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-179">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-180">                    <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-181">                        <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-182">                        <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-183">                    <span class="p">});</span>
</span><span id="line-184">                    <span class="nx">entity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-185">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-186">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">entityIndex</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-187">                        <span class="p">});</span>
</span><span id="line-188">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-189">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">entityIndex</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-190">                        <span class="p">});</span>
</span><span id="line-191">                        <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">(</span> <span class="cm">/*index * 50*/</span> <span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-192">                            <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]][</span><span class="nx">entityIndex</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-193">                        <span class="p">});</span>
</span><span id="line-194">                    <span class="p">});</span>
</span><span id="line-195">                <span class="p">});</span>
</span><span id="line-196">            <span class="p">});</span>
</span><span id="line-197">            <span class="k">return</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">persist</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-198">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="nx">eventFlagEntity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-199">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventFlagEntity</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-200">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-201">                    <span class="p">});</span>
</span><span id="line-202">                <span class="p">});</span>
</span><span id="line-203">            <span class="p">});</span>
</span><span id="line-204">        <span class="p">});</span>
</span><span id="line-205">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after persist (update)&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-206">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;update&#39;</span><span class="p">;</span>
</span><span id="line-207">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-208">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">))));</span>
</span><span id="line-209">            <span class="nx">testSet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">index</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-210">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-211">                    <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-212">                        <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-213">                        <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-214">                    <span class="p">});</span>
</span><span id="line-215">                    <span class="nx">entity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-216">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-217">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">index</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-218">                        <span class="p">});</span>
</span><span id="line-219">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-220">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">index</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-221">                        <span class="p">});</span>
</span><span id="line-222">                        <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">(</span> <span class="nx">index</span> <span class="o">*</span> <span class="mi">50</span> <span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-223">                            <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-224">                        <span class="p">});</span>
</span><span id="line-225">                    <span class="p">});</span>
</span><span id="line-226">                <span class="p">});</span>
</span><span id="line-227">            <span class="p">});</span>
</span><span id="line-228">            <span class="k">return</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">persist</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-229">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="nx">eventFlagEntity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-230">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventFlagEntity</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-231">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-232">                    <span class="p">});</span>
</span><span id="line-233">                <span class="p">});</span>
</span><span id="line-234">            <span class="p">});</span>
</span><span id="line-235">        <span class="p">});</span>
</span><span id="line-236">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after fetch&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-237">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;find&#39;</span><span class="p">;</span>
</span><span id="line-238">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-239">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">))));</span>
</span><span id="line-240">            <span class="nx">testSet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">index</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-241">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-242">                    <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-243">                        <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-244">                        <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-245">                    <span class="p">});</span>
</span><span id="line-246">                    <span class="nx">entity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-247">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-248">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">index</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-249">                        <span class="p">});</span>
</span><span id="line-250">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-251">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">index</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-252">                        <span class="p">});</span>
</span><span id="line-253">                        <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">(</span> <span class="nx">index</span> <span class="o">*</span> <span class="mi">50</span> <span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-254">                            <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-255">                        <span class="p">});</span>
</span><span id="line-256">                    <span class="p">});</span>
</span><span id="line-257">                <span class="p">});</span>
</span><span id="line-258">            <span class="p">});</span>
</span><span id="line-259">            <span class="k">return</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-260">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="nx">eventFlagEntity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-261">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventFlagEntity</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-262">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-263">                    <span class="p">});</span>
</span><span id="line-264">                <span class="p">});</span>
</span><span id="line-265">            <span class="p">});</span>
</span><span id="line-266">        <span class="p">});</span>
</span><span id="line-267">        <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;before/after destroy&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-268">            <span class="kr">const</span> <span class="nx">eventCat</span> <span class="o">=</span> <span class="s1">&#39;delete&#39;</span><span class="p">;</span>
</span><span id="line-269">            <span class="kr">const</span> <span class="nx">eventCatList</span> <span class="o">=</span> <span class="nx">events</span><span class="p">[</span><span class="nx">eventCat</span><span class="p">];</span>
</span><span id="line-270">            <span class="kr">const</span> <span class="nx">eventsFlags</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span> <span class="kc">false</span> <span class="p">))));</span>
</span><span id="line-271">            <span class="nx">testSet</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span> <span class="nx">entity</span><span class="p">,</span> <span class="nx">index</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-272">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="nx">eventIndex</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-273">                    <span class="kr">const</span> <span class="nx">parts</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">partition</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-274">                        <span class="kr">const</span> <span class="nx">subEventIndex</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span> <span class="nx">eventCatList</span><span class="p">,</span> <span class="nx">subEventName</span> <span class="p">);</span>
</span><span id="line-275">                        <span class="k">return</span> <span class="nx">eventIndex</span> <span class="o">&lt;=</span> <span class="nx">subEventIndex</span><span class="p">;</span>
</span><span id="line-276">                    <span class="p">});</span>
</span><span id="line-277">                    <span class="nx">entity</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span> <span class="nx">eventName</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-278">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-279">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">index</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be false: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">false</span><span class="p">;</span>
</span><span id="line-280">                        <span class="p">});</span>
</span><span id="line-281">                        <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">subEventName</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-282">                            <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">subEventName</span><span class="p">][</span><span class="nx">index</span><span class="p">],</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">subEventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-283">                        <span class="p">});</span>
</span><span id="line-284">                        <span class="k">return</span> <span class="nx">randomTimeout</span><span class="p">(</span> <span class="nx">index</span> <span class="o">*</span> <span class="mi">50</span> <span class="p">).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-285">                            <span class="nx">eventsFlags</span><span class="p">[</span><span class="nx">eventCatList</span><span class="p">[</span><span class="nx">eventIndex</span><span class="p">]][</span><span class="nx">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span id="line-286">                        <span class="p">});</span>
</span><span id="line-287">                    <span class="p">});</span>
</span><span id="line-288">                <span class="p">});</span>
</span><span id="line-289">            <span class="p">});</span>
</span><span id="line-290">            <span class="k">return</span> <span class="nx">testSet</span><span class="p">.</span><span class="nx">destroy</span><span class="p">().</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-291">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventsFlags</span><span class="p">,</span> <span class="nx">eventFlagEntity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-292">                    <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">eventFlagEntity</span><span class="p">,</span> <span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="nx">eventName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-293">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">eventFlag</span><span class="p">,</span> <span class="sb">`Event </span><span class="si">${</span> <span class="nx">eventName</span> <span class="si">}</span><span class="sb"> should be true: </span><span class="si">${</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span> <span class="nx">eventsFlags</span> <span class="p">)</span> <span class="si">}</span><span class="sb">`</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="kc">true</span><span class="p">;</span>
</span><span id="line-294">                    <span class="p">});</span>
</span><span id="line-295">                <span class="p">});</span>
</span><span id="line-296">            <span class="p">});</span>
</span><span id="line-297">        <span class="p">});</span>
</span><span id="line-298">    <span class="p">});</span>
</span><span id="line-299"><span class="p">});</span>
</span>
</pre></div></td></tr></tbody></table></div>