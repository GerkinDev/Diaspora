---
layout: doccopage
title: "app1-matchmail-simple.js"
toc: false
---
<div id="container"><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>app1-matchmail-simple.js</h1><div class="filepath">test/testApps/adapters/app1-matchmail-simple.js</div></th><th class="code"></th></tr></thead><tbody><tr class="section" id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span></span><span id="line-1"><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">adapter</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">tableName</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-2">    <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;‚ùå Clear old data&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-3">        <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{}).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-4">            <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{});</span>
</span><span id="line-5">        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">found</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-6">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">found</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span> <span class="p">).</span><span class="nx">that</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
</span><span id="line-7">            <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
</span><span id="line-8">        <span class="p">});</span>
</span><span id="line-9">    <span class="p">});</span>
</span><span id="line-10">    <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;‚ú® Insert test data&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">insertTestData</span><span class="p">()</span> <span class="p">{</span>
</span><span id="line-11">        <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span> <span class="mi">20000</span> <span class="p">);</span>
</span><span id="line-12">        <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">insertMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="nx">data</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">entities</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-13">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">entities</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span><span class="p">,</span> <span class="nx">data</span> <span class="p">).</span><span class="nx">that</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
</span><span id="line-14">            <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
</span><span id="line-15">        <span class="p">});</span>
</span><span id="line-16">    <span class="p">});</span>
</span><span id="line-17">    <span class="kd">let</span> <span class="nx">lastWithEmail</span><span class="p">;</span>
</span><span id="line-18">    <span class="nx">it</span><span class="p">(</span> <span class="sb">`üîé Find last entity with an email (option </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;skip&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb">)`</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-19">
</span><span id="line-20"></pre></div></td></tr><tr class="section" id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>process.exit();
</code></pre></td><td class="code"><div class="highlight"><pre></span><span id="line-21">        <span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span id="line-22">        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-23">            <span class="kr">const</span> <span class="nx">loop</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-24">                <span class="nx">expect</span><span class="p">(</span> <span class="nx">index</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">below</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s1">&#39;Oops, we looped over data length&#39;</span> <span class="p">);</span>
</span><span id="line-25">                <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
</span><span id="line-26">                    <span class="nx">skip</span><span class="o">:</span> <span class="nx">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="line-27">                <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">entity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-28">                    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">c</span><span class="p">.</span><span class="nx">assigned</span><span class="p">(</span> <span class="nx">entity</span> <span class="p">))</span> <span class="p">{</span>
</span><span id="line-29">                        <span class="k">return</span> <span class="nx">resolve</span><span class="p">();</span>
</span><span id="line-30">                    <span class="p">}</span>
</span><span id="line-31">                    <span class="k">if</span> <span class="p">(</span> <span class="nx">entity</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="s1">&#39;email&#39;</span> <span class="p">))</span> <span class="p">{</span>
</span><span id="line-32">                        <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span> <span class="nx">entity</span> <span class="p">);</span>
</span><span id="line-33">                    <span class="p">}</span>
</span><span id="line-34">                    <span class="nx">index</span><span class="o">++</span><span class="p">;</span>
</span><span id="line-35">                    <span class="k">return</span> <span class="nx">loop</span><span class="p">();</span>
</span><span id="line-36">                <span class="p">}).</span><span class="k">catch</span><span class="p">(</span> <span class="nx">reject</span> <span class="p">);</span>
</span><span id="line-37">            <span class="p">};</span>
</span><span id="line-38">            <span class="k">return</span> <span class="nx">loop</span><span class="p">();</span>
</span><span id="line-39">        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">lastCompleteItem</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-40">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">index</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;4th item has email&#39;</span> <span class="p">);</span>
</span><span id="line-41">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">lastCompleteItem</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span> <span class="p">);</span>
</span><span id="line-42">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">lastCompleteItem</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">include</span><span class="p">.</span><span class="nx">all</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="s1">&#39;ip_address&#39;</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="p">);</span>
</span><span id="line-43">            <span class="nx">lastWithEmail</span> <span class="o">=</span> <span class="nx">lastCompleteItem</span><span class="p">;</span>
</span><span id="line-44">        <span class="p">});</span>
</span><span id="line-45">    <span class="p">});</span>
</span><span id="line-46">    <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;‚ú® Insert a new record based on previous&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-47">        <span class="kr">const</span> <span class="nx">newItem</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span> <span class="nx">lastWithEmail</span><span class="p">,</span> <span class="p">[</span> <span class="s1">&#39;ip_address&#39;</span><span class="p">,</span> <span class="s1">&#39;email&#39;</span> <span class="p">]);</span>
</span><span id="line-48">        <span class="nx">newItem</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;/diaspora_app1&#39;</span><span class="p">;</span>
</span><span id="line-49">        <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">insertOne</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="nx">newItem</span> <span class="p">).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">entity</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-50">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">entity</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span><span class="p">,</span> <span class="nx">newItem</span> <span class="p">);</span>
</span><span id="line-51">            <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">();</span>
</span><span id="line-52">        <span class="p">});</span>
</span><span id="line-53">    <span class="p">});</span>
</span><span id="line-54">    <span class="kr">const</span> <span class="nx">ips</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;254.243.134.211&#39;</span><span class="p">,</span> <span class="s1">&#39;249.7.97.150&#39;</span><span class="p">,</span> <span class="s1">&#39;168.186.151.29&#39;</span> <span class="p">];</span>
</span><span id="line-55">    <span class="kd">let</span> <span class="nx">ipRecords</span> <span class="o">=</span> <span class="p">{};</span>
</span><span id="line-56">    <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;üîé Get items with some test IPs&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-57">        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">ips</span><span class="p">,</span> <span class="nx">ip</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-58">            <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-59">                <span class="nx">ip_address</span><span class="o">:</span> <span class="nx">ip</span><span class="p">,</span>
</span><span id="line-60">            <span class="p">});</span>
</span><span id="line-61">        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">results</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-62">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">results</span><span class="p">,</span> <span class="p">(</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">index</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-63">                <span class="nx">expect</span><span class="p">(</span> <span class="nx">set</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-64">                    <span class="nx">ip_address</span><span class="o">:</span> <span class="nx">ips</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span>
</span><span id="line-65">                <span class="p">});</span>
</span><span id="line-66">            <span class="p">});</span>
</span><span id="line-67">            <span class="nx">ipRecords</span> <span class="o">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">zipObject</span><span class="p">(</span> <span class="nx">ips</span><span class="p">,</span> <span class="nx">results</span> <span class="p">);</span>
</span><span id="line-68">        <span class="p">});</span>
</span><span id="line-69">    <span class="p">});</span>
</span><span id="line-70">    <span class="nx">it</span><span class="p">(</span> <span class="sb">`üîÉ Update those items with email (options </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;skip&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb"> &amp; </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;limit&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb">)`</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-71">        <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span> <span class="nx">l</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span> <span class="nx">ipRecords</span> <span class="p">),</span> <span class="nx">ip</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-72">            <span class="kr">const</span> <span class="nx">records</span> <span class="o">=</span> <span class="nx">ipRecords</span><span class="p">[</span><span class="nx">ip</span><span class="p">];</span>
</span><span id="line-73">            <span class="kr">const</span> <span class="nx">emails</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">records</span> <span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="s1">&#39;email&#39;</span> <span class="p">).</span><span class="nx">value</span><span class="p">();</span>
</span><span id="line-74">            <span class="kd">let</span> <span class="nx">lastSyncIdx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="line-75">            <span class="kd">let</span> <span class="nx">email</span> <span class="o">=</span> <span class="nx">l</span><span class="p">(</span> <span class="nx">emails</span> <span class="p">).</span><span class="nx">compact</span><span class="p">().</span><span class="nx">first</span><span class="p">();</span>
</span><span id="line-76">            <span class="kr">const</span> <span class="nx">promises</span> <span class="o">=</span> <span class="p">[];</span>
</span><span id="line-77">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">records</span><span class="p">.</span><span class="nx">concat</span><span class="p">([{</span>
</span><span id="line-78">                <span class="nx">email</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span id="line-79">            <span class="p">}]),</span> <span class="p">(</span> <span class="nx">record</span><span class="p">,</span> <span class="nx">idx</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-80">                <span class="k">if</span> <span class="p">(</span> <span class="nx">record</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span> <span class="s1">&#39;email&#39;</span> <span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">record</span><span class="p">.</span><span class="nx">email</span> <span class="o">!==</span> <span class="nx">email</span> <span class="p">)</span> <span class="p">{</span>
</span><span id="line-81">                    <span class="nx">promises</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-82">                        <span class="nx">ip_address</span><span class="o">:</span> <span class="nx">ip</span><span class="p">,</span>
</span><span id="line-83">                    <span class="p">},</span> <span class="p">{</span>
</span><span id="line-84">                        <span class="nx">email</span><span class="p">,</span>
</span><span id="line-85">                    <span class="p">},</span> <span class="p">{</span>
</span><span id="line-86">                        <span class="nx">skip</span><span class="o">:</span>  <span class="nx">lastSyncIdx</span><span class="p">,</span>
</span><span id="line-87">                        <span class="nx">limit</span><span class="o">:</span> <span class="nx">idx</span> <span class="o">-</span> <span class="nx">lastSyncIdx</span><span class="p">,</span>
</span><span id="line-88">                    <span class="p">}));</span>
</span><span id="line-89">                    <span class="nx">email</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">email</span><span class="p">;</span>
</span><span id="line-90">                    <span class="nx">lastSyncIdx</span> <span class="o">=</span> <span class="nx">idx</span><span class="p">;</span>
</span><span id="line-91">                <span class="p">}</span>
</span><span id="line-92">            <span class="p">});</span>
</span><span id="line-93">            <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span> <span class="nx">promises</span> <span class="p">);</span>
</span><span id="line-94">        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">results</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-95">            <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">results</span><span class="p">,</span> <span class="p">(</span> <span class="nx">updates</span><span class="p">,</span> <span class="nx">index</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-96">                <span class="nx">l</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span> <span class="nx">updates</span><span class="p">,</span> <span class="nx">update</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-97">                    <span class="k">if</span> <span class="p">(</span> <span class="nx">update</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span><span id="line-98">                        <span class="nx">expect</span><span class="p">(</span> <span class="nx">update</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-99">                            <span class="nx">ip_address</span><span class="o">:</span> <span class="nx">ips</span><span class="p">[</span><span class="nx">index</span><span class="p">],</span>
</span><span id="line-100">                            <span class="nx">email</span><span class="o">:</span>      <span class="nx">update</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">email</span><span class="p">,</span>
</span><span id="line-101">                        <span class="p">});</span>
</span><span id="line-102">                    <span class="p">}</span>
</span><span id="line-103">                <span class="p">});</span>
</span><span id="line-104">            <span class="p">});</span>
</span><span id="line-105">
</span><span id="line-106"></pre></div></td></tr><tr class="section" id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><div class="dox"><div class="summary"><p>const out = l.zipObject(ips, results);<br />
            console.log(out);</p></div><div class="body"></div></div></td><td class="code"><div class="highlight"><pre></span><span id="line-107">        <span class="p">});</span>
</span><span id="line-108">    <span class="p">});</span>
</span><span id="line-109">    <span class="kr">const</span> <span class="nx">pageSize</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
</span><span id="line-110">    <span class="kd">let</span> <span class="nx">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span id="line-111">    <span class="nx">it</span><span class="p">(</span> <span class="sb">`üîé Get items without email by page of </span><span class="si">${</span> <span class="nx">pageSize</span> <span class="si">}</span><span class="sb"> (options </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;page&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb"> &amp; </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;skip&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb">)`</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-112">        <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span> <span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span> <span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-113">            <span class="kr">const</span> <span class="nx">loop</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-114">                <span class="nx">expect</span><span class="p">(</span> <span class="nx">page</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">below</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="nx">pageSize</span> <span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Oops, we looped over data length&#39;</span> <span class="p">);</span>
</span><span id="line-115">                <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">props</span><span class="p">({</span>
</span><span id="line-116">                    <span class="nx">page</span><span class="o">:</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-117">                        <span class="nx">email</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span id="line-118">                    <span class="p">},</span> <span class="p">{</span>
</span><span id="line-119">                        <span class="nx">page</span><span class="p">,</span>
</span><span id="line-120">                        <span class="nx">limit</span><span class="o">:</span> <span class="nx">pageSize</span><span class="p">,</span>
</span><span id="line-121">                    <span class="p">}),</span>
</span><span id="line-122">                    <span class="nx">skip</span><span class="o">:</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-123">                        <span class="nx">email</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span id="line-124">                    <span class="p">},</span> <span class="p">{</span>
</span><span id="line-125">                        <span class="nx">skip</span><span class="o">:</span>  <span class="nx">page</span> <span class="o">*</span> <span class="nx">pageSize</span><span class="p">,</span>
</span><span id="line-126">                        <span class="nx">limit</span><span class="o">:</span> <span class="nx">pageSize</span><span class="p">,</span>
</span><span id="line-127">                    <span class="p">}),</span>
</span><span id="line-128">                <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">queryRes</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-129">                    <span class="nx">expect</span><span class="p">(</span> <span class="nx">queryRes</span><span class="p">.</span><span class="nx">page</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span> <span class="nx">queryRes</span><span class="p">.</span><span class="nx">skip</span><span class="p">,</span> <span class="s1">&#39;&quot;page&quot; &amp; &quot;skip&quot; should return same data&#39;</span> <span class="p">);</span>
</span><span id="line-130">                    <span class="kr">const</span> <span class="nx">entities</span> <span class="o">=</span> <span class="nx">queryRes</span><span class="p">.</span><span class="nx">page</span><span class="p">;</span>
</span><span id="line-131">                    <span class="nx">expect</span><span class="p">(</span> <span class="nx">entities</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span><span class="p">,</span> <span class="p">{</span>
</span><span id="line-132">                        <span class="nx">email</span><span class="o">:</span> <span class="kc">undefined</span><span class="p">,</span>
</span><span id="line-133">                    <span class="p">}).</span><span class="nx">that</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">.</span><span class="nx">below</span><span class="p">(</span> <span class="nx">pageSize</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="sb">`Sets should be at most </span><span class="si">${</span> <span class="nx">pageSize</span> <span class="si">}</span><span class="sb"> items length`</span> <span class="p">);</span>
</span><span id="line-134">                    <span class="k">if</span> <span class="p">(</span> <span class="mi">0</span> <span class="o">==</span> <span class="nx">entities</span><span class="p">.</span><span class="nx">length</span> <span class="p">)</span> <span class="p">{</span>
</span><span id="line-135">                        <span class="k">return</span> <span class="nx">resolve</span><span class="p">();</span>
</span><span id="line-136">                    <span class="p">}</span>
</span><span id="line-137">                    <span class="nx">page</span><span class="o">++</span><span class="p">;</span>
</span><span id="line-138">                    <span class="k">return</span> <span class="nx">loop</span><span class="p">();</span>
</span><span id="line-139">                <span class="p">}).</span><span class="k">catch</span><span class="p">(</span> <span class="nx">err</span> <span class="p">=&gt;</span> <span class="nx">reject</span><span class="p">(</span> <span class="nx">err</span> <span class="p">));</span>
</span><span id="line-140">            <span class="p">};</span>
</span><span id="line-141">            <span class="k">return</span> <span class="nx">loop</span><span class="p">();</span>
</span><span id="line-142">        <span class="p">});</span>
</span><span id="line-143">    <span class="p">});</span>
</span><span id="line-144">    <span class="kd">let</span> <span class="nx">allItems</span><span class="p">;</span>
</span><span id="line-145">    <span class="nx">it</span><span class="p">(</span> <span class="s1">&#39;üîé Find all items&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-146">        <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
</span><span id="line-147">            <span class="nx">limit</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span>
</span><span id="line-148">        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">items</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-149">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">items</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span> <span class="p">).</span><span class="nx">that</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
</span><span id="line-150">            <span class="nx">allItems</span> <span class="o">=</span> <span class="nx">items</span><span class="p">;</span>
</span><span id="line-151">        <span class="p">});</span>
</span><span id="line-152">    <span class="p">});</span>
</span><span id="line-153">    <span class="nx">it</span><span class="p">(</span> <span class="sb">`‚ùå Delete 2 pages (options </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;page&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb"> &amp; </span><span class="si">${</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">(</span> <span class="s1">&#39;limit&#39;</span> <span class="p">)</span> <span class="si">}</span><span class="sb">)`</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-154">        <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
</span><span id="line-155">            <span class="nx">page</span><span class="o">:</span>  <span class="mi">3</span><span class="p">,</span>
</span><span id="line-156">            <span class="nx">limit</span><span class="o">:</span> <span class="mi">20</span><span class="p">,</span>
</span><span id="line-157">        <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-158">            <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">deleteMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
</span><span id="line-159">                <span class="nx">page</span><span class="o">:</span>  <span class="mi">2</span><span class="p">,</span>
</span><span id="line-160">                <span class="nx">limit</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
</span><span id="line-161">            <span class="p">});</span>
</span><span id="line-162">        <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-163">            <span class="k">return</span> <span class="nx">adapter</span><span class="p">.</span><span class="nx">findMany</span><span class="p">(</span> <span class="nx">tableName</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span>
</span><span id="line-164">                <span class="nx">limit</span><span class="o">:</span> <span class="kc">Infinity</span><span class="p">,</span>
</span><span id="line-165">            <span class="p">});</span>
</span><span id="line-166">        <span class="p">}).</span><span class="nx">then</span><span class="p">(</span> <span class="nx">items</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span><span id="line-167">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">items</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">a</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="k">of</span><span class="p">.</span><span class="nx">dataStoreEntity</span><span class="p">(</span> <span class="nx">adapter</span> <span class="p">).</span><span class="nx">that</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">lengthOf</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span> <span class="mi">20</span> <span class="o">+</span> <span class="mi">5</span> <span class="p">));</span>
</span><span id="line-168">            <span class="kr">const</span> <span class="nx">idxRemoved</span> <span class="o">=</span> <span class="nx">l</span><span class="p">([]).</span><span class="nx">concat</span><span class="p">(</span>
</span><span id="line-169">                <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">Number</span> <span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span> <span class="o">+</span> <span class="mi">10</span> <span class="p">),</span>
</span><span id="line-170">                <span class="nx">l</span><span class="p">.</span><span class="nx">times</span><span class="p">(</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">Number</span> <span class="p">).</span><span class="nx">map</span><span class="p">(</span> <span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span> <span class="o">+</span> <span class="mi">60</span> <span class="p">)</span>
</span><span id="line-171">            <span class="p">).</span><span class="nx">value</span><span class="p">();</span>
</span><span id="line-172">            <span class="nx">l</span><span class="p">.</span><span class="nx">pullAt</span><span class="p">(</span>
</span><span id="line-173">                <span class="nx">allItems</span><span class="p">,</span>
</span><span id="line-174">                <span class="nx">idxRemoved</span>
</span><span id="line-175">            <span class="p">);</span>
</span><span id="line-176">            <span class="nx">expect</span><span class="p">(</span> <span class="nx">items</span> <span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span> <span class="nx">allItems</span> <span class="p">);</span>
</span><span id="line-177">        <span class="p">});</span>
</span><span id="line-178">    <span class="p">});</span>
</span><span id="line-179"><span class="p">};</span>
</span>
</pre></div></td></tr></tbody></table></div>