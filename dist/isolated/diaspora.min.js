/**
* @file diaspora
*
* Multi-Layer ORM for Javascript Client+Server
* Isolated build compiled on 2017-12-22 18:18:44
*
* @license GPL-3.0
* @version 0.2.0-rc.4
* @author Gerkin
*/
"use strict";function _extendableBuiltin(e){function t(){e.apply(this,arguments)}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise(function(n,i){function o(e,t){try{var r=u[e](t),o=r.value}catch(e){return void i(e)}r.done?n(o):Promise.resolve(o).then(s,a)}function s(e){o("next",e)}function a(e){o("throw",e)}var u=e.apply(t,r);s()})}}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}require("core-js/modules/es6.regexp.replace"),require("core-js/modules/es6.symbol"),require("core-js/modules/es6.regexp.split"),require("regenerator-runtime/runtime"),require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es6.function.name"),require("core-js/modules/es6.promise"),require("core-js/modules/es6.regexp.match"),require("core-js/modules/es6.string.ends-with"),require("core-js/modules/es6.array.find"),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Diaspora=e()}}(function(){return function e(t,r,n){function i(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[s]={exports:{}};t[s][0].call(l.exports,function(e){var r=t[s][1][e];return i(r||e)},l,l.exports,e,t,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){(function(r){if(!r.browser){var n=e("lodash"),i=n.find(e.cache,function(t,r){return r.endsWith(e("path").sep+"diaspora.js")});if(!n.isEmpty(n.get(i,"exports")))return console.log("Retrieving loaded diaspora"),t.exports=i.exports}var o=e("./lib/diaspora");t.exports=o}).call(this,e("_process"))},{"./lib/diaspora":12,_process:24,lodash:void 0,path:23}],2:[function(e,t,r){var n=e("../../dependencies")._,i=function(e,t,r){return"∞"===r?"-"===t?-1/0:1/0:parseInt(e)},o={type:{int:function(e,t){if(n.isString(t)&&(t=parseInt(t)),!n.isInteger(t)&&isFinite(t))throw new TypeError('Expect "'+e+'" to be an integer');return t}},rng:function(e,t,r){var n=r.match(/^([[\]])((-)?(\d+|∞)),((-)?(\d+|∞))([[\]])$/);if(n){var o=i.apply(void 0,n.splice(2,3)),s=i.apply(void 0,n.splice(2,3)),a="["===n[1]?t>=o:t>o,u="]"===n[2]?t<=s:t<s;if(!a||!u)throw new RangeError('Expect "'+e+'" to be within '+r+', have "'+t+'"')}return t}},s=function(e,t,r){return o.type[r.type]&&(t=o.type[r.type](e,t)),r.rng&&(t=o.rng(e,t,r.rng)),t};t.exports={OPERATORS:{$exists:function(e,t){return t===!n.isUndefined(e)},$equal:function(e,t){return!n.isUndefined(e)&&e===t},$diff:function(e,t){return!n.isUndefined(e)&&e!==t},$less:function(e,t){return!n.isUndefined(e)&&e<t},$lessEqual:function(e,t){return!n.isUndefined(e)&&e<=t},$greater:function(e,t){return!n.isUndefined(e)&&e>t},$greaterEqual:function(e,t){return!n.isUndefined(e)&&e>=t}},CANONICAL_OPERATORS:{"~":"$exists","==":"$equal","!=":"$diff","<":"$less","<=":"$lessEqual",">":"$greater",">=":"$greaterEqual"},QUERY_OPTIONS_TRANSFORMS:{limit:function(e){e.limit=s("limit",e.limit,{type:"int",rng:"[0,∞]"})},skip:function(e){e.skip=s("skip",e.skip,{type:"int",rng:"[0,∞["})},page:function(e){if(!e.hasOwnProperty("limit"))throw new ReferenceError('Usage of "options.page" requires "options.limit" to be defined.');if(!isFinite(e.limit))throw new RangeError('Usage of "options.page" requires "options.limit" to not be infinite');if(e.hasOwnProperty("skip"))throw new ReferenceError('Use either "options.page" or "options.skip"');e.skip=s("page",e.page,{type:"int",rng:"[0,∞["})*e.limit,delete e.page}},iterateLimit:function(e,t){var r=[],i=0,o=e.skip;return function s(a){return n.isNil(a)?Promise.resolve(r):(!0!==a&&r.push(a),i===e.limit?Promise.resolve(r):(e.skip=o+i,i++,t(e).then(s)))}},remapIO:function(e,t,r,i){if(n.isNil(r))return r;var o=!0===i?"input":"output",s=n.mapValues(r,function(r,i){var s=n.get(e,["filters",t,o,i],void 0);return n.isFunction(s)?s(r):r}),a=!0===i?"normal":"inverted";return n.mapKeys(s,function(r,i){return n.get(e,["remaps",t,a,i],i)})}}},{"../../dependencies":11}],3:[function(e,t,r){var n=e("../../dependencies"),i=n._,o=n.Promise,s=n.SequentialEvent,a=e("./adapter-utils"),u=a.OPERATORS,c=a.CANONICAL_OPERATORS,l=a.QUERY_OPTIONS_TRANSFORMS,f=a.iterateLimit,p=a.remapIO,d=function(e){function t(t){var r;return r=e.call(this)||this,r.state="preparing",r.remaps={},r.remapsInverted={},r.filters={},r.classEntity=t,r.error=void 0,r.on("ready",function(){r.state="ready"}).on("error",function(e){r.state="error",r.error=e}),r}_inheritsLoose(t,e);var r=t.prototype;return r.configureCollection=function(e,t,r){void 0===r&&(r={}),this.remaps[e]={normal:t,inverted:i.invert(t)},this.filters[e]=r},r.waitReady=function(){var e=this;return new o(function(t,r){return"ready"===e.state?t(e):"error"===e.state?r(e.error):void e.on("ready",function(){return t(e)}).on("error",function(e){return r(e)})})},r.maybeCastEntity=function(e){return i.isNil(e)?void 0:new this.classEntity(e,this)},r.maybeCastSet=function(e){return i.isNil(e)?[]:i.map(e,this.maybeCastEntity.bind(this))},r.remapInput=function(e,t){return p(this,e,t,!0)},r.remapOutput=function(e,t){return p(this,e,t,!1)},r.setIdHash=function(e,t){var r;return void 0===t&&(t="id"),e.idHash=i.assign({},e.idHash,(r={},r[this.name]=e[t],r)),e},r.matchEntity=function(e,t){return i.every(i.toPairs(e),function(e){var r=e[0],n=e[1];if(i.isObject(n)){var o=t[r];return i.every(n,function(e,t){return!!u.hasOwnProperty(t)&&u[t](o,e)})}return!1})},r.normalizeOptions=function(e){return void 0===e&&(e={}),e=i.cloneDeep(e),i.forEach(l,function(t,r){e.hasOwnProperty(r)&&l[r](e)}),i.defaults(e,{skip:0,remapInput:!0,remapOutput:!0}),e},r.normalizeQuery=function(e,t){i.isString(e)&&(e={id:e});return!0===t.remapInput?i(i.cloneDeep(e)).mapValues(function(e){return i.isUndefined(e)?{$exists:!1}:e instanceof Object?(e=i.mapKeys(e,function(e,t,r){if(c.hasOwnProperty(t)){if(r.hasOwnProperty(c[t]))throw new Error("Search can't have both \""+t+'" and "'+c[t]+'" keys, as they are synonyms');return c[t]}return t}),i.forEach(["$less","$lessEqual","$greater","$greaterEqual"],function(t){if(e.hasOwnProperty(t)&&!i.isNumber(e[t])&&!i.isDate(e[t]))throw new TypeError('Expect "'+t+'" in '+JSON.stringify(e)+" to be a numeric value")}),e):{$equal:e}}).value():i.cloneDeep(e)},r.toJSON=function(){return i.pick(this,["state","remaps","remapsInverted","classEntity","error"])},r.insertOne=function(e,t){return this.insertMany(e,[t]).then(function(e){return o.resolve(i.first(e))})},r.insertMany=function(e,t){var r=this;return o.mapSeries(t,function(t){return r.insertOne(e,t||{})})},r.findOne=function(e,t,r){return void 0===r&&(r={}),r.limit=1,this.findMany(e,t,r).then(function(e){return o.resolve(i.first(e))})},r.findMany=function(e,t,r){return void 0===r&&(r={}),r=this.normalizeOptions(r),f(r,this.findOne.bind(this,e,t))(!0)},r.updateOne=function(e,t,r,n){return void 0===n&&(n={}),n=this.normalizeOptions(n),n.limit=1,this.updateMany(e,t,r,n).then(function(e){return o.resolve(i.first(e))})},r.updateMany=function(e,t,r,n){return void 0===n&&(n={}),n=this.normalizeOptions(n),f(n,this.updateOne.bind(this,e,t,r))(!0)},r.deleteOne=function(e,t,r){return void 0===r&&(r={}),r.limit=1,this.deleteMany(e,t,r)},r.deleteMany=function(e,t,r){var n=this;void 0===r&&(r={});var s=0;return function a(){return n.findOne(e,t,r).then(function(u){return i.isNil(u)?o.resolve():s===r.limit?o.resolve():(s++,n.deleteOne(e,t,r).then(a))})}()},t}(s);t.exports=d},{"../../dependencies":11,"./adapter-utils":2}],4:[function(e,t,r){var n=e("../../dependencies")._,i=function(){function e(e,t){if(!n.isNil(e)){if(n.isNil(t))throw new TypeError('Expect 2nd argument to be the parent of this entity, have "'+t+'"');Object.defineProperties(this,{dataSource:{value:t,enumerable:!1,configurable:!1}}),n.assign(this,e)}}return e.prototype.toObject=function(){return n.omit(this,["dataSource","id"])},e}();t.exports=i},{"../../dependencies":11}],5:[function(e,t,r){var n=e("../../dependencies"),i=n._,o=n.Promise,s=e("../../utils"),a=e("../../diaspora").components.Adapters.Adapter,u=e("./entity.js"),c=function(e){function t(){var t;return t=e.call(this,u)||this,t.state="ready",t.store={},t}_inheritsLoose(t,e);var r=t.prototype;return r.configureCollection=function(t,r){e.prototype.configureCollection.call(this,t,r),this.ensureCollectionExists(t)},r.ensureCollectionExists=function(e){return this.store.hasOwnProperty(e)?this.store[e]:this.store[e]={items:[]}},r.insertOne=function(e,t){t=i.cloneDeep(t);var r=this.ensureCollectionExists(e);return t.id=s.generateUUID(),this.setIdHash(t),r.items.push(t),o.resolve(new this.classEntity(t,this))},r.findOne=function(e,t,r){void 0===r&&(r={});var n=this.ensureCollectionExists(e),a=i.filter(n.items,i.partial(this.matchEntity,t)),u=s.applyOptionsToSet(a,r);return o.resolve(this.maybeCastEntity(i.first(u)))},r.findMany=function(e,t,r){void 0===r&&(r={});var n=this.ensureCollectionExists(e),a=i.filter(n.items,i.partial(this.matchEntity,t)),u=s.applyOptionsToSet(a,r);return o.resolve(this.maybeCastSet(u))},r.updateOne=function(e,t,r,n){var a=this;return void 0===n&&(n={}),this.findOne(e,t,n).then(function(t){if(i.isNil(t))return o.resolve();var n=a.ensureCollectionExists(e),u=i.find(n.items,{id:t.id});return s.applyUpdateEntity(r,u),o.resolve(a.maybeCastEntity(u))})},r.updateMany=function(e,t,r,n){var a=this;return void 0===n&&(n={}),this.findMany(e,t,n).then(function(t){if(!i.isNil(t)&&t.length>0){var n=a.ensureCollectionExists(e),u=i.map(t,"id"),c=i.filter(n.items,function(e){return-1!==u.indexOf(e.id)});return o.resolve(a.maybeCastSet(i.map(c,function(e){return s.applyUpdateEntity(r,e),e})))}return o.resolve([])})},r.deleteOne=function(e,t,r){var n=this;void 0===r&&(r={});var s=this.ensureCollectionExists(e);return this.findOne(e,t,r).then(function(e){return i.isNil(e)||(s.items=i.reject(s.items,function(t){return t.id===e.idHash[n.name]})),o.resolve()})},r.deleteMany=function(e,t,r){var n=this;void 0===r&&(r={});var s=this.ensureCollectionExists(e);return this.findMany(e,t,r).then(function(e){var t=i.map(e,function(e){return i.get(e,"idHash."+n.name)});return s.items=i.reject(s.items,function(e){return i.includes(t,e.id)}),o.resolve()})},t}(a);t.exports=c},{"../../dependencies":11,"../../diaspora":12,"../../utils":21,"./entity.js":6}],6:[function(e,t,r){var n=function(e){function t(t,r){return e.call(this,t,r)||this}return _inheritsLoose(t,e),t}(e("../base/entity.js"));t.exports=n},{"../base/entity.js":4}],7:[function(e,t,r){(function(r){var n=e("../../dependencies"),i=n._,o=n.Promise,s=e("../../diaspora").components.Adapters.Adapter,a=e("./entity.js"),u=function(e){return i(e).chain(i.cloneDeep).omitBy(function(e){return i.isObject(e)&&i.isEmpty(e)}).mapValues(JSON.stringify).toPairs().map(i.partial(i.map,i,encodeURIComponent)).map(function(e){return e[0]+"="+e[1]}).join("&").value()},c={400:function(e){return new Error('Posted data through HTTP is invalid; message "'+e.response.message+'"')},_:function(e){return new Error("Unhandled HTTP error with status code "+e.status+' & message "'+e.response.message+'"')}},l=function(e,t,r){e.onload=function(){return i.inRange(e.status,200,299)?t(e.response):r(i.get(c,e.status,c._)(e))},e.onerror=function(){return r(c._(e))}},f=function(){var t=_asyncToGenerator(regeneratorRuntime.mark(function t(n,s,a,c){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(r.browser){t.next=7;break}return i.isNil(a)&&(a=!0),t.next=4,e("request-promise")[n.toLowerCase()](s,{json:a,qs:i.mapValues(c,JSON.stringify)});case 4:return t.abrupt("return",t.sent);case 7:return t.abrupt("return",new o(function(e,t){var r=new XMLHttpRequest;l(r,e,t);var o=u(c);r.responseType="json",r.open(n,s+(o?"?"+o:"")),r.setRequestHeader("Content-Type","application/json"),r.send(i.isNil(a)?void 0:JSON.stringify(a))}));case 8:case"end":return t.stop()}},t,this)}));return function(e,r,n,i){return t.apply(this,arguments)}}(),p=function(e,t){return 0===t.skip&&delete t.skip,i.assign({},i.omit(t,["remapInput","remapOutput"]),{where:e})},d=function(e,t){return i.isEmpty(e)||(e=i.map(e,i.unary(t.setIdHash.bind(t)))),e},h=function(e){if(!r.browser&&!i.isString(e.host))throw new Error('"config.host" is not defined, or is not a string: had "'+e.host+'"');if(!r.browser&&!i.isString(e.scheme))throw new Error('"config.scheme" is not defined, or is not a string: had "'+e.scheme+'"')},y=function(e){function t(t){var n;if(void 0===t&&(t={}),n=e.call(this,a)||this,i.defaults(t,{scheme:!1,host:!1,port:!1,path:"",pluralApis:{}}),h(t),r.browser&&!1===t.host)n.baseEndPoint=t.path;else{var o=t.port?":"+t.port:"",s=t.scheme?t.scheme+":":"";n.baseEndPoint=s+"//"+t.host+o+t.path}return n.state="ready",n.pluralApis=t.pluralApis,n}_inheritsLoose(t,e);var n=t.prototype;return n.httpQuery=function(e,t,r,n){return f(e,this.baseEndPoint+"/"+t.toLowerCase(),r,n)},n.getPluralEndpoint=function(e){return this.pluralApis.hasOwnProperty(e)?this.pluralApis[e]:e+"s"},n.insertOne=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpQuery("POST",t,r);case 2:return r=e.sent,i.isNil(r)||this.setIdHash(r),e.abrupt("return",this.maybeCastEntity(r));case 5:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}(),n.insertMany=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.httpQuery("POST",this.getPluralEndpoint(t),r);case 2:return r=e.sent,r=d(r,this),e.abrupt("return",this.maybeCastSet(r));case 5:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}(),n.findOne=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),e.next=3,this.httpQuery("GET",t,null,p(r,n));case 3:return o=e.sent,i.isNil(o)||this.setIdHash(o),e.abrupt("return",this.maybeCastEntity(o));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}(),n.findMany=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),e.next=3,this.httpQuery("GET",this.getPluralEndpoint(t),null,p(r,n));case 3:return i=e.sent,i=d(i,this),e.abrupt("return",this.maybeCastSet(i));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}(),n.updateOne=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,o){var s,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===o&&(o={}),e.next=3,this.httpQuery("PATCH",t,n,p(r,o));case 3:return s=e.sent,i.isNil(s)||(s.idHash=(a={},a[this.name]=s.id,a)),e.abrupt("return",this.maybeCastEntity(s));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n,i){return e.apply(this,arguments)}}(),n.updateMany=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n,i){var o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===i&&(i={}),e.next=3,this.httpQuery("PATCH",this.getPluralEndpoint(t),n,p(r,i));case 3:return o=e.sent,o=d(o,this),e.abrupt("return",this.maybeCastSet(o));case 6:case"end":return e.stop()}},e,this)}));return function(t,r,n,i){return e.apply(this,arguments)}}(),n.deleteOne=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),e.next=3,this.httpQuery("DELETE",t,null,p(r,n));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}(),n.deleteMany=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===n&&(n={}),e.next=3,this.httpQuery("DELETE",this.getPluralEndpoint(t),null,p(r,n));case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}},e,this)}));return function(t,r,n){return e.apply(this,arguments)}}(),t}(s);t.exports=y}).call(this,e("_process"))},{"../../dependencies":11,"../../diaspora":12,"./entity.js":8,_process:24,"request-promise":void 0}],8:[function(e,t,r){var n=function(e){function t(t,r){return e.call(this,t,r)||this}return _inheritsLoose(t,e),t}(e("../base/entity.js"));t.exports=n},{"../base/entity.js":4}],9:[function(e,t,r){(function(r){var n=e("../../dependencies"),i=n._,o=n.Promise,s=e("../../utils"),a=e("../../diaspora").components.Adapters.Adapter,u=e("./entity"),c=function(e){function t(t){var n;return n=e.call(this,u)||this,i.defaults(t,{session:!1}),n.state="ready",n.source=!0===t.session?r.sessionStorage:r.localStorage,n}_inheritsLoose(t,e);var n=t.prototype;return n.configureCollection=function(t,r){e.prototype.configureCollection.call(this,t,r),this.ensureCollectionExists(t)},n.ensureCollectionExists=function(e){var t=this.source.getItem(e);return i.isNil(t)?(t=[],this.source.setItem(e,JSON.stringify(t))):t=JSON.parse(t),t},n.getItemName=function(e,t){return e+".id="+t},n.insertOne=function(e,t){(t=i.cloneDeep(t||{})).id=s.generateUUID(),this.setIdHash(t);try{var r=this.ensureCollectionExists(e);r.push(t.id),this.source.setItem(e,JSON.stringify(r)),this.source.setItem(this.getItemName(e,t.id),JSON.stringify(t))}catch(e){return o.reject(e)}return o.resolve(this.maybeCastEntity(t))},n.insertMany=function(e,t){var r=this;t=i.cloneDeep(t);try{var n=this.ensureCollectionExists(e);t=t.map(function(t){return void 0===t&&(t={}),t.id=s.generateUUID(),r.setIdHash(t),n.push(t.id),r.source.setItem(r.getItemName(e,t.id),JSON.stringify(t)),new r.classEntity(t,r)}),this.source.setItem(e,JSON.stringify(n))}catch(e){return o.reject(e)}return o.resolve(this.maybeCastSet(t))},n.findOneById=function(e,t){var r=this.source.getItem(this.getItemName(e,t));return i.isNil(r)||(r=JSON.parse(r)),o.resolve(this.maybeCastEntity(r))},n.findOne=function(e,t,r){var n=this;if(void 0===r&&(r={}),i.defaults(r,{skip:0}),!i.isObject(t))return this.findOneById(e,t);if(i.isEqual(i.keys(t),["id"])&&i.isEqual(i.keys(t.id),["$equal"]))return this.findOneById(e,t.id.$equal);var s,a=this.ensureCollectionExists(e),u=0;return i.each(a,function(i){var o=JSON.parse(n.source.getItem(n.getItemName(e,i)));if(n.matchEntity(t,o)&&++u>r.skip)return s=o,!1}),o.resolve(this.maybeCastEntity(s))},n.updateOne=function(e,t,r,n){var a=this;return i.defaults(n,{skip:0}),this.findOne(e,t,n).then(function(t){if(i.isNil(t))return o.resolve();s.applyUpdateEntity(r,t);try{return a.source.setItem(a.getItemName(e,t.id),JSON.stringify(t)),o.resolve(t)}catch(e){return o.reject(e)}})},n.deleteOne=function(e,t,r){var n=this;return void 0===r&&(r={}),this.findOne(e,t,r).then(function(t){try{var r=n.ensureCollectionExists(e);i.pull(r,t.id),n.source.setItem(e,JSON.stringify(r)),n.source.removeItem(n.getItemName(e,t.id))}catch(e){return o.reject(e)}return o.resolve()})},n.deleteMany=function(e,t,r){var n=this;void 0===r&&(r={});try{return this.findMany(e,t,r).then(function(t){var r=n.ensureCollectionExists(e);return i.pullAll(r,i.map(t,"id")),n.source.setItem(e,JSON.stringify(r)),i.forEach(t,function(t){n.source.removeItem(n.getItemName(e,t.id))}),o.resolve()})}catch(e){return o.reject(e)}},t}(a);t.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../dependencies":11,"../../diaspora":12,"../../utils":21,"./entity":10}],10:[function(e,t,r){var n=function(e){function t(t,r){return e.call(this,t,r)||this}return _inheritsLoose(t,e),t}(e("../base/entity.js"));t.exports=n},{"../base/entity.js":4}],11:[function(e,t,r){(function(r){t.exports={_:r._||e("lodash"),SequentialEvent:r.SequentialEvent||e("sequential-event"),Promise:r.Promise&&r.Promise.version?r.Promise:e("bluebird")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{bluebird:void 0,lodash:void 0,"sequential-event":void 0}],12:[function(e,t,r){(function(r){var n=e("./dependencies"),i=n._,o=n.Promise,s=function(){if(r.browser)return console;var t=e("winston"),n=t.createLogger({level:"silly",format:t.format.json(),transports:[]});return"production"!==r.env.NODE_ENV&&n.add(new t.transports.Console({format:t.format.simple()})),n}(),a={},u={},c={},l=function(e,t,r){return function(n){var s=!1,a=!1;["find","delete"].indexOf(t.query)>=0?s=1:"update"===t.query&&(s=2,a=!0);for(var u=arguments.length,c=new Array(u>1?u-1:0),l=1;l<u;l++)c[l-1]=arguments[l];try{!1!==s&&(c[s]=r.normalizeOptions(c[s]),c[0]=r.normalizeQuery(c[0],c[s])),function(e,t,r,n,o){!1!==t?(!0===e[t].remapInput&&(e[0]=o(e[0]),!0===r&&(e[1]=o(e[1]))),e[t].remapInput=!1):"insert"===n.query&&("many"===n.number?e[0]=i.map(e[0],function(e){return o(e)}):e[0]=o(e[0]))}(c,s,a,t,function(e,t){return function(r){return e.remapInput(t,r)}}(r,n))}catch(e){return o.reject(e)}return e.call.apply(e,[r,n].concat(c)).then(function(e,t){var r=function(r){return(r=e.remapOutput(t,r))instanceof e.classEntity||i.isNil(r)?r:new e.classEntity(r,e)};return function(e){return i.isNil(e)?o.resolve():i.isArrayLike(e)?o.resolve(i.map(e,r)):o.resolve(r(e))}}(r,n))}},f={NON_EMPTY_STR:i.template('<%= c %> <%= p %> must be a non empty string, had "<%= v %>"')},p=function(e,t){if(!i.isString(t)&&t.length>0)throw new Error(f.NON_EMPTY_STR({c:e,p:"name",v:t}))},d={namedFunctions:{Diaspora:{"Date.now()":function(){return new Date}}},default:function(e,t){var r=this;return i.defaults(e,i.mapValues(t,function(t,n){return r.defaultField(e[n],t)}))},defaultField:function(e,t){var r;return r=i.isUndefined(e)?i.isFunction(t.default)?t.default():function(e){if(i.isString(e)&&e.match(/^(.+?)(?:::(.+?))+$/)){var t=e.split("::"),r=i.get(d.namedFunctions,t);if(i.isFunction(r))return r()}return e}(t.default):e,"object"===t.type&&i.isObject(t.attributes)&&i.keys(t.attributes).length>0&&!i.isNil(r)?this.default(r,t.attributes):r},createDataSource:function(t,r){if(!a.hasOwnProperty(t))try{e("diaspora-"+t)}catch(e){throw new Error('Unknown adapter "'+t+'". Available currently are '+Object.keys(a).join(", ")+". Additionnaly, an error was thrown: "+e)}var n=new a[t](r);return new Proxy(n,{get:function(e,t){if(i.isString(t)){var r=t.match(/^(find|update|insert|delete)(Many|One)$/);if(null!==r)return r[2]=r[2].toLowerCase(),r=i.mapKeys(r.slice(0,3),function(e,t){return["full","query","number"][t]}),l(e[t],r,e)}return e[t]}})},registerDataSource:function(e,t){var r;if(p("DataSource",e),u.hasOwnProperty(e))throw new Error('DataSource name already used, had "'+e+'"');return t.name=e,i.merge(u,(r={},r[e]=t,r)),t},createNamedDataSource:function(e,t,r){var n=d.createDataSource(t,r);return d.registerDataSource(e,n)},declareModel:function(e,t){var r;if(!i.isString(e)&&e.length>0&&p("Model",e),!i.isObject(t))throw new Error('"modelDesc" must be an object');var n=new d.components.Model(e,t);return i.assign(c,(r={},r[e]=n,r)),n},registerAdapter:function(e,t){if(a.hasOwnProperty(e))throw new Error('Adapter with label "'+e+'" already exists.');a[e]=t},models:c,dataSources:u,adapters:a,dependencies:n,logger:s};t.exports=d,d.components={Errors:{ExtendableError:e("./errors/extendableError"),ValidationError:e("./errors/validationError"),EntityValidationError:e("./errors/entityValidationError"),SetValidationError:e("./errors/setValidationError"),EntityStateError:e("./errors/entityStateError")}},i.assign(d.components,{Adapters:{Adapter:e("./adapters/base/adapter"),Entity:e("./adapters/base/entity")}}),i.assign(d.components,{Model:e("./model"),EntityFactory:e("./entityFactory"),Entity:e("./entityFactory").Entity,Set:e("./set"),Validator:e("./validator"),Utils:e("./utils")}),d.registerAdapter("inMemory",e("./adapters/inMemory/adapter")),d.registerAdapter("webApi",e("./adapters/webApi/adapter")),r.browser&&d.registerAdapter("webStorage",e("./adapters/webStorage/adapter"))}).call(this,e("_process"))},{"./adapters/base/adapter":3,"./adapters/base/entity":4,"./adapters/inMemory/adapter":5,"./adapters/webApi/adapter":7,"./adapters/webStorage/adapter":9,"./dependencies":11,"./entityFactory":13,"./errors/entityStateError":14,"./errors/entityValidationError":15,"./errors/extendableError":16,"./errors/setValidationError":17,"./errors/validationError":18,"./model":19,"./set":20,"./utils":21,"./validator":22,_process:24,winston:void 0}],13:[function(e,t,r){var n=e("./dependencies"),i=n._,o=n.Promise,s=n.SequentialEvent,a=e("./diaspora"),u=a.components.Adapters.Entity,c=e("./errors/entityStateError"),l={skipEvents:!1},f=Symbol("PRIVATE"),p=function e(t,r,n,s){return s=i.castArray(s),r.skipEvents?o.resolve(t):t.emit.apply(t,[s[0]].concat(n)).then(function(){return s.length>1?e(t,r,n,i.slice(s,1)):o.resolve(t)})},d=function(e,t,r,n){return function(){return"orphan"===t?o.reject(new c("Can't fetch an orphan entity.")):(e[f].lastDataSource=r.name,r[n](e.table(r.name),e.uidQuery(r)))}},h={castTypes:function(e,t){var r=t.attributes;return i.forEach(e,function(t,n){var o=r[n];if(i.isObject(o))switch(o.type){case"date":(i.isString(t)||i.isInteger(t))&&(e[n]=new Date(t))}}),e},loadSource:function(e,t){if(t instanceof u){var r=e[f];i.assign(r,{state:"sync",lastDataSource:t.dataSource.name}),r.dataSources[r.lastDataSource]=t,t=e.deserialize(i.omit(t.toObject(),["id"]))}return t},bindLifecycleEvents:function(e,t){i.forEach(t.lifecycleEvents,function(t,r){i.forEach(i.castArray(t),function(t){e.on(r,t)})})}},y=function(e){function t(t,r,n,o){var s;void 0===o&&(o={});var u=i.keys(r.attributes);s=e.call(this)||this;var c={state:"orphan",lastDataSource:null,dataSources:Object.seal(i.mapValues(n.dataSources,function(){})),name:t,modelDesc:r,model:n};s[f]=c,o=h.castTypes(o,r),o=h.loadSource(_assertThisInitialized(s),o);var l=i.difference(o,u);if(0!==l.length)throw new Error("Source has unknown keys: "+JSON.stringify(l)+" in "+JSON.stringify(o));return c.attributes=a.default(i.cloneDeep(o),r.attributes),o=null,h.bindLifecycleEvents(_assertThisInitialized(s),r),s}_inheritsLoose(t,e);var r=t.prototype;return r.uidQuery=function(e){return{id:this[f].attributes.idHash[e.name]}},r.table=function(){return this[f].name},r.validate=function(){this.constructor.model.validator.validate(this[f].attributes)},r.replaceAttributes=function(e){return void 0===e&&(e={}),e.idHash=this[f].attributes.idHash,this[f].attributes=e,this},r.getDiff=function(e){var t=this,r=this[f].dataSources[e.name].toObject(),n=i(this[f].attributes).keys().concat(i.keys(r)).uniq().difference(["idHash"]).value(),o=i.map(n,function(e){return t[f].attributes[e]});return i.omitBy(i.zipObject(n,o),function(e,n){return i.isEqual(t[f].attributes[n],r[n])})},r.toObject=function(){return this[f].attributes},r.serialize=function(e){return i.cloneDeep(e)},r.deserialize=function(e){return i.cloneDeep(e)},r.persist=function(e,t){var r=this;void 0===t&&(t={}),i.defaults(t,l);var n=this[f].state;this[f].state="syncing";var o=this.constructor.model.getDataSource(e),s=[o.name],a=i.partial(p,this,t,s),u="orphan"===n?"Create":"Update";return a(["beforePersist","beforeValidate"]).then(function(){return r.validate()}).then(function(){return a(["afterValidate","beforePersist"+u])}).then(function(){return r[f].lastDataSource=o.name,"orphan"===n?o.insertOne(r.table(e),r.toObject()):o.updateOne(r.table(e),r.uidQuery(o),r.getDiff(o))}).then(function(e){return h.castTypes(e,r[f].modelDesc),r[f].state="sync",r[f].attributes=e.toObject(),r[f].dataSources[o.name]=e,a(["afterPersist"+u,"afterPersist"])})},r.fetch=function(e,t){var r=this;void 0===t&&(t={}),i.defaults(t,l);var n=this[f].state;this[f].state="syncing";var o=this.constructor.model.getDataSource(e),s=[o.name,this.serialize(this[f].attributes)],a=i.partial(p,this,t,s);return a("beforeFetch").then(d(this,n,o,"findOne")).then(function(e){return h.castTypes(e,r[f].modelDesc),r[f].state="sync",r[f].attributes=e.toObject(),r[f].dataSources[o.name]=e,a("afterFetch")})},r.destroy=function(e,t){var r=this;void 0===t&&(t={}),i.defaults(t,l);var n=this[f].state;this[f].state="syncing";var o=this.constructor.model.getDataSource(e),s=[o.name],a=i.partial(p,this,t,s);return a("beforeDestroy").then(d(this,n,o,"deleteOne")).then(function(){return 0===i.without(r[f].model.dataSources,o.name).length?r[f].state="orphan":(r[f].state="sync",delete r[f].attributes.idHash[o.name]),r[f].dataSources[o.name]=void 0,a("afterDestroy")})},r.getId=function(e){var t=this.constructor.model.getDataSource(e);return this[f].dataSources[t.name].id},_createClass(t,[{key:"dataSources",get:function(){return this[f].dataSources}},{key:"attributes",get:function(){return this[f].attributes}},{key:"state",get:function(){return this[f].state}},{key:"lastDataSource",get:function(){return this[f].lastDataSource}}]),t}(s),m=function(e,t,r){var n=function(t){function n(){return t.apply(this,arguments)||this}return _inheritsLoose(n,t),_createClass(n,null,[{key:"name",get:function(){return e+"Entity"}},{key:"model",get:function(){return r}}]),n}(y);return i.forEach(t.methods,function(e,t){n.prototype[t]=e}),i.forEach(t.staticMethods,function(e,t){n[e]=t}),n.bind(n,e,t,r)};m.Entity=y,t.exports=m},{"./dependencies":11,"./diaspora":12,"./errors/entityStateError":14}],14:[function(e,t,r){var n=function(e){function t(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return e.call.apply(e,[this].concat(r))||this}return _inheritsLoose(t,e),t}(e("./extendableError"));t.exports=n},{"./extendableError":16}],15:[function(e,t,r){var n=e("../dependencies")._,i=function(e){return n(e).mapValues(function(e,t){return t+" => "+JSON.stringify(e.value)+"\n* "+n(e).omit(["value"]).values().map(n.identity).value()}).values().join("\n* ")},o=function(e){function t(t,r){var n;r+="\n"+i(t);for(var o=arguments.length,s=new Array(o>2?o-2:0),a=2;a<o;a++)s[a-2]=arguments[a];return n=e.call.apply(e,[this,r].concat(s))||this,n.validationErrors=t,n}return _inheritsLoose(t,e),t}(e("./validationError"));t.exports=o},{"../dependencies":11,"./validationError":18}],16:[function(e,t,r){var n=function(e){function t(t){for(var r,n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return r=e.call.apply(e,[this,t].concat(i))||this,r.name=r.constructor.name,r.message=t,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(_assertThisInitialized(r),r.constructor):r.stack=new Error(t).stack,r}return _inheritsLoose(t,e),t}(_extendableBuiltin(Error));t.exports=n},{}],17:[function(e,t,r){var n=e("../dependencies")._,i=function(e){function t(t,r){var i;t+="[\n"+n(r).map(function(e,t){return!n.isNil(e)&&t+": "+e.message.replace(/\n/g,"\n\t")}).filter(n.identity).join(",\n")+"\n]";for(var o=arguments.length,s=new Array(o>2?o-2:0),a=2;a<o;a++)s[a-2]=arguments[a];return i=e.call.apply(e,[this,t].concat(s))||this,i.validationErrors=r,i}return _inheritsLoose(t,e),t}(e("./validationError"));t.exports=i},{"../dependencies":11,"./validationError":18}],18:[function(e,t,r){var n=function(e){function t(){return e.apply(this,arguments)||this}return _inheritsLoose(t,e),t}(e("./extendableError"));t.exports=n},{"./extendableError":16}],19:[function(e,t,r){var n=e("./dependencies"),i=n._,o=n.Promise,s=e("./entityFactory"),a=e("./diaspora"),u=e("./set"),c=e("./validator"),l=s.entityPrototypeProperties,f=function(e,t,r,n){void 0===t&&(t={}),void 0===r&&(r={});var o;return o=i.isString(r)&&i.isNil(n)?{dataSourceName:r,options:{}}:i.isString(t)&&i.isNil(r)&&i.isNil(n)?{dataSourceName:t,queryFind:{},options:{}}:{queryFind:t,options:r,dataSourceName:n},o.dataSource=e.getDataSource(o.dataSourceName),o},p=function(e){return function(t){var r=i.map(t,function(t){return new e.entityFactory(t)}),n=new u(e,r);return o.resolve(n)}},d=function(e,t){return function(r,n,i){void 0===r&&(r={}),void 0===n&&(n={});var o=f(t,r,n,i);return o.dataSource[e](t.name,o.queryFind,o.options)}},h=function(e,t,r,n,s,a){var u,c=f(e,r,n,s),l=i([e.name,c.queryFind]).push(a).push(c.options).compact().value();return(u=c.dataSource)[(a?"update":"find")+(t?"Many":"One")].apply(u,l).then((t?p:function(e){return function(t){if(i.isNil(t))return o.resolve();var r=new e.entityFactory(t);return o.resolve(r)}})(e))},y=function(e){var t=e.sources;if(i.isString(t)){var r;(r={})[e.sources]=!0,t=r}else t=i.isArrayLike(t)?i.zipObject(t,i.times(t.length,i.constant({}))):i.mapValues(t,function(e,t){if(!0===e)return{};if(i.isObject(e))return e;throw new TypeError('Datasource "'+t+'" value is invalid: expect `true` or a remap hash, but have '+JSON.stringify(e))});return t},m=function(){function e(e,t){var r=i.intersection(l,i.keys(t.attributes));if(0!==r.length)throw new Error(JSON.stringify(r)+" is/are reserved property names. To match those column names in data source, please use the data source mapper property");if(!t.hasOwnProperty("sources")||!(i.isArrayLike(t.sources)||i.isObject(t.sources)||i.isString(t.sources)))throw new TypeError("Expect model sources to be either a string, an array or an object, had "+JSON.stringify(t.sources)+".");var n=y(t),o=i.keys(n),u=i.pick(a.dataSources,o),f=i.difference(o,i.keys(u));if(0!==f.length)throw new Error("Missing data sources "+f.map(function(e){return'"'+e+'"'}).join(", "));if(!i.isObject(t.attributes))throw new TypeError("Model attributes should be an object, have "+JSON.stringify(t.attributes));i.forEach(n,function(t,r){return u[r].configureCollection(e,t)}),i.assign(this,{dataSources:u,defaultDataSource:i(u).keys().first(),name:e,entityFactory:s(e,t,this),validator:new c(t.attributes)})}var t=e.prototype;return t.getDataSource=function(e){if(i.isNil(e))e=this.defaultDataSource;else if(!this.dataSources.hasOwnProperty(e))throw new Error('Unknown data source "'+e+'" in model "'+this.name+'", available are '+i.keys(this.dataSources).map(function(e){return'"'+e+'"'}).join(", "));return this.dataSources[e]},t.spawn=function(e){return new this.entityFactory(e)},t.spawnMany=function(e){var t=this;return new u(this,i.map(e,function(e){return t.spawn(e)}))},t.insert=function(e,t){var r=this;return this.getDataSource(t).insertOne(this.name,e).then(function(e){return o.resolve(new r.entityFactory(e))})},t.insertMany=function(e,t){return this.getDataSource(t).insertMany(this.name,e).then(p(this))},t.find=function(e,t,r){return h(this,!1,e,t,r)},t.findMany=function(e,t,r){return h(this,!0,e,t,r)},t.update=function(e,t,r,n){return void 0===r&&(r={}),h(this,!1,e,r,n,t)},t.updateMany=function(e,t,r,n){return void 0===r&&(r={}),h(this,!0,e,r,n,t)},t.delete=function(e,t,r){return void 0===t&&(t={}),d("deleteOne",this)(e,t,r)},t.deleteMany=function(e,t,r){return void 0===e&&(e={}),void 0===t&&(t={}),d("deleteMany",this)(e,t,r)},e}();t.exports=m},{"./dependencies":11,"./diaspora":12,"./entityFactory":13,"./set":20,"./validator":22}],20:[function(e,t,r){function n(e,t,r){return i.apply(this,arguments)}function i(){return(i=_asyncToGenerator(regeneratorRuntime.mark(function e(t,r,n){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=s.partial(f,this.entities,n),e.next=3,i("before");case 3:return e.next=5,a.all(this.entities.map(function(e){return e[r](t,{skipEvents:!0})}));case 5:return e.next=7,i("after");case 7:case"end":return e.stop()}},e,this)}))).apply(this,arguments)}var o=e("./dependencies"),s=o._,a=o.Promise,u=e("./diaspora"),c=e("./utils"),l=e("./errors/setValidationError"),f=function(e,t,r){return a.all(e.map(function(e,n){return e.emit(""+r+(s.isArray(t)?t[n]:t))}))},p={get:function(e,t){return t in e?e[t]:t in e.entities?e.entities[t]:"string"==typeof t&&t.match(/^-?\d+$/)&&e.entities.nth(parseInt(t))?e.entities.nth(parseInt(t)):void 0},set:function(e,t,r){if("model"===t)return new Error('Can\'t assign to read-only property "model".');"entities"===t&&(d.checkEntitiesFromModel(r,e.model),e.entities=s(r))}},d=function(){function e(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];n=s(n).flatten(),e.checkEntitiesFromModel(n.value(),t);var o=c.defineEnumerableProperties(this,{entities:n,model:t,length:{get:function(){return this.entities.size()}}});return new Proxy(o,p)}e.checkEntitiesFromModel=function(e,t){e.forEach(function(e,r){if(e.constructor.model!==t)throw new TypeError("Provided entity n°"+r+" "+e+" is not from model "+t+" ("+t.modelName+")")})};var t=e.prototype;return t.persist=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var r,i,o,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.entities.map(function(e){return"orphan"===e.state?"Create":"Update"}).value(),i=s.partial(f,this.entities),e.next=4,i("Persist","before");case 4:return e.next=6,i("Validate","before");case 6:if(o=this.entities.map(function(e){try{e.validate()}catch(t){return console.error(t),u.logger.error("Validation failed:",{entity:e,error:t}),t}}).value(),!((a=s.compact(o).length)>0)){e.next=10;break}throw new l("Set validation failed for "+a+" elements (on "+this.length+"): ",o);case 10:return e.next=12,i("Validate","after");case 12:return e.next=14,n.call(this,t,"persist",s.map(r,function(e){return"Persist"+e}));case 14:return e.next=16,i("Persist","after");case 16:return e.abrupt("return",this);case 17:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),t.fetch=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.call(this,t,"fetch","Fetch");case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),t.destroy=function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.call(this,t,"destroy","Destroy");case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}(),t.update=function(e){return this.entities.forEach(function(t){c.applyUpdateEntity(e,t)}),this},t.toObject=function(){return this.entities.map(function(e){return e.toObject()}).value()},e}();t.exports=d},{"./dependencies":11,"./diaspora":12,"./errors/setValidationError":17,"./utils":21}],21:[function(e,t,r){(function(r){var n=e("./dependencies")._;t.exports={defineEnumerableProperties:function(e,t){var r=n.mapValues(t,function(e){(n.isNil(e)||"object"!=typeof e||Object.getPrototypeOf(e)!==Object.prototype)&&(e={value:e});var t={enumerable:!0};return e.hasOwnProperty("get")||(t.writable=!1),n.defaults(e,t),e});return Object.defineProperties(e,r)},applyUpdateEntity:function(e,t){return n.forEach(e,function(e,r){n.isUndefined(e)?delete t[r]:t[r]=e}),t},generateUUID:function(){var e=(new Date).getTime();r.performance&&"function"==typeof r.performance.now&&(e+=r.performance.now());return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?r:3&r|8).toString(16)})},applyOptionsToSet:function(e,t){return n.defaults(t,{limit:1/0,skip:0}),(e=e.slice(t.skip)).length>t.limit&&(e=e.slice(0,t.limit)),e}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./dependencies":11}],22:[function(e,t,r){var n=e("./dependencies"),i=e("./diaspora").components.Errors.EntityValidationError,o=n._,s=function(e){return function(t,r,n){if(!e(n))return{type:t.toValidatePath()+' expected to be a "'+r.type+'"'}}},a={TYPE:{string:s(o.isString),integer:s(o.isInteger),float:s(o.isNumber),date:s(o.isDate),boolean:s(o.isBoolean),object:function(e,t,r){var n=this;if(!o.isObject(r))return{type:e.toValidatePath()+' expected to be a "'+t.type+'"'};var i=o.isObject(t.attributes)?o(o.assign({},t.attributes,r)).mapValues(function(t,i){var o=r[i];return n.check(o,e.clone().pushValidationProp("attributes").pushProp(i),{getProps:!1})}).omitBy(o.isEmpty).value():{};return o.isEmpty(i)?void 0:{children:i}},array:function(e,t,r){if(!o.isArray(r))return{type:e.toValidatePath()+' expected to be a "'+t.type+'"'};var n=o.isObject(t.of)?o(r).map(function(e,t,r){return function(n,i){if(t.hasOwnProperty("of")){var s=o.castArray(t.of),a=o(s).map(function(s,a){return e.check(n,r.clone().pushValidationProp("of",o.isArray(t.of)?a:void 0).pushEntityProp(i),{getProps:!1})});if(!o.isArray(t.of))return a.get(0);if(a.compact().value().length===s.length)return a.toPlainObject().omitBy(o.isNil).value()}return{}}}(this,t,e)).omitBy(o.isEmpty).value():{};return o.isEmpty(n)?void 0:{children:n}},any:function(e,t,r){if(!o.stubTrue(r))return{type:e.toValidatePath()+" expected to be assigned with any type"}},_:function(e,t){return{type:e.toValidatePath()+' requires to be unhandled type "'+t.type+'"'}}}};o.assign(a.TYPE,{bool:a.TYPE.boolean,int:a.TYPE.integer,str:a.TYPE.string,text:a.TYPE.string});var u=[function(e){var t=this,r=e.error,n=e.fieldDesc,i=e.keys,s=e.value;o(n.validate).castArray().compact().forEach(function(e){e.call(t,s,n)||(r.validate=i.toValidatePath()+" custom validation failed")})},function(e){var t=e.error,r=e.fieldDesc,n=e.keys,i=e.value;o.isNil(r.type)||o.isNil(r.model)?!0===r.required&&o.isNil(i)?t.required=n.toValidatePath()+' is a required property of type "'+r.type+'"':o.isNil(i)||(o.isString(r.type)?o.assign(t,o.get(a,["TYPE",r.type],a.TYPE._).call(this,n,r,i)):t.spec=n.toValidatePath()+' spec "type" must be a string'):t.spec=n.toValidatePath()+" spec can't have both a type and a model"},function(e){var t=e.error,r=e.fieldDesc,n=e.keys,i=e.value;if(!o.isNil(i)&&!o.isNil(r.enum)){!1===o.some(r.enum,function(e){return e instanceof RegExp?null!==i.match(e):i===e})&&(t.enum=n.toValidatePath()+' expected to have one of enumerated values "'+JSON.stringify(r.enum)+'"')}}],c=Symbol("PRIVATE"),l=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),o.assign(this,{segmentsEntity:e,segmentsValidation:t})}var t=e.prototype;return t.pushEntityProp=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.segmentsEntity=o(this.segmentsEntity).concat(t).filter(o.isNil).value(),this},t.pushValidationProp=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.segmentsValidation=o(this.segmentsValidation).concat(t).filter(function(e){return!o.isNil(e)}).value(),this},t.pushProp=function(){var e;return(e=this.pushEntityProp.apply(this,arguments)).pushValidationProp.apply(e,arguments)},t.toValidatePath=function(){return this.segmentsEntity.join(".")},t.toArray=function(){return[this.segmentsEntity.slice(),this.segmentsValidation.slice()]},t.clone=function(){return new(Function.prototype.bind.apply(e,[null].concat(this.toArray())))},e}(),f=function(){function e(e){var t={modelDesc:e};this[c]=t}var t=e.prototype;return t.validate=function(e){var t=this,r=o(this[c].modelDesc).mapValues(function(r,n){return t.check(e[n],(new l).pushProp(n),{getProps:!1})}).omitBy(o.isEmpty).value();if(!o.isNil(r)&&!o.isEmpty(r))throw new i(r,"Validation failed")},t.check=function(e,t,r){var n=this;void 0===r&&(r={}),o.defaults(r,{getProps:!0}),t instanceof l||(t=new l(t));var i=r.getProps?o.get(e,t.segmentsEntity):e,s=o.get(this[c].modelDesc,t.segmentsValidation);if(o.isObject(s)){o.defaults(s,{required:!1});var a={},f={error:a,fieldDesc:s,keys:t,value:i};return o.forEach(u,function(e){return e.call(n,f)}),o.isEmpty(a)?null:(a.value=e,a)}},_createClass(e,[{key:"modelDesc",get:function(){return o.cloneDeep(this[c].modelDesc)}}],[{key:"PathStack",get:function(){return l}}]),e}();t.exports=f},{"./dependencies":11,"./diaspora":12}],23:[function(e,t,r){(function(e){function t(e,t){for(var r=0,n=e.length-1;n>=0;n--){var i=e[n];"."===i?e.splice(n,1):".."===i?(e.splice(n,1),r++):r&&(e.splice(n,1),r--)}if(t)for(;r--;r)e.unshift("..");return e}function n(e,t){if(e.filter)return e.filter(t);for(var r=[],n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r}var i=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,o=function(e){return i.exec(e).slice(1)};r.resolve=function(){for(var r="",i=!1,o=arguments.length-1;o>=-1&&!i;o--){var s=o>=0?arguments[o]:e.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(r=s+"/"+r,i="/"===s.charAt(0))}return r=t(n(r.split("/"),function(e){return!!e}),!i).join("/"),(i?"/":"")+r||"."},r.normalize=function(e){var i=r.isAbsolute(e),o="/"===s(e,-1);return(e=t(n(e.split("/"),function(e){return!!e}),!i).join("/"))||i||(e="."),e&&o&&(e+="/"),(i?"/":"")+e},r.isAbsolute=function(e){return"/"===e.charAt(0)},r.join=function(){var e=Array.prototype.slice.call(arguments,0);return r.normalize(n(e,function(e,t){if("string"!=typeof e)throw new TypeError("Arguments to path.join must be strings");return e}).join("/"))},r.relative=function(e,t){function n(e){for(var t=0;t<e.length&&""===e[t];t++);for(var r=e.length-1;r>=0&&""===e[r];r--);return t>r?[]:e.slice(t,r-t+1)}e=r.resolve(e).substr(1),t=r.resolve(t).substr(1);for(var i=n(e.split("/")),o=n(t.split("/")),s=Math.min(i.length,o.length),a=s,u=0;u<s;u++)if(i[u]!==o[u]){a=u;break}var c=[];for(u=a;u<i.length;u++)c.push("..");return(c=c.concat(o.slice(a))).join("/")},r.sep="/",r.delimiter=":",r.dirname=function(e){var t=o(e),r=t[0],n=t[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."},r.basename=function(e,t){var r=o(e)[2];return t&&r.substr(-1*t.length)===t&&(r=r.substr(0,r.length-t.length)),r},r.extname=function(e){return o(e)[3]};var s="b"==="ab".substr(-1)?function(e,t,r){return e.substr(t,r)}:function(e,t,r){return t<0&&(t=e.length+t),e.substr(t,r)}}).call(this,e("_process"))},{_process:24}],24:[function(e,t,r){function n(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(l===setTimeout)return setTimeout(e,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function s(){y&&d&&(y=!1,d.length?h=d.concat(h):m=-1,h.length&&a())}function a(){if(!y){var e=o(s);y=!0;for(var t=h.length;t;){for(d=h,h=[];++m<t;)d&&d[m].run();m=-1,t=h.length}d=null,y=!1,function(e){if(f===clearTimeout)return clearTimeout(e);if((f===i||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(e);try{f(e)}catch(t){try{return f.call(null,e)}catch(t){return f.call(this,e)}}}(e)}}function u(e,t){this.fun=e,this.array=t}function c(){}var l,f,p=t.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(e){l=n}try{f="function"==typeof clearTimeout?clearTimeout:i}catch(e){f=i}}();var d,h=[],y=!1,m=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];h.push(new u(e,t)),1!==h.length||y||o(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=c,p.addListener=c,p.once=c,p.off=c,p.removeListener=c,p.removeAllListeners=c,p.emit=c,p.prependListener=c,p.prependOnceListener=c,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=diaspora.min.js.map