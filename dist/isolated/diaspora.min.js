/**
* @file diaspora
*
* Multi-Layer ORM for Javascript Client+Server
* Isolated build compiled on 2017-10-18 01:26:41
*
* @license GPL-3.0
* @version 0.2.0-rc.1
* @author Gerkin
*/
function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _get=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,n,r)}if("value"in i)return i.value;var s=i.get;if(void 0!==s)return s.call(r)},_slicedToArray=function(){function e(e,t){var n=[],r=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(r=(s=a.next()).done)&&(n.push(s.value),!t||n.length!==t);r=!0);}catch(e){i=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){if("object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Diaspora=e()}}(function(){return function e(t,n,r){function i(s,a){if(!n[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return i(n||e)},l,l.exports,e,t,n,r)}return n[s].exports}for(var o="function"==typeof require&&require,s=0;s<r.length;s++)i(r[s]);return i}({1:[function(e,t,n){"use strict";var r=e("./lib/diaspora");t.exports=r},{"./lib/diaspora":9}],2:[function(e,t,n){"use strict";var r=e("../dependencies"),i=r._,o=r.Promise,s=r.SequentialEvent,a=function(e){function t(e){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.state="preparing",n.remaps={},n.remapsInverted={},n.filters={},n.classEntity=e,n.error=void 0,n.on("ready",function(){n.state="ready"}).on("error",function(e){n.state="error",n.error=e}),n}return _inherits(t,s),_createClass(t,[{key:"configureCollection",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.remaps[e]=t,this.remapsInverted[e]=i.invert(t),this.filters=n||{}}},{key:"waitReady",value:function(){var e=this;return new o(function(t,n){return"ready"===e.state?t(e):"error"===e.state?n(e.error):void e.on("ready",function(){return t(e)}).on("error",function(e){return n(e)})})}},{key:"remapFields",value:function(e,t){var n=(arguments.length>2&&void 0!==arguments[2]&&arguments[2]?this.remapsInverted:this.remaps)[e];return i.isNil(n)?t:i.mapKeys(t,function(e,t){return n.hasOwnProperty(t)?n[t]:t})}},{key:"remapInput",value:function(e,t){var n=this;if(i.isNil(t))return t;var r=i.mapValues(t,function(e,t){return i.isObject(i.get(n,"filters.input"))&&n.filters.input.hasOwnProperty(t)?n.filters.input[t](e):e});return i.mapKeys(r,function(e,t){return n.remaps.hasOwnProperty(t)?n.remaps[t]:t})}},{key:"remapOutput",value:function(e,t){var n=this;if(i.isNil(t))return t;var r=i.mapValues(t,function(e,t){return i.isObject(i.get(n,"filters.output"))&&n.filters.output.hasOwnProperty(t)?n.filters.output[t](e):e});return i.mapKeys(r,function(e,t){return n.remapsInverted.hasOwnProperty(t)?n.remapsInverted[t]:t})}},{key:"setIdHash",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"id";return e.idHash=i.assign({},e.idHash,_defineProperty({},this.name,e[t])),e}},{key:"matchEntity",value:function(e,t){return i.every(i.toPairs(e),function(e){var n=_slicedToArray(e,2),r=n[0],o=n[1];if(i.isObject(o)){var s=t[r];return i.every(o,function(e,t){switch(t){case"$exists":return e===!i.isUndefined(s);case"$equal":return!i.isUndefined(s)&&s===e;case"$diff":return!i.isUndefined(s)&&s!==e;case"$less":return!i.isUndefined(s)&&s<e;case"$lessEqual":return!i.isUndefined(s)&&s<=e;case"$greater":return!i.isUndefined(s)&&s>e;case"$greaterEqual":return!i.isUndefined(s)&&s>=e}return!1})}return!1})}},{key:"applyUpdateEntity",value:function(e,t){return i.forEach(e,function(e,n){i.isUndefined(e)?delete t[n]:t[n]=e}),t}},{key:"normalizeOptions",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if((e=i.cloneDeep(e)).hasOwnProperty("limit")){var t=e.limit;if(i.isString(t)&&(t=parseInt(t)),!i.isInteger(t)&&1/0!==t||t<0)throw new TypeError('Expect "options.limit" to be an integer equal to or above 0, have '+t);e.limit=t}if(e.hasOwnProperty("skip")){var n=e.skip;if(i.isString(n)&&(n=parseInt(n)),!i.isInteger(n)||n<0||!isFinite(n))throw new TypeError('Expect "options.skip" to be a finite integer equal to or above 0, have '+n);e.skip=n}if(e.hasOwnProperty("page")){if(!e.hasOwnProperty("limit"))throw new ReferenceError('Usage of "options.page" requires "options.limit" to be defined.');if(!isFinite(e.limit))throw new ReferenceError('Usage of "options.page" requires "options.limit" to not be infinite');if(e.hasOwnProperty("skip"))throw new Error('Use either "options.page" or "options.skip"');var r=e.page;if(i.isString(r)&&(r=parseInt(r)),!i.isInteger(r)||r<0)throw new TypeError('Expect "options.page" to be an integer equal to or above 0, have '+r);e.skip=r*e.limit,delete e.page}return i.defaults(e,{skip:0,remapInput:!0,remapOutput:!0}),e}},{key:"normalizeQuery",value:function(e,t){var n={"~":"$exists","==":"$equal","!=":"$diff","<":"$less","<=":"$lessEqual",">":"$greater",">=":"$greaterEqual"};return!0===t.remapInput?i(i.cloneDeep(e)).mapValues(function(e){return!i.isNil(e)&&e instanceof Object?(i.forEach(n,function(t,n){if(e.hasOwnProperty(n)){if(e.hasOwnProperty(t))throw new Error("Search can't have both \""+n+'" and "'+t+'" keys, as they are synonyms');e[t]=e[n],delete e[n]}}),i.forEach(["$less","$lessEqual","$greater","$greaterEqual"],function(t){if(e.hasOwnProperty(t)&&!i.isNumber(e[t]))throw new TypeError('Expect "'+t+'" in '+JSON.stringify(e)+" to be a numeric value")}),e):i.isNil(e)?{$exists:!1}:{$equal:e}}).value():i.cloneDeep(e)}},{key:"insertOne",value:function(e,t){return this.insertMany(e,[t]).then(function(e){return o.resolve(i.first(e))})}},{key:"insertMany",value:function(e,t){var n=this;return o.mapSeries(t,function(t){return n.insertOne(e,t||{})})}},{key:"findOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.limit=1,this.findMany(e,t,n).then(function(e){return o.resolve(i.first(e))})}},{key:"findMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=[],a=0,u=(r=this.normalizeOptions(r)).skip;return function c(l){return i.isNil(l)?o.resolve(s):(!0!==l&&s.push(l),a===r.limit?o.resolve(s):(r.skip=u+a,a++,n.findOne(e,t,r).then(c)))}(!0)}},{key:"updateOne",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return r.limit=1,this.updateMany(e,t,n,r).then(function(e){return o.resolve(i.first(e))})}},{key:"updateMany",value:function(e,t,n){var r=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=[],u=0;return function c(l){return i.isNil(l)?o.resolve(a):(!0!==l&&a.push(l),u===s.limit?o.resolve(a):(s.skip=u,u++,r.updateOne(e,t,n,s).then(c)))}(!0)}},{key:"deleteOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n.limit=1,this.deleteMany(e,t,n)}},{key:"deleteMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=0;return function a(){return n.findOne(e,t,r).then(function(u){return i.isNil(u)?o.resolve():s===r.limit?o.resolve():(s++,n.deleteOne(e,t,r).then(a))})}()}}]),t}();t.exports=a},{"../dependencies":8}],3:[function(e,t,n){(function(n){"use strict";var r=e("../dependencies"),i=r._,o=r.Promise,s=e("./baseAdapter.js"),a=e("../dataStoreEntities/browserStorageEntity.js"),u=function(e){function t(e){_classCallCheck(this,t);var r=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,a));return i.defaults(e,{session:!1}),r.state="ready",r.source=!0===e.session?n.sessionStorage:n.localStorage,r}return _inherits(t,s),_createClass(t,[{key:"configureCollection",value:function(e,n){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"configureCollection",this).call(this,e,n),this.ensureCollectionExists(e)}},{key:"generateUUID",value:function(){var e=(new Date).getTime();return n.performance&&"function"==typeof n.performance.now&&(e+=n.performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}},{key:"ensureCollectionExists",value:function(e){var t=this.source.getItem(e);return i.isNil(t)?(t=[],this.source.setItem(e,JSON.stringify(t))):t=JSON.parse(t),t}},{key:"getItemName",value:function(e,t){return e+".id="+t}},{key:"insertOne",value:function(e,t){(t=i.cloneDeep(t||{})).id=this.generateUUID(),this.setIdHash(t);try{var n=this.ensureCollectionExists(e);n.push(t.id),this.source.setItem(e,JSON.stringify(n)),this.source.setItem(this.getItemName(e,t.id),JSON.stringify(t))}catch(e){return o.reject(e)}return o.resolve(new this.classEntity(t,this))}},{key:"insertMany",value:function(e,t){var n=this;t=i.cloneDeep(t);try{var r=this.ensureCollectionExists(e);t=t.map(function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t.id=n.generateUUID(),n.setIdHash(t),r.push(t.id),n.source.setItem(n.getItemName(e,t.id),JSON.stringify(t)),new n.classEntity(t,n)}),this.source.setItem(e,JSON.stringify(r))}catch(e){return o.reject(e)}return o.resolve(t)}},{key:"findOneById",value:function(e,t){var n=this.source.getItem(this.getItemName(e,t));return i.isNil(n)?o.resolve():o.resolve(new this.classEntity(JSON.parse(n),this))}},{key:"findOne",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(i.defaults(r,{skip:0}),!i.isObject(t))return this.findOneById(e,t);if(i.isEqual(i.keys(t),["id"])&&i.isEqual(i.keys(t.id),["$equal"]))return this.findOneById(e,t.id.$equal);var s=this.ensureCollectionExists(e),a=void 0,u=0;return i.each(s,function(i){var o=JSON.parse(n.source.getItem(n.getItemName(e,i)));if(n.matchEntity(t,o)&&++u>r.skip)return a=o,!1}),o.resolve(i.isNil(a)?void 0:new this.classEntity(a,this))}},{key:"updateOne",value:function(e,t,n,r){var s=this;return i.defaults(r,{skip:0}),this.findOne(e,t,r).then(function(t){if(i.isNil(t))return o.resolve();s.applyUpdateEntity(n,t);try{return s.source.setItem(s.getItemName(e,t.id),JSON.stringify(t)),o.resolve(t)}catch(e){return o.reject(e)}})}},{key:"deleteOne",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.findOne(e,t,r).then(function(t){try{var r=n.ensureCollectionExists(e);i.pull(r,t.id),n.source.setItem(e,JSON.stringify(r)),n.source.removeItem(n.getItemName(e,t.id))}catch(e){return o.reject(e)}return o.resolve()})}},{key:"deleteMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{return this.findMany(e,t,r).then(function(t){var r=n.ensureCollectionExists(e);return i.pullAll(r,i.map(t,"id")),n.source.setItem(e,JSON.stringify(r)),i.forEach(t,function(t){n.source.removeItem(n.getItemName(e,t.id))}),o.resolve()})}catch(e){return o.reject(e)}}}],[{key:"applyOptionsToSet",value:function(e,t){return i.defaults(t,{limit:1/0,skip:0}),(e=e.slice(t.skip)).length>t.limit&&(e=e.slice(0,t.limit)),e}}]),t}();t.exports=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../dataStoreEntities/browserStorageEntity.js":6,"../dependencies":8,"./baseAdapter.js":2}],4:[function(e,t,n){(function(n){"use strict";var r=e("../dependencies"),i=r._,o=r.Promise,s=e("./baseAdapter.js"),a=e("../dataStoreEntities/inMemoryEntity.js"),u=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,a));return e.state="ready",e.store={},e}return _inherits(t,s),_createClass(t,[{key:"configureCollection",value:function(e,n){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"configureCollection",this).call(this,e,n),this.ensureCollectionExists(e)}},{key:"generateUUID",value:function(){var e=(new Date).getTime();return n.performance&&"function"==typeof n.performance.now&&(e+=n.performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:3&n|8).toString(16)})}},{key:"ensureCollectionExists",value:function(e){return this.store.hasOwnProperty(e)?this.store[e]:this.store[e]={items:[]}}},{key:"insertOne",value:function(e,t){t=i.cloneDeep(t);var n=this.ensureCollectionExists(e);return t.id=this.generateUUID(),this.setIdHash(t),n.items.push(t),o.resolve(new this.classEntity(t,this))}},{key:"findOne",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=this.ensureCollectionExists(e),s=i.filter(r.items,i.partial(this.matchEntity,t)),a=this.constructor.applyOptionsToSet(s,n);return o.resolve(a.length>0?new this.classEntity(i.first(a),this):void 0)}},{key:"findMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.ensureCollectionExists(e),a=i.filter(s.items,i.partial(this.matchEntity,t)),u=this.constructor.applyOptionsToSet(a,r);return o.resolve(i.map(u,function(e){return new n.classEntity(e,n)}))}},{key:"updateOne",value:function(e,t,n){var r=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.findOne(e,t,s).then(function(t){if(i.isNil(t))return o.resolve();var s=r.ensureCollectionExists(e),a=i.find(s.items,{id:t.id});return r.applyUpdateEntity(n,a),o.resolve(new r.classEntity(a,r))})}},{key:"updateMany",value:function(e,t,n){var r=this,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this.findMany(e,t,s).then(function(t){if(!i.isNil(t)&&t.length>0){var s=r.ensureCollectionExists(e),a=i.map(t,"id"),u=i.filter(s.items,function(e){return-1!==a.indexOf(e.id)});return o.resolve(i.map(u,function(e){return r.applyUpdateEntity(n,e),new r.classEntity(e,r)}))}return o.resolve()})}},{key:"deleteOne",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.ensureCollectionExists(e);return this.findOne(e,t,r).then(function(e){return s.items=i.reject(s.items,function(t){return t.id===e.idHash[n.name]}),o.resolve()})}},{key:"deleteMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=this.ensureCollectionExists(e);return this.findMany(e,t,r).then(function(e){var t=i.map(e,function(e){return i.get(e,"idHash."+n.name)});return s.items=i.reject(s.items,function(e){return i.includes(t,e.id)}),o.resolve()})}}],[{key:"applyOptionsToSet",value:function(e,t){return i.defaults(t,{limit:1/0,skip:0}),(e=e.slice(t.skip)).length>t.limit&&(e=e.slice(0,t.limit)),e}}]),t}();t.exports=u}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../dataStoreEntities/inMemoryEntity.js":7,"../dependencies":8,"./baseAdapter.js":2}],5:[function(e,t,n){"use strict";var r=e("../dependencies")._,i=function(){function e(t,n){if(_classCallCheck(this,e),!r.isNil(t)){if(r.isNil(n))throw new TypeError('Expect 2nd argument to be the parent of this entity, have "'+n+'"');Object.defineProperties(this,{dataSource:{value:n,enumerable:!1,configurable:!1}}),r.assign(this,t)}}return _createClass(e,[{key:"toObject",value:function(){return r.omit(this,["dataSource","id"])}}]),e}();t.exports=i},{"../dependencies":8}],6:[function(e,t,n){"use strict";var r=e("./baseEntity.js"),i=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,r),t}();t.exports=i},{"./baseEntity.js":5}],7:[function(e,t,n){"use strict";var r=e("./baseEntity.js"),i=function(e){function t(e,n){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,n))}return _inherits(t,r),t}();t.exports=i},{"./baseEntity.js":5}],8:[function(e,t,n){(function(n){"use strict";t.exports={_:n._||e("lodash"),SequentialEvent:n.SequentialEvent||e("sequential-event"),Promise:n.Promise&&n.Promise.version?n.Promise:e("bluebird")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{bluebird:void 0,lodash:void 0,"sequential-event":void 0}],9:[function(e,t,n){(function(n){"use strict";var r=e("./dependencies"),i=r._,o=r.Promise,s=function(){if(n.browser)return console;var t=e("winston"),r=t.createLogger({level:"silly",format:t.format.json(),transports:[]});return"production"!==n.env.NODE_ENV&&r.add(new t.transports.Console({format:t.format.simple()})),r}(),a={},u={},c={},l=function(e,t,n){return function(r){for(var s=arguments.length,a=Array(s>1?s-1:0),u=1;u<s;u++)a[u-1]=arguments[u];var c=function(e){return(e=n.remapFields(r,e,!0))instanceof n.classEntity||i.isNil(e)?e:new n.classEntity(e,n)},l=!1,f=!1;["find","delete"].indexOf(t.query)>=0?l=1:"update"===t.query&&(l=2,f=!0);try{!1!==l?(a[l]=n.normalizeOptions(a[l]),!0===a[l].remapInput&&(a[0]=n.remapFields(r,a[0],!1),!0===f&&(a[1]=n.remapFields(r,a[1],!1))),a[0]=n.normalizeQuery(a[0],a[l]),a[l].remapInput=!1):"insert"===t.query&&("many"===t.number?a[0]=i.map(a[0],function(e){return n.remapFields(r,e,!1)}):a[0]=n.remapFields(r,a[0],!1))}catch(e){return o.reject(e)}return e.call.apply(e,[n,r].concat(a)).then(function(e){return i.isArrayLike(e)?e=i.map(e,c):i.isNil(e)||(e=c(e)),o.resolve(e)})}},f={check:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return i(n).mapValues(function(n,r){return t.checkField.call(t,e[r],n,i.concat([],[r]))}).omitBy(i.isEmpty).value()},checkField:function(e,t,n){var r=this;if(i.isObject(t)){i.defaults(t,{required:!1});var o={};if(t.validate&&(t.validate.call(this,e,t)||(o.validate=n.join(".")+" custom validation failed")),i.isNil(t.type)||i.isNil(t.model)){if(!0===t.required&&i.isNil(e))o.required=n.join(".")+' is a required property of type "'+t.type+'"';else if(!i.isNil(e))if(i.isString(t.type))switch(t.type){case"string":i.isString(e)||(o.type=n.join(".")+' expected to be a "'+t.type+'"');break;case"integer":i.isInteger(e)||(o.type=n.join(".")+' expected to be a "'+t.type+'"');break;case"float":i.isNumber(e)||(o.type=n.join(".")+' expected to be a "'+t.type+'"');break;case"date":i.isDate(e)||(o.type=n.join(".")+' expected to be a "'+t.type+'"');break;case"object":if(i.isObject(e)){var s=i.isObject(t.attributes)?i(e).mapValues(function(e,o){return r.checkField(e,t.attributes[o],i.concat(n,[o]))}).omitBy(i.isEmpty).value():{};i.isEmpty(s)||(o.children=s)}else o.type=n.join(".")+' expected to be a "'+t.type+'"';break;case"array":if(i.isArray(e)){var a=i.isObject(t.of)?i(e).map(function(e,o){if(!i.isArrayLike(t.of))return r.checkField(e,t.of,i.concat(n,[o]));var s=i(t.of).map(function(t){return r.checkField(e,t,i.concat(n,[o]))});return i.find(s,function(e){return 0===e.length})?void 0:s}).omitBy(i.isEmpty).value():{};i.isEmpty(a)||(o.children=a)}else o.type=n.join(".")+' expected to be a "'+t.type+'"';break;case"any":i.stubTrue(e)||(o.type=n.join(".")+" expected to be assigned with any type");break;default:o.type=n.join(".")+' requires to be unhandled type "'+t.type+'"'}else o.spec=n.join(".")+' spec "type" must be a string'}else o.spec=n.join(".")+" spec can't have both a type and a model";return i.isNil(t.enum)||!1===i.some(t.enum,function(t){return t instanceof RegExp?null!==e.match(t):e===t})&&(o.enum=n.join(".")+' expected to have one of enumerated values "'+JSON.stringify(t.enum)+'"'),i.isEmpty(o)?void 0:(o.value=e,o)}},default:function(e,t){var n=this;return i.defaults(e,i.mapValues(t,function(t,r){return n.defaultField(e[r],t)}))},defaultField:function(e,t){var n=void 0;return n=i.isUndefined(e)?i.isFunction(t.default)?t.default():t.default:e,"object"===t.type&&i.isObject(t.attributes)&&i.keys(t.attributes).length>0&&!i.isNil(n)?this.default(n,t.attributes):n},createDataSource:function(e,t){if(!a.hasOwnProperty(e))throw new Error('Unknown adapter "'+e+'". Available currently are '+Object.keys(a).join(", "));var n=new a[e](t);return new Proxy(n,{get:function(e,t){if(i.isString(t)){var n=t.match(/^(find|update|insert|delete)(Many|One)$/);if(null!==n)return n[2]=n[2].toLowerCase(),n=i.mapKeys(n.slice(0,3),function(e,t){return["full","query","number"][t]}),l(e[t],n,e)}return e[t]}})},registerDataSource:function(e,t){if(!i.isString(e)&&e.length>0)throw new Error('DataSource name must be a non empty string, had "'+e+'"');if(u.hasOwnProperty(e))throw new Error('DataSource name already used, had "'+e+'"');if(!(t instanceof f.components.DiasporaAdapter))throw new Error('DataSource must be an instance inheriting "DiasporaAdapter"');t.name=e,i.merge(u,_defineProperty({},e,t))},createNamedDataSource:function(e,t,n){var r=f.createDataSource(t,n);f.registerDataSource(e,r)},declareModel:function(e,t){if(!i.isString(e)&&e.length>0)throw new Error('DataSource name must be a non empty string, had "'+e+'"');if(!i.isObject(t))throw new Error('"modelDesc" must be an object');var n=new f.components.Model(e,t);return i.assign(c,_defineProperty({},e,n)),n},registerAdapter:function(e,t){if(a[e])throw new Error('Adapter with label "'+e+'" already exists.');if(!(t.prototype instanceof f.components.DiasporaAdapter))throw new TypeError('Trying to register an adapter with label "'+e+'", but it does not extends DiasporaAdapter.');a[e]=t},models:c,dataSources:u,adapters:a,dependencies:r,logger:s};t.exports=f,f.components={Entity:e("./entityFactory")(null,{},null),Set:e("./set"),Model:e("./model"),Errors:{EntityValidationError:e("./errors/entityValidationError"),SetValidationError:e("./errors/setValidationError"),EntityStateError:e("./errors/entityStateError")},DiasporaAdapter:e("./adapters/baseAdapter"),DataStoreEntity:e("./dataStoreEntities/baseEntity")},f.registerAdapter("inMemory",e("./adapters/inMemoryAdapter")),n.browser&&f.registerAdapter("browserStorage",e("./adapters/browserStorageAdapter"))}).call(this,e("_process"))},{"./adapters/baseAdapter":2,"./adapters/browserStorageAdapter":3,"./adapters/inMemoryAdapter":4,"./dataStoreEntities/baseEntity":5,"./dependencies":8,"./entityFactory":10,"./errors/entityStateError":11,"./errors/entityValidationError":12,"./errors/setValidationError":14,"./model":15,"./set":16,_process:18,winston:void 0}],10:[function(e,t,n){"use strict";var r=e("./dependencies"),i=r._,o=r.Promise,s=r.SequentialEvent,a=e("./diaspora"),u=e("./dataStoreEntities/baseEntity"),c=e("./errors/entityValidationError"),l=e("./errors/entityStateError"),f=e("./utils");t.exports=function(e,t,n){var r=i.keys(t.attributes),p=function(p){function d(){var s,p=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,d);var h=_possibleConstructorReturn(this,(d.__proto__||Object.getPrototypeOf(d)).call(this)),y="orphan",v=null,m=Object.seal(i.mapValues(n.dataSources,function(){})),g={dataSources:{value:m},toObject:function(){return i.omit(k,b)},persist:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i.defaults(t,{skipEvents:!1});var n=h.constructor.model.getDataSource(e),r=y;y="syncing";var s=[e],a="orphan"===r?"Create":"Update";return(t.skipEvents?o.resolve():h.emit.apply(h,["beforePersist"].concat(s)).then(function(){return h.emit.apply(h,["beforeValidate"].concat(s))}).then(function(){return h.validate(),h.emit.apply(h,["afterValidate"].concat(s))}).then(function(){return h.emit.apply(h,["beforePersist"+a].concat(s))})).then(function(){return v=n.name,"orphan"===r?n.insertOne(h.table(e),h.toObject()):n.updateOne(h.table(e),h.uidQuery(n),h.toObject())}).then(function(e){return t.skipEvents?o.resolve(e):h.emit.apply(h,["afterPersist"+a].concat(s)).then(function(){return h.emit.apply(h,["afterPersist"].concat(s))}).then(function(){return o.resolve(e)})}).then(function(e){return y="sync",_.dataSources[n.name]=e,k=e.toObject(),o.resolve(x)})},fetch:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i.defaults(t,{skipEvents:!1});var n=h.constructor.model.getDataSource(e),r=y;return y="syncing",(t.skipEvents?o.resolve():h.emit("beforeFetch",e)).then(function(){return"orphan"===r?o.reject(new l("Can't fetch an orphan entity.")):(v=n.name,n.findOne(h.table(e),h.uidQuery(n)))}).then(function(r){return y="sync",_.dataSources[n.name]=r,k=r.toObject(),t.skipEvents?o.resolve(x):h.emit("afterFetch",e).then(function(){return o.resolve(x)})})},destroy:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i.defaults(t,{skipEvents:!1});var r=h.constructor.model.getDataSource(e),s=y;return y="syncing",(t.skipEvents?o.resolve():h.emit("beforeDestroy",e)).then(function(){return"orphan"===s?o.reject(new l("Can't fetch an orphan entity.")):(v=r.name,r.deleteOne(h.table(e),h.uidQuery(r)))}).then(function(){return 0===i.without(n.dataSources,r.name).length?y="orphan":(y="sync",delete k.idHash[r.name]),_.dataSources[r.name]=void 0,t.skipEvents?o.resolve(x):h.emit("afterDestroy",e).then(function(){return o.resolve(x)})})},state:{get:function(){return y}},lastDataSource:{get:function(){return v}},uidQuery:function(e){return{id:k.idHash[e.name]}},table:function(){return e},validate:function(){var e=a.check(k,t.attributes);if(!i.isEmpty(e))throw new c(e,"Validation failed")}},b=i.keys(g);p instanceof u&&(y="sync",m[v=p.dataSource.name]=p,p=i.omit(p.toObject(),["id"]));var w=i.keys(p),E=i.intersection(w,b);if(0!==E.length)throw new Error("Source has reserved keys: "+JSON.stringify(E)+" in "+JSON.stringify(p));var O=i.difference(p,r);if(0!==O.length)throw new Error("Source has unknown keys: "+JSON.stringify(O)+" in "+JSON.stringify(p));var k=i.cloneDeep(p);p=null,a.default(k,t.attributes),i.forEach(t.lifecycleEvents,function(e,t){i.forEach(i.castArray(e),function(e){h.on(t,e)})});var _=f.defineEnumerableProperties(h,g),x=new Proxy(_,{get:function(e,t){return"constructor"===t?_[t]:t in _?_[t]:k[t]},set:function(e,t,n){return t in _&&!_get(d.prototype.__proto__||Object.getPrototypeOf(d.prototype),"hasOwnProperty",h).call(h,t)?(console.warn("Trying to define read-only key "+t+"."),n):k[t]=n},enumerate:function(){return i.keys(k)},ownKeys:function(){return i(k).keys().concat(b).value()},has:function(e,t){return k.hasOwnProperty(t)}});return s=x,_possibleConstructorReturn(h,s)}return _inherits(d,s),d}(),d=Object.defineProperties(p,{name:{value:e+"Entity",writable:!1,enumerable:!0},model:{value:n,writable:!1,enumerable:!0}});return i.forEach(t.methods,function(e,t){p.prototype[e]=t}),i.forEach(t.staticMethods,function(e,t){p[e]=t}),d}},{"./dataStoreEntities/baseEntity":5,"./dependencies":8,"./diaspora":9,"./errors/entityStateError":11,"./errors/entityValidationError":12,"./utils":17}],11:[function(e,t,n){"use strict";var r=e("./extendableError"),i=function(e){function t(){var e;_classCallCheck(this,t);for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];return _possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(r)))}return _inherits(t,r),t}();t.exports=i},{"./extendableError":13}],12:[function(e,t,n){"use strict";var r=e("../dependencies")._,i=e("./extendableError"),o=function(e){return r(e).mapValues(function(e,t){return t+" => "+JSON.stringify(e.value)+"\n* "+r(e).omit(["value"]).values().map(r.identity).value()}).values().join("\n* ")},s=function(e){function t(e,n){var r;_classCallCheck(this,t),n+="\n"+o(e);for(var i=arguments.length,s=Array(i>2?i-2:0),a=2;a<i;a++)s[a-2]=arguments[a];var u=_possibleConstructorReturn(this,(r=t.__proto__||Object.getPrototypeOf(t)).call.apply(r,[this,n].concat(s)));return u.validationErrors=e,u}return _inherits(t,i),t}();t.exports=s},{"../dependencies":8,"./extendableError":13}],13:[function(e,t,n){"use strict";var r=function(e){function t(e){var n;_classCallCheck(this,t);for(var r=arguments.length,i=Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];var s=_possibleConstructorReturn(this,(n=t.__proto__||Object.getPrototypeOf(t)).call.apply(n,[this,e].concat(i)));return s.constructor=_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"target",s),"function"==typeof Error.captureStackTrace?Error.captureStackTrace(s,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"target",s)):s.stack=new Error(e).stack,s}return _inherits(t,Error),t}();t.exports=r},{}],14:[function(e,t,n){"use strict";var r=e("../dependencies")._,i=e("./extendableError"),o=function(e){function t(e,n){var i;_classCallCheck(this,t),e+="[\n"+r(n).map(function(e,t){return!r.isNil(e)&&t+": "+e.message.replace(/\n/g,"\n\t")}).filter(r.identity).join(",\n")+"\n]";for(var o=arguments.length,s=Array(o>2?o-2:0),a=2;a<o;a++)s[a-2]=arguments[a];var u=_possibleConstructorReturn(this,(i=t.__proto__||Object.getPrototypeOf(t)).call.apply(i,[this,e].concat(s)));return u.validationErrors=n,u}return _inherits(t,i),t}();t.exports=o},{"../dependencies":8,"./extendableError":13}],15:[function(e,t,n){"use strict";var r=e("./dependencies"),i=r._,o=r.Promise,s=e("./entityFactory"),a=e("./diaspora"),u=e("./set"),c=s.entityPrototypeProperties,l=function(){function e(t,n){_classCallCheck(this,e);var r=i.intersection(c,i.keys(n.attributes));if(0!==r.length)throw new Error(JSON.stringify(r)+" is/are reserved property names. To match those column names in data source, please use the data source mapper property");if(!n.hasOwnProperty("sources")||!i.isArrayLike(n.sources)&&!i.isObject(n.sources))throw new TypeError("Expect model sources to be either an array or an object, had "+JSON.stringify(n.sources)+".");var o=i.isArrayLike(n.sources)?i.zipObject(n.sources,i.times(n.sources.length,i.constant({}))):i.mapValues(n.sources,function(e,t){if(!0===e)return{};if(i.isObject(e))return e;throw new TypeError('Datasource "'+t+'" value is invalid: expect `true` or a remap hash, but have '+JSON.stringify(e))}),u=i.keys(o),l=a.dataSources,f=i.pick(l,u),p=i.difference(u,i.keys(f));if(0!==p.length)throw new Error("Missing data sources "+p.map(function(e){return'"'+e+'"'}).join(", "));i.forEach(o,function(e,n){f[n].configureCollection(t,e)}),this.dataSources=f,this.defaultDataSource=u[0],this.name=t,this.entityFactory=s(t,n,this)}return _createClass(e,[{key:"getDataSource",value:function(e){if(i.isNil(e))e=this.defaultDataSource;else if(!this.dataSources.hasOwnProperty(e))throw new Error('Unknown data source "'+e+'" in model "'+this.name+'", available are '+i.keys(this.dataSources).map(function(e){return'"'+e+'"'}).join(", "));return this.dataSources[e]}},{key:"spawn",value:function(e){return new this.entityFactory(e)}},{key:"spawnMulti",value:function(e){var t=this;return new u(this,i.map(e,function(e){return t.spawn(e)}))}},{key:"insert",value:function(e,t){var n=this;return this.getDataSource(t).insertOne(this.name,e).then(function(e){return o.resolve(new n.entityFactory(e))})}},{key:"insertMany",value:function(e,t){var n=this;return this.getDataSource(t).insertMany(this.name,e).then(function(e){var t=i.map(e,function(e){return new n.entityFactory(e)}),r=new u(n,t);return o.resolve(r)})}},{key:"find",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];i.isString(n)&&i.isNil(r)?(r=n,n={}):i.isString(e)&&i.isNil(n)&&i.isNil(r)&&(r=e,e={},n={});var s=this.getDataSource(r);return s.findOne(this.name,e,n).then(function(e){if(i.isNil(e))return o.resolve();var n=new t.entityFactory(e);return n.dataSources[s.name]=e,o.resolve(n)})}},{key:"findMany",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments[2];return i.isString(n)&&i.isNil(r)?(r=n,n={}):i.isString(e)&&i.isNil(n)&&i.isNil(r)&&(r=e,e={},n={}),this.getDataSource(r).findMany(this.name,e,n).then(function(e){var n=i.map(e,function(e){return new t.entityFactory(e)}),r=new u(t,n);return o.resolve(r)})}},{key:"update",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments[3];return i.isString(r)&&i.isNil(s)&&(s=r,r={}),this.getDataSource(s).updateOne(this.name,e,t,r).then(function(e){if(i.isNil(e))return o.resolve();var t=new n.entityFactory(e);return o.resolve(t)})}},{key:"updateMany",value:function(e,t){var n=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s=arguments[3];return i.isString(r)&&i.isNil(s)&&(s=r,r={}),this.getDataSource(s).updateMany(this.name,e,t,r).then(function(e){var t=i.map(e,function(e){return new n.entityFactory(e)}),r=new u(n,t);return o.resolve(r)})}},{key:"delete",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];return i.isString(t)&&i.isNil(n)&&(n=t,t={}),this.getDataSource(n).deleteOne(this.name,e,t)}},{key:"deleteMany",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2];return i.isString(t)&&i.isNil(n)&&(n=t,t={}),this.getDataSource(n).deleteMany(this.name,e,t)}}]),e}();t.exports=l},{"./dependencies":8,"./diaspora":9,"./entityFactory":10,"./set":16}],16:[function(e,t,n){"use strict";var r=e("./dependencies"),i=r._,o=r.Promise,s=e("./utils"),a=e("./errors/setValidationError"),u=function(){function e(t){for(var n=arguments.length,r=Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];_classCallCheck(this,e),r=i(r).flatten(),e.checkEntitiesFromModel(r.value(),t);var a=s.defineEnumerableProperties(this,{entities:r,model:t,length:{get:function(){return this.entities.size()}}});return new Proxy(a,{get:function(e,t){return t in e?e[t]:t in e.entities?e.entities[t]:"string"==typeof t&&t.match(/^-?\d+$/)&&e.entities.nth(parseInt(t))?e.entities.nth(parseInt(t)):void 0},set:function(t,n,r){if("model"===n)return new Error('Can\'t assign to read-only property "model".');"entities"===n&&(e.checkEntitiesFromModel(r,t.model),t.entities=i(r))}})}return _createClass(e,[{key:"persist",value:function(e){var t=this,n=this.entities.map(function(e){return"orphan"===e.state?"Create":"Update"}).value();return o.all(this.entities.map(function(e){return e.emit("beforePersist")})).then(function(){return o.all(t.entities.map(function(e){return e.emit("beforeValidate")}))}).then(function(){var e=0,n=t.entities.map(function(t){try{return void t.validate()}catch(t){return e++,t}}).value();return e>0?o.reject(new a("Set validation failed for "+e+" elements (on "+t.length+"): ",n)):o.resolve()}).then(function(){return o.all(t.entities.map(function(e){return e.emit("afterValidate")}))}).then(function(){return o.all(t.entities.map(function(e,t){return e.emit("beforePersist"+n[t])}))}).then(function(){return o.all(t.entities.map(function(t){return t.persist(e,{skipEvents:!0})}))}).then(function(){return o.all(t.entities.map(function(e,t){return e.emit("afterPersist"+n[t])}))}).then(function(){return o.all(t.entities.map(function(e){return e.emit("afterPersist")}))}).then(function(){return t})}},{key:"fetch",value:function(e){var t=this;return o.all(this.entities.map(function(e){return e.emit("beforeFetch")})).then(function(){return o.all(t.entities.map(function(t){return t.fetch(e,{skipEvents:!0})}))}).then(function(){return o.all(t.entities.map(function(e){return e.emit("afterFetch")}))}).then(function(){return t})}},{key:"destroy",value:function(e){var t=this;return o.all(this.entities.map(function(e){return e.emit("beforeDestroy")})).then(function(){return o.all(t.entities.map(function(t){return t.destroy(e,{skipEvents:!0})}))}).then(function(){return o.all(t.entities.map(function(e){return e.emit("afterDestroy")}))}).then(function(){return t})}},{key:"update",value:function(e){return this.entities.forEach(function(t){i.forEach(e,function(e,n){i.isUndefined(e)?delete t[n]:t[n]=e})}),this}}],[{key:"checkEntitiesFromModel",value:function(e,t){e.forEach(function(e,n){if(e.constructor.model!==t)throw new TypeError("Provided entity n°"+n+" "+e+" is not from model "+t+" ("+t.modelName+")")})}}]),e}();t.exports=u},{"./dependencies":8,"./errors/setValidationError":14,"./utils":17}],17:[function(e,t,n){"use strict";var r=e("./dependencies")._;t.exports={defineEnumerableProperties:function(e,t){var n=r.mapValues(t,function(e){(r.isNil(e)||"object"!==(void 0===e?"undefined":_typeof(e))||Object.getPrototypeOf(e)!==Object.prototype)&&(e={value:e});var t={enumerable:!0};return e.hasOwnProperty("get")||(t.writable=!1),r.defaults(e,t),e});return Object.defineProperties(e,n)}}},{"./dependencies":8}],18:[function(e,t,n){function r(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(f===setTimeout)return setTimeout(e,0);if((f===r||!f)&&setTimeout)return f=setTimeout,setTimeout(e,0);try{return f(e,0)}catch(t){try{return f.call(null,e,0)}catch(t){return f.call(this,e,0)}}}function s(e){if(p===clearTimeout)return clearTimeout(e);if((p===i||!p)&&clearTimeout)return p=clearTimeout,clearTimeout(e);try{return p(e)}catch(t){try{return p.call(null,e)}catch(t){return p.call(this,e)}}}function a(){v&&h&&(v=!1,h.length?y=h.concat(y):m=-1,y.length&&u())}function u(){if(!v){var e=o(a);v=!0;for(var t=y.length;t;){for(h=y,y=[];++m<t;)h&&h[m].run();m=-1,t=y.length}h=null,v=!1,s(e)}}function c(e,t){this.fun=e,this.array=t}function l(){}var f,p,d=t.exports={};!function(){try{f="function"==typeof setTimeout?setTimeout:r}catch(e){f=r}try{p="function"==typeof clearTimeout?clearTimeout:i}catch(e){p=i}}();var h,y=[],v=!1,m=-1;d.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];y.push(new c(e,t)),1!==y.length||v||o(u)},c.prototype.run=function(){this.fun.apply(null,this.array)},d.title="browser",d.browser=!0,d.env={},d.argv=[],d.version="",d.versions={},d.on=l,d.addListener=l,d.once=l,d.off=l,d.removeListener=l,d.removeAllListeners=l,d.emit=l,d.prependListener=l,d.prependOnceListener=l,d.listeners=function(e){return[]},d.binding=function(e){throw new Error("process.binding is not supported")},d.cwd=function(){return"/"},d.chdir=function(e){throw new Error("process.chdir is not supported")},d.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=diaspora.min.js.map