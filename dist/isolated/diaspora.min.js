/**
* @file diaspora
*
* Multi-Layer ORM for Javascript Client+Server
* Isolated build compiled on 2017-12-23 00:18:45
*
* @license GPL-3.0
* @version 0.2.0-rc.5
* @author Gerkin
*/
!function(t,e){if("function"==typeof define&&define.amd)define(["core-js/modules/es6.regexp.replace","core-js/modules/es6.symbol","core-js/modules/es6.regexp.split","regenerator-runtime/runtime","core-js/modules/es7.array.includes","core-js/modules/es6.string.includes","core-js/modules/es6.function.name","core-js/modules/es6.promise","core-js/modules/es6.regexp.match","core-js/modules/es6.string.ends-with","core-js/modules/es6.array.find"],e);else if("undefined"!=typeof exports)e(require("core-js/modules/es6.regexp.replace"),require("core-js/modules/es6.symbol"),require("core-js/modules/es6.regexp.split"),require("regenerator-runtime/runtime"),require("core-js/modules/es7.array.includes"),require("core-js/modules/es6.string.includes"),require("core-js/modules/es6.function.name"),require("core-js/modules/es6.promise"),require("core-js/modules/es6.regexp.match"),require("core-js/modules/es6.string.ends-with"),require("core-js/modules/es6.array.find"));else{e(t.es6Regexp,t.es6,t.es6Regexp,t.runtime,t.es7Array,t.es6String,t.es6Function,t.es6,t.es6Regexp,t.es6String,t.es6Array),t.diaspora={}}}(this,function(t,e,r,n,i,o,s,a,u,c,l){"use strict";function f(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function p(t,e,r){return e&&f(t.prototype,e),r&&f(t,r),t}function d(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function h(t){return function(){var e=this,r=arguments;return new Promise(function(n,i){function o(t,e){try{var r=u[t](e),o=r.value}catch(t){return void i(t)}r.done?n(o):Promise.resolve(o).then(s,a)}function s(t){o("next",t)}function a(t){o("throw",t)}var u=t.apply(e,r);s()})}}function y(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).Diaspora=t()}}(function(){return function t(e,r,n){function i(s,a){if(!r[s]){if(!e[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[s]={exports:{}};e[s][0].call(l.exports,function(t){var r=e[s][1][t];return i(r||t)},l,l.exports,t,e,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(t,e,r){(function(r){if(r.browser)t("regenerator-runtime/runtime");else{var n=t("lodash"),i=n.find(t.cache,function(e,r){return r.endsWith(t("path").sep+"diaspora.js")});if(!n.isEmpty(n.get(i,"exports")))return console.log("Retrieving loaded diaspora"),e.exports=i.exports}var o=t("./lib/diaspora");e.exports=o}).call(this,t("_process"))},{"./lib/diaspora":12,_process:24,lodash:void 0,path:23,"regenerator-runtime/runtime":25}],2:[function(t,e,r){var n=t("../../dependencies")._,i=function(t,e,r){return"∞"===r?"-"===e?-1/0:1/0:parseInt(t)},o={type:{int:function(t,e){if(n.isString(e)&&(e=parseInt(e)),!n.isInteger(e)&&isFinite(e))throw new TypeError('Expect "'+t+'" to be an integer');return e}},rng:function(t,e,r){var n=r.match(/^([[\]])((-)?(\d+|∞)),((-)?(\d+|∞))([[\]])$/);if(n){var o=i.apply(void 0,n.splice(2,3)),s=i.apply(void 0,n.splice(2,3)),a="["===n[1]?e>=o:e>o,u="]"===n[2]?e<=s:e<s;if(!a||!u)throw new RangeError('Expect "'+t+'" to be within '+r+', have "'+e+'"')}return e}},s=function(t,e,r){return o.type[r.type]&&(e=o.type[r.type](t,e)),r.rng&&(e=o.rng(t,e,r.rng)),e};e.exports={OPERATORS:{$exists:function(t,e){return e===!n.isUndefined(t)},$equal:function(t,e){return!n.isUndefined(t)&&t===e},$diff:function(t,e){return!n.isUndefined(t)&&t!==e},$less:function(t,e){return!n.isUndefined(t)&&t<e},$lessEqual:function(t,e){return!n.isUndefined(t)&&t<=e},$greater:function(t,e){return!n.isUndefined(t)&&t>e},$greaterEqual:function(t,e){return!n.isUndefined(t)&&t>=e}},CANONICAL_OPERATORS:{"~":"$exists","==":"$equal","!=":"$diff","<":"$less","<=":"$lessEqual",">":"$greater",">=":"$greaterEqual"},QUERY_OPTIONS_TRANSFORMS:{limit:function(t){t.limit=s("limit",t.limit,{type:"int",rng:"[0,∞]"})},skip:function(t){t.skip=s("skip",t.skip,{type:"int",rng:"[0,∞["})},page:function(t){if(!t.hasOwnProperty("limit"))throw new ReferenceError('Usage of "options.page" requires "options.limit" to be defined.');if(!isFinite(t.limit))throw new RangeError('Usage of "options.page" requires "options.limit" to not be infinite');if(t.hasOwnProperty("skip"))throw new ReferenceError('Use either "options.page" or "options.skip"');t.skip=s("page",t.page,{type:"int",rng:"[0,∞["})*t.limit,delete t.page}},iterateLimit:function(t,e){var r=[],i=0,o=t.skip;return function s(a){return n.isNil(a)?Promise.resolve(r):(!0!==a&&r.push(a),i===t.limit?Promise.resolve(r):(t.skip=o+i,i++,e(t).then(s)))}},remapIO:function(t,e,r,i){if(n.isNil(r))return r;var o=!0===i?"input":"output",s=n.mapValues(r,function(r,i){var s=n.get(t,["filters",e,o,i],void 0);return n.isFunction(s)?s(r):r}),a=!0===i?"normal":"inverted";return n.mapKeys(s,function(r,i){return n.get(t,["remaps",e,a,i],i)})}}},{"../../dependencies":11}],3:[function(t,e,r){var n=t("../../dependencies"),i=n._,o=n.Promise,s=n.SequentialEvent,a=t("./adapter-utils"),u=a.OPERATORS,c=a.CANONICAL_OPERATORS,l=a.QUERY_OPTIONS_TRANSFORMS,f=a.iterateLimit,p=a.remapIO,d=function(t){function e(e){var r;return r=t.call(this)||this,r.state="preparing",r.remaps={},r.remapsInverted={},r.filters={},r.classEntity=e,r.error=void 0,r.on("ready",function(){r.state="ready"}).on("error",function(t){r.state="error",r.error=t}),r}y(e,t);var r=e.prototype;return r.configureCollection=function(t,e,r){void 0===r&&(r={}),this.remaps[t]={normal:e,inverted:i.invert(e)},this.filters[t]=r},r.waitReady=function(){var t=this;return new o(function(e,r){return"ready"===t.state?e(t):"error"===t.state?r(t.error):void t.on("ready",function(){return e(t)}).on("error",function(t){return r(t)})})},r.maybeCastEntity=function(t){return i.isNil(t)?void 0:new this.classEntity(t,this)},r.maybeCastSet=function(t){return i.isNil(t)?[]:i.map(t,this.maybeCastEntity.bind(this))},r.remapInput=function(t,e){return p(this,t,e,!0)},r.remapOutput=function(t,e){return p(this,t,e,!1)},r.setIdHash=function(t,e){var r;return void 0===e&&(e="id"),t.idHash=i.assign({},t.idHash,(r={},r[this.name]=t[e],r)),t},r.matchEntity=function(t,e){return i.every(i.toPairs(t),function(t){var r=t[0],n=t[1];if(i.isObject(n)){var o=e[r];return i.every(n,function(t,e){return!!u.hasOwnProperty(e)&&u[e](o,t)})}return!1})},r.normalizeOptions=function(t){return void 0===t&&(t={}),t=i.cloneDeep(t),i.forEach(l,function(e,r){t.hasOwnProperty(r)&&l[r](t)}),i.defaults(t,{skip:0,remapInput:!0,remapOutput:!0}),t},r.normalizeQuery=function(t,e){i.isString(t)&&(t={id:t});return!0===e.remapInput?i(i.cloneDeep(t)).mapValues(function(t){return i.isUndefined(t)?{$exists:!1}:t instanceof Object?(t=i.mapKeys(t,function(t,e,r){if(c.hasOwnProperty(e)){if(r.hasOwnProperty(c[e]))throw new Error("Search can't have both \""+e+'" and "'+c[e]+'" keys, as they are synonyms');return c[e]}return e}),i.forEach(["$less","$lessEqual","$greater","$greaterEqual"],function(e){if(t.hasOwnProperty(e)&&!i.isNumber(t[e])&&!i.isDate(t[e]))throw new TypeError('Expect "'+e+'" in '+JSON.stringify(t)+" to be a numeric value")}),t):{$equal:t}}).value():i.cloneDeep(t)},r.toJSON=function(){return i.pick(this,["state","remaps","remapsInverted","classEntity","error"])},r.insertOne=function(t,e){return this.insertMany(t,[e]).then(function(t){return o.resolve(i.first(t))})},r.insertMany=function(t,e){var r=this;return o.mapSeries(e,function(e){return r.insertOne(t,e||{})})},r.findOne=function(t,e,r){return void 0===r&&(r={}),r.limit=1,this.findMany(t,e,r).then(function(t){return o.resolve(i.first(t))})},r.findMany=function(t,e,r){return void 0===r&&(r={}),r=this.normalizeOptions(r),f(r,this.findOne.bind(this,t,e))(!0)},r.updateOne=function(t,e,r,n){return void 0===n&&(n={}),n=this.normalizeOptions(n),n.limit=1,this.updateMany(t,e,r,n).then(function(t){return o.resolve(i.first(t))})},r.updateMany=function(t,e,r,n){return void 0===n&&(n={}),n=this.normalizeOptions(n),f(n,this.updateOne.bind(this,t,e,r))(!0)},r.deleteOne=function(t,e,r){return void 0===r&&(r={}),r.limit=1,this.deleteMany(t,e,r)},r.deleteMany=function(t,e,r){var n=this;void 0===r&&(r={});var s=0;return function a(){return n.findOne(t,e,r).then(function(u){return i.isNil(u)?o.resolve():s===r.limit?o.resolve():(s++,n.deleteOne(t,e,r).then(a))})}()},e}(s);e.exports=d},{"../../dependencies":11,"./adapter-utils":2}],4:[function(t,e,r){var n=t("../../dependencies")._,i=function(){function t(t,e){if(!n.isNil(t)){if(n.isNil(e))throw new TypeError('Expect 2nd argument to be the parent of this entity, have "'+e+'"');Object.defineProperties(this,{dataSource:{value:e,enumerable:!1,configurable:!1}}),n.assign(this,t)}}return t.prototype.toObject=function(){return n.omit(this,["dataSource","id"])},t}();e.exports=i},{"../../dependencies":11}],5:[function(t,e,r){var n=t("../../dependencies"),i=n._,o=n.Promise,s=t("../../utils"),a=t("../../diaspora").components.Adapters.Adapter,u=t("./entity.js"),c=function(t){function e(){var e;return e=t.call(this,u)||this,e.state="ready",e.store={},e}y(e,t);var r=e.prototype;return r.configureCollection=function(e,r){t.prototype.configureCollection.call(this,e,r),this.ensureCollectionExists(e)},r.ensureCollectionExists=function(t){return this.store.hasOwnProperty(t)?this.store[t]:this.store[t]={items:[]}},r.insertOne=function(t,e){e=i.cloneDeep(e);var r=this.ensureCollectionExists(t);return e.id=s.generateUUID(),this.setIdHash(e),r.items.push(e),o.resolve(new this.classEntity(e,this))},r.findOne=function(t,e,r){void 0===r&&(r={});var n=this.ensureCollectionExists(t),a=i.filter(n.items,i.partial(this.matchEntity,e)),u=s.applyOptionsToSet(a,r);return o.resolve(this.maybeCastEntity(i.first(u)))},r.findMany=function(t,e,r){void 0===r&&(r={});var n=this.ensureCollectionExists(t),a=i.filter(n.items,i.partial(this.matchEntity,e)),u=s.applyOptionsToSet(a,r);return o.resolve(this.maybeCastSet(u))},r.updateOne=function(t,e,r,n){var a=this;return void 0===n&&(n={}),this.findOne(t,e,n).then(function(e){if(i.isNil(e))return o.resolve();var n=a.ensureCollectionExists(t),u=i.find(n.items,{id:e.id});return s.applyUpdateEntity(r,u),o.resolve(a.maybeCastEntity(u))})},r.updateMany=function(t,e,r,n){var a=this;return void 0===n&&(n={}),this.findMany(t,e,n).then(function(e){if(!i.isNil(e)&&e.length>0){var n=a.ensureCollectionExists(t),u=i.map(e,"id"),c=i.filter(n.items,function(t){return-1!==u.indexOf(t.id)});return o.resolve(a.maybeCastSet(i.map(c,function(t){return s.applyUpdateEntity(r,t),t})))}return o.resolve([])})},r.deleteOne=function(t,e,r){var n=this;void 0===r&&(r={});var s=this.ensureCollectionExists(t);return this.findOne(t,e,r).then(function(t){return i.isNil(t)||(s.items=i.reject(s.items,function(e){return e.id===t.idHash[n.name]})),o.resolve()})},r.deleteMany=function(t,e,r){var n=this;void 0===r&&(r={});var s=this.ensureCollectionExists(t);return this.findMany(t,e,r).then(function(t){var e=i.map(t,function(t){return i.get(t,"idHash."+n.name)});return s.items=i.reject(s.items,function(t){return i.includes(e,t.id)}),o.resolve()})},e}(a);e.exports=c},{"../../dependencies":11,"../../diaspora":12,"../../utils":21,"./entity.js":6}],6:[function(t,e,r){var n=function(t){function e(e,r){return t.call(this,e,r)||this}return y(e,t),e}(t("../base/entity.js"));e.exports=n},{"../base/entity.js":4}],7:[function(t,e,r){(function(r){var n=t("../../dependencies"),i=n._,o=n.Promise,s=t("../../diaspora").components.Adapters.Adapter,a=t("./entity.js"),u=function(t){return i(t).chain(i.cloneDeep).omitBy(function(t){return i.isObject(t)&&i.isEmpty(t)}).mapValues(JSON.stringify).toPairs().map(i.partial(i.map,i,encodeURIComponent)).map(function(t){return t[0]+"="+t[1]}).join("&").value()},c={400:function(t){return new Error('Posted data through HTTP is invalid; message "'+t.response.message+'"')},_:function(t){return new Error("Unhandled HTTP error with status code "+t.status+' & message "'+t.response.message+'"')}},l=function(t,e,r){t.onload=function(){return i.inRange(t.status,200,299)?e(t.response):r(i.get(c,t.status,c._)(t))},t.onerror=function(){return r(c._(t))}},f=function(){var e=h(regeneratorRuntime.mark(function e(n,s,a,c){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r.browser){e.next=7;break}return i.isNil(a)&&(a=!0),e.next=4,t("request-promise")[n.toLowerCase()](s,{json:a,qs:i.mapValues(c,JSON.stringify)});case 4:return e.abrupt("return",e.sent);case 7:return e.abrupt("return",new o(function(t,e){var r=new XMLHttpRequest;l(r,t,e);var o=u(c);r.responseType="json",r.open(n,s+(o?"?"+o:"")),r.setRequestHeader("Content-Type","application/json"),r.send(i.isNil(a)?void 0:JSON.stringify(a))}));case 8:case"end":return e.stop()}},e,this)}));return function(t,r,n,i){return e.apply(this,arguments)}}(),p=function(t,e){return 0===e.skip&&delete e.skip,i.assign({},i.omit(e,["remapInput","remapOutput"]),{where:t})},d=function(t,e){return i.isEmpty(t)||(t=i.map(t,i.unary(e.setIdHash.bind(e)))),t},m=function(t){if(!r.browser&&!i.isString(t.host))throw new Error('"config.host" is not defined, or is not a string: had "'+t.host+'"');if(!r.browser&&!i.isString(t.scheme))throw new Error('"config.scheme" is not defined, or is not a string: had "'+t.scheme+'"')},v=function(t){function e(e){var n;if(void 0===e&&(e={}),n=t.call(this,a)||this,i.defaults(e,{scheme:!1,host:!1,port:!1,path:"",pluralApis:{}}),m(e),r.browser&&!1===e.host)n.baseEndPoint=e.path;else{var o=e.port?":"+e.port:"",s=e.scheme?e.scheme+":":"";n.baseEndPoint=s+"//"+e.host+o+e.path}return n.state="ready",n.pluralApis=e.pluralApis,n}y(e,t);var n=e.prototype;return n.httpQuery=function(t,e,r,n){return f(t,this.baseEndPoint+"/"+e.toLowerCase(),r,n)},n.getPluralEndpoint=function(t){return this.pluralApis.hasOwnProperty(t)?this.pluralApis[t]:t+"s"},n.insertOne=function(){var t=h(regeneratorRuntime.mark(function t(e,r){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.httpQuery("POST",e,r);case 2:return r=t.sent,i.isNil(r)||this.setIdHash(r),t.abrupt("return",this.maybeCastEntity(r));case 5:case"end":return t.stop()}},t,this)}));return function(e,r){return t.apply(this,arguments)}}(),n.insertMany=function(){var t=h(regeneratorRuntime.mark(function t(e,r){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.httpQuery("POST",this.getPluralEndpoint(e),r);case 2:return r=t.sent,r=d(r,this),t.abrupt("return",this.maybeCastSet(r));case 5:case"end":return t.stop()}},t,this)}));return function(e,r){return t.apply(this,arguments)}}(),n.findOne=function(){var t=h(regeneratorRuntime.mark(function t(e,r,n){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===n&&(n={}),t.next=3,this.httpQuery("GET",e,null,p(r,n));case 3:return o=t.sent,i.isNil(o)||this.setIdHash(o),t.abrupt("return",this.maybeCastEntity(o));case 6:case"end":return t.stop()}},t,this)}));return function(e,r,n){return t.apply(this,arguments)}}(),n.findMany=function(){var t=h(regeneratorRuntime.mark(function t(e,r,n){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===n&&(n={}),t.next=3,this.httpQuery("GET",this.getPluralEndpoint(e),null,p(r,n));case 3:return i=t.sent,i=d(i,this),t.abrupt("return",this.maybeCastSet(i));case 6:case"end":return t.stop()}},t,this)}));return function(e,r,n){return t.apply(this,arguments)}}(),n.updateOne=function(){var t=h(regeneratorRuntime.mark(function t(e,r,n,o){var s,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===o&&(o={}),t.next=3,this.httpQuery("PATCH",e,n,p(r,o));case 3:return s=t.sent,i.isNil(s)||(s.idHash=(a={},a[this.name]=s.id,a)),t.abrupt("return",this.maybeCastEntity(s));case 6:case"end":return t.stop()}},t,this)}));return function(e,r,n,i){return t.apply(this,arguments)}}(),n.updateMany=function(){var t=h(regeneratorRuntime.mark(function t(e,r,n,i){var o;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===i&&(i={}),t.next=3,this.httpQuery("PATCH",this.getPluralEndpoint(e),n,p(r,i));case 3:return o=t.sent,o=d(o,this),t.abrupt("return",this.maybeCastSet(o));case 6:case"end":return t.stop()}},t,this)}));return function(e,r,n,i){return t.apply(this,arguments)}}(),n.deleteOne=function(){var t=h(regeneratorRuntime.mark(function t(e,r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===n&&(n={}),t.next=3,this.httpQuery("DELETE",e,null,p(r,n));case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}));return function(e,r,n){return t.apply(this,arguments)}}(),n.deleteMany=function(){var t=h(regeneratorRuntime.mark(function t(e,r,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return void 0===n&&(n={}),t.next=3,this.httpQuery("DELETE",this.getPluralEndpoint(e),null,p(r,n));case 3:return t.abrupt("return",t.sent);case 4:case"end":return t.stop()}},t,this)}));return function(e,r,n){return t.apply(this,arguments)}}(),e}(s);e.exports=v}).call(this,t("_process"))},{"../../dependencies":11,"../../diaspora":12,"./entity.js":8,_process:24,"request-promise":void 0}],8:[function(t,e,r){var n=function(t){function e(e,r){return t.call(this,e,r)||this}return y(e,t),e}(t("../base/entity.js"));e.exports=n},{"../base/entity.js":4}],9:[function(t,e,r){(function(r){var n=t("../../dependencies"),i=n._,o=n.Promise,s=t("../../utils"),a=t("../../diaspora").components.Adapters.Adapter,u=t("./entity"),c=function(t){function e(e){var n;return n=t.call(this,u)||this,i.defaults(e,{session:!1}),n.state="ready",n.source=!0===e.session?r.sessionStorage:r.localStorage,n}y(e,t);var n=e.prototype;return n.configureCollection=function(e,r){t.prototype.configureCollection.call(this,e,r),this.ensureCollectionExists(e)},n.ensureCollectionExists=function(t){var e=this.source.getItem(t);return i.isNil(e)?(e=[],this.source.setItem(t,JSON.stringify(e))):e=JSON.parse(e),e},n.getItemName=function(t,e){return t+".id="+e},n.insertOne=function(t,e){(e=i.cloneDeep(e||{})).id=s.generateUUID(),this.setIdHash(e);try{var r=this.ensureCollectionExists(t);r.push(e.id),this.source.setItem(t,JSON.stringify(r)),this.source.setItem(this.getItemName(t,e.id),JSON.stringify(e))}catch(t){return o.reject(t)}return o.resolve(this.maybeCastEntity(e))},n.insertMany=function(t,e){var r=this;e=i.cloneDeep(e);try{var n=this.ensureCollectionExists(t);e=e.map(function(e){return void 0===e&&(e={}),e.id=s.generateUUID(),r.setIdHash(e),n.push(e.id),r.source.setItem(r.getItemName(t,e.id),JSON.stringify(e)),new r.classEntity(e,r)}),this.source.setItem(t,JSON.stringify(n))}catch(t){return o.reject(t)}return o.resolve(this.maybeCastSet(e))},n.findOneById=function(t,e){var r=this.source.getItem(this.getItemName(t,e));return i.isNil(r)||(r=JSON.parse(r)),o.resolve(this.maybeCastEntity(r))},n.findOne=function(t,e,r){var n=this;if(void 0===r&&(r={}),i.defaults(r,{skip:0}),!i.isObject(e))return this.findOneById(t,e);if(i.isEqual(i.keys(e),["id"])&&i.isEqual(i.keys(e.id),["$equal"]))return this.findOneById(t,e.id.$equal);var s,a=this.ensureCollectionExists(t),u=0;return i.each(a,function(i){var o=JSON.parse(n.source.getItem(n.getItemName(t,i)));if(n.matchEntity(e,o)&&++u>r.skip)return s=o,!1}),o.resolve(this.maybeCastEntity(s))},n.updateOne=function(t,e,r,n){var a=this;return i.defaults(n,{skip:0}),this.findOne(t,e,n).then(function(e){if(i.isNil(e))return o.resolve();s.applyUpdateEntity(r,e);try{return a.source.setItem(a.getItemName(t,e.id),JSON.stringify(e)),o.resolve(e)}catch(t){return o.reject(t)}})},n.deleteOne=function(t,e,r){var n=this;return void 0===r&&(r={}),this.findOne(t,e,r).then(function(e){try{var r=n.ensureCollectionExists(t);i.pull(r,e.id),n.source.setItem(t,JSON.stringify(r)),n.source.removeItem(n.getItemName(t,e.id))}catch(t){return o.reject(t)}return o.resolve()})},n.deleteMany=function(t,e,r){var n=this;void 0===r&&(r={});try{return this.findMany(t,e,r).then(function(e){var r=n.ensureCollectionExists(t);return i.pullAll(r,i.map(e,"id")),n.source.setItem(t,JSON.stringify(r)),i.forEach(e,function(e){n.source.removeItem(n.getItemName(t,e.id))}),o.resolve()})}catch(t){return o.reject(t)}},e}(a);e.exports=c}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../dependencies":11,"../../diaspora":12,"../../utils":21,"./entity":10}],10:[function(t,e,r){var n=function(t){function e(e,r){return t.call(this,e,r)||this}return y(e,t),e}(t("../base/entity.js"));e.exports=n},{"../base/entity.js":4}],11:[function(t,e,r){(function(r){e.exports={_:r._||t("lodash"),SequentialEvent:r.SequentialEvent||t("sequential-event"),Promise:r.Promise&&r.Promise.version?r.Promise:t("bluebird")}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{bluebird:void 0,lodash:void 0,"sequential-event":void 0}],12:[function(t,e,r){(function(r){var n=t("./dependencies"),i=n._,o=n.Promise,s=function(){if(r.browser)return console;var e=t("winston"),n=e.createLogger({level:"silly",format:e.format.json(),transports:[]});return"production"!==r.env.NODE_ENV&&n.add(new e.transports.Console({format:e.format.simple()})),n}(),a={},u={},c={},l=function(t,e,r){return function(n){var s=!1,a=!1;["find","delete"].indexOf(e.query)>=0?s=1:"update"===e.query&&(s=2,a=!0);for(var u=arguments.length,c=new Array(u>1?u-1:0),l=1;l<u;l++)c[l-1]=arguments[l];try{!1!==s&&(c[s]=r.normalizeOptions(c[s]),c[0]=r.normalizeQuery(c[0],c[s])),function(t,e,r,n,o){!1!==e?(!0===t[e].remapInput&&(t[0]=o(t[0]),!0===r&&(t[1]=o(t[1]))),t[e].remapInput=!1):"insert"===n.query&&("many"===n.number?t[0]=i.map(t[0],function(t){return o(t)}):t[0]=o(t[0]))}(c,s,a,e,function(t,e){return function(r){return t.remapInput(e,r)}}(r,n))}catch(t){return o.reject(t)}return t.call.apply(t,[r,n].concat(c)).then(function(t,e){var r=function(r){return(r=t.remapOutput(e,r))instanceof t.classEntity||i.isNil(r)?r:new t.classEntity(r,t)};return function(t){return i.isNil(t)?o.resolve():i.isArrayLike(t)?o.resolve(i.map(t,r)):o.resolve(r(t))}}(r,n))}},f={NON_EMPTY_STR:i.template('<%= c %> <%= p %> must be a non empty string, had "<%= v %>"')},p=function(t,e){if(!i.isString(e)&&e.length>0)throw new Error(f.NON_EMPTY_STR({c:t,p:"name",v:e}))},d={namedFunctions:{Diaspora:{"Date.now()":function(){return new Date}}},default:function(t,e){var r=this;return i.defaults(t,i.mapValues(e,function(e,n){return r.defaultField(t[n],e)}))},defaultField:function(t,e){var r;return r=i.isUndefined(t)?i.isFunction(e.default)?e.default():function(t){if(i.isString(t)&&t.match(/^(.+?)(?:::(.+?))+$/)){var e=t.split("::"),r=i.get(d.namedFunctions,e);if(i.isFunction(r))return r()}return t}(e.default):t,"object"===e.type&&i.isObject(e.attributes)&&i.keys(e.attributes).length>0&&!i.isNil(r)?this.default(r,e.attributes):r},createDataSource:function(e,r){if(!a.hasOwnProperty(e))try{t("diaspora-"+e)}catch(t){throw new Error('Unknown adapter "'+e+'". Available currently are '+Object.keys(a).join(", ")+". Additionnaly, an error was thrown: "+t)}var n=new a[e](r);return new Proxy(n,{get:function(t,e){if(i.isString(e)){var r=e.match(/^(find|update|insert|delete)(Many|One)$/);if(null!==r)return r[2]=r[2].toLowerCase(),r=i.mapKeys(r.slice(0,3),function(t,e){return["full","query","number"][e]}),l(t[e],r,t)}return t[e]}})},registerDataSource:function(t,e){var r;if(p("DataSource",t),u.hasOwnProperty(t))throw new Error('DataSource name already used, had "'+t+'"');return e.name=t,i.merge(u,(r={},r[t]=e,r)),e},createNamedDataSource:function(t,e,r){var n=d.createDataSource(e,r);return d.registerDataSource(t,n)},declareModel:function(t,e){var r;if(!i.isString(t)&&t.length>0&&p("Model",t),!i.isObject(e))throw new Error('"modelDesc" must be an object');var n=new d.components.Model(t,e);return i.assign(c,(r={},r[t]=n,r)),n},registerAdapter:function(t,e){if(a.hasOwnProperty(t))throw new Error('Adapter with label "'+t+'" already exists.');a[t]=e},models:c,dataSources:u,adapters:a,dependencies:n,logger:s};e.exports=d,d.components={Errors:{ExtendableError:t("./errors/extendableError"),ValidationError:t("./errors/validationError"),EntityValidationError:t("./errors/entityValidationError"),SetValidationError:t("./errors/setValidationError"),EntityStateError:t("./errors/entityStateError")}},i.assign(d.components,{Adapters:{Adapter:t("./adapters/base/adapter"),Entity:t("./adapters/base/entity")}}),i.assign(d.components,{Model:t("./model"),EntityFactory:t("./entityFactory"),Entity:t("./entityFactory").Entity,Set:t("./set"),Validator:t("./validator"),Utils:t("./utils")}),d.registerAdapter("inMemory",t("./adapters/inMemory/adapter")),d.registerAdapter("webApi",t("./adapters/webApi/adapter")),r.browser&&d.registerAdapter("webStorage",t("./adapters/webStorage/adapter"))}).call(this,t("_process"))},{"./adapters/base/adapter":3,"./adapters/base/entity":4,"./adapters/inMemory/adapter":5,"./adapters/webApi/adapter":7,"./adapters/webStorage/adapter":9,"./dependencies":11,"./entityFactory":13,"./errors/entityStateError":14,"./errors/entityValidationError":15,"./errors/extendableError":16,"./errors/setValidationError":17,"./errors/validationError":18,"./model":19,"./set":20,"./utils":21,"./validator":22,_process:24,winston:void 0}],13:[function(t,e,r){var n=t("./dependencies"),i=n._,o=n.Promise,s=n.SequentialEvent,a=t("./diaspora"),u=a.components.Adapters.Entity,c=t("./errors/entityStateError"),l={skipEvents:!1},f=Symbol("PRIVATE"),h=function t(e,r,n,s){return s=i.castArray(s),r.skipEvents?o.resolve(e):e.emit.apply(e,[s[0]].concat(n)).then(function(){return s.length>1?t(e,r,n,i.slice(s,1)):o.resolve(e)})},m=function(t,e,r,n){return function(){return"orphan"===e?o.reject(new c("Can't fetch an orphan entity.")):(t[f].lastDataSource=r.name,r[n](t.table(r.name),t.uidQuery(r)))}},v={castTypes:function(t,e){var r=e.attributes;return i.forEach(t,function(e,n){var o=r[n];if(i.isObject(o))switch(o.type){case"date":(i.isString(e)||i.isInteger(e))&&(t[n]=new Date(e))}}),t},loadSource:function(t,e){if(e instanceof u){var r=t[f];i.assign(r,{state:"sync",lastDataSource:e.dataSource.name}),r.dataSources[r.lastDataSource]=e,e=t.deserialize(i.omit(e.toObject(),["id"]))}return e},bindLifecycleEvents:function(t,e){i.forEach(e.lifecycleEvents,function(e,r){i.forEach(i.castArray(e),function(e){t.on(r,e)})})}},g=function(t){function e(e,r,n,o){var s;void 0===o&&(o={});var u=i.keys(r.attributes);s=t.call(this)||this;var c={state:"orphan",lastDataSource:null,dataSources:Object.seal(i.mapValues(n.dataSources,function(){})),name:e,modelDesc:r,model:n};s[f]=c,o=v.castTypes(o,r),o=v.loadSource(d(s),o);var l=i.difference(o,u);if(0!==l.length)throw new Error("Source has unknown keys: "+JSON.stringify(l)+" in "+JSON.stringify(o));return c.attributes=a.default(i.cloneDeep(o),r.attributes),o=null,v.bindLifecycleEvents(d(s),r),s}y(e,t);var r=e.prototype;return r.uidQuery=function(t){return{id:this[f].attributes.idHash[t.name]}},r.table=function(){return this[f].name},r.validate=function(){this.constructor.model.validator.validate(this[f].attributes)},r.replaceAttributes=function(t){return void 0===t&&(t={}),t.idHash=this[f].attributes.idHash,this[f].attributes=t,this},r.getDiff=function(t){var e=this,r=this[f].dataSources[t.name].toObject(),n=i(this[f].attributes).keys().concat(i.keys(r)).uniq().difference(["idHash"]).value(),o=i.map(n,function(t){return e[f].attributes[t]});return i.omitBy(i.zipObject(n,o),function(t,n){return i.isEqual(e[f].attributes[n],r[n])})},r.toObject=function(){return this[f].attributes},r.serialize=function(t){return i.cloneDeep(t)},r.deserialize=function(t){return i.cloneDeep(t)},r.persist=function(t,e){var r=this;void 0===e&&(e={}),i.defaults(e,l);var n=this[f].state;this[f].state="syncing";var o=this.constructor.model.getDataSource(t),s=[o.name],a=i.partial(h,this,e,s),u="orphan"===n?"Create":"Update";return a(["beforePersist","beforeValidate"]).then(function(){return r.validate()}).then(function(){return a(["afterValidate","beforePersist"+u])}).then(function(){return r[f].lastDataSource=o.name,"orphan"===n?o.insertOne(r.table(t),r.toObject()):o.updateOne(r.table(t),r.uidQuery(o),r.getDiff(o))}).then(function(t){return v.castTypes(t,r[f].modelDesc),r[f].state="sync",r[f].attributes=t.toObject(),r[f].dataSources[o.name]=t,a(["afterPersist"+u,"afterPersist"])})},r.fetch=function(t,e){var r=this;void 0===e&&(e={}),i.defaults(e,l);var n=this[f].state;this[f].state="syncing";var o=this.constructor.model.getDataSource(t),s=[o.name,this.serialize(this[f].attributes)],a=i.partial(h,this,e,s);return a("beforeFetch").then(m(this,n,o,"findOne")).then(function(t){return v.castTypes(t,r[f].modelDesc),r[f].state="sync",r[f].attributes=t.toObject(),r[f].dataSources[o.name]=t,a("afterFetch")})},r.destroy=function(t,e){var r=this;void 0===e&&(e={}),i.defaults(e,l);var n=this[f].state;this[f].state="syncing";var o=this.constructor.model.getDataSource(t),s=[o.name],a=i.partial(h,this,e,s);return a("beforeDestroy").then(m(this,n,o,"deleteOne")).then(function(){return 0===i.without(r[f].model.dataSources,o.name).length?r[f].state="orphan":(r[f].state="sync",delete r[f].attributes.idHash[o.name]),r[f].dataSources[o.name]=void 0,a("afterDestroy")})},r.getId=function(t){var e=this.constructor.model.getDataSource(t);return this[f].dataSources[e.name].id},p(e,[{key:"dataSources",get:function(){return this[f].dataSources}},{key:"attributes",get:function(){return this[f].attributes}},{key:"state",get:function(){return this[f].state}},{key:"lastDataSource",get:function(){return this[f].lastDataSource}}]),e}(s),b=function(t,e,r){var n=function(e){function n(){return e.apply(this,arguments)||this}return y(n,e),p(n,null,[{key:"name",get:function(){return t+"Entity"}},{key:"model",get:function(){return r}}]),n}(g);return i.forEach(e.methods,function(t,e){n.prototype[e]=t}),i.forEach(e.staticMethods,function(t,e){n[t]=e}),n.bind(n,t,e,r)};b.Entity=g,e.exports=b},{"./dependencies":11,"./diaspora":12,"./errors/entityStateError":14}],14:[function(t,e,r){var n=function(t){function e(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return t.call.apply(t,[this].concat(r))||this}return y(e,t),e}(t("./extendableError"));e.exports=n},{"./extendableError":16}],15:[function(t,e,r){var n=t("../dependencies")._,i=function(t){return n(t).mapValues(function(t,e){return e+" => "+JSON.stringify(t.value)+"\n* "+n(t).omit(["value"]).values().map(n.identity).value()}).values().join("\n* ")},o=function(t){function e(e,r){var n;r+="\n"+i(e);for(var o=arguments.length,s=new Array(o>2?o-2:0),a=2;a<o;a++)s[a-2]=arguments[a];return n=t.call.apply(t,[this,r].concat(s))||this,n.validationErrors=e,n}return y(e,t),e}(t("./validationError"));e.exports=o},{"../dependencies":11,"./validationError":18}],16:[function(t,e,r){var n=function(t){function e(e){for(var r,n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return r=t.call.apply(t,[this,e].concat(i))||this,r.name=r.constructor.name,r.message=e,"function"==typeof Error.captureStackTrace?Error.captureStackTrace(d(r),r.constructor):r.stack=new Error(e).stack,r}return y(e,t),e}(function(t){function e(){t.apply(this,arguments)}return e.prototype=Object.create(t.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t,e}(Error));e.exports=n},{}],17:[function(t,e,r){var n=t("../dependencies")._,i=function(t){function e(e,r){var i;e+="[\n"+n(r).map(function(t,e){return!n.isNil(t)&&e+": "+t.message.replace(/\n/g,"\n\t")}).filter(n.identity).join(",\n")+"\n]";for(var o=arguments.length,s=new Array(o>2?o-2:0),a=2;a<o;a++)s[a-2]=arguments[a];return i=t.call.apply(t,[this,e].concat(s))||this,i.validationErrors=r,i}return y(e,t),e}(t("./validationError"));e.exports=i},{"../dependencies":11,"./validationError":18}],18:[function(t,e,r){var n=function(t){function e(){return t.apply(this,arguments)||this}return y(e,t),e}(t("./extendableError"));e.exports=n},{"./extendableError":16}],19:[function(t,e,r){var n=t("./dependencies"),i=n._,o=n.Promise,s=t("./entityFactory"),a=t("./diaspora"),u=t("./set"),c=t("./validator"),l=s.entityPrototypeProperties,f=function(t,e,r,n){void 0===e&&(e={}),void 0===r&&(r={});var o;return o=i.isString(r)&&i.isNil(n)?{dataSourceName:r,options:{}}:i.isString(e)&&i.isNil(r)&&i.isNil(n)?{dataSourceName:e,queryFind:{},options:{}}:{queryFind:e,options:r,dataSourceName:n},o.dataSource=t.getDataSource(o.dataSourceName),o},p=function(t){return function(e){var r=i.map(e,function(e){return new t.entityFactory(e)}),n=new u(t,r);return o.resolve(n)}},d=function(t,e){return function(r,n,i){void 0===r&&(r={}),void 0===n&&(n={});var o=f(e,r,n,i);return o.dataSource[t](e.name,o.queryFind,o.options)}},h=function(t,e,r,n,s,a){var u,c=f(t,r,n,s),l=i([t.name,c.queryFind]).push(a).push(c.options).compact().value();return(u=c.dataSource)[(a?"update":"find")+(e?"Many":"One")].apply(u,l).then((e?p:function(t){return function(e){if(i.isNil(e))return o.resolve();var r=new t.entityFactory(e);return o.resolve(r)}})(t))},y=function(t){var e=t.sources;if(i.isString(e)){var r;(r={})[t.sources]=!0,e=r}else e=i.isArrayLike(e)?i.zipObject(e,i.times(e.length,i.constant({}))):i.mapValues(e,function(t,e){if(!0===t)return{};if(i.isObject(t))return t;throw new TypeError('Datasource "'+e+'" value is invalid: expect `true` or a remap hash, but have '+JSON.stringify(t))});return e},m=function(){function t(t,e){var r=i.intersection(l,i.keys(e.attributes));if(0!==r.length)throw new Error(JSON.stringify(r)+" is/are reserved property names. To match those column names in data source, please use the data source mapper property");if(!e.hasOwnProperty("sources")||!(i.isArrayLike(e.sources)||i.isObject(e.sources)||i.isString(e.sources)))throw new TypeError("Expect model sources to be either a string, an array or an object, had "+JSON.stringify(e.sources)+".");var n=y(e),o=i.keys(n),u=i.pick(a.dataSources,o),f=i.difference(o,i.keys(u));if(0!==f.length)throw new Error("Missing data sources "+f.map(function(t){return'"'+t+'"'}).join(", "));if(!i.isObject(e.attributes))throw new TypeError("Model attributes should be an object, have "+JSON.stringify(e.attributes));i.forEach(n,function(e,r){return u[r].configureCollection(t,e)}),i.assign(this,{dataSources:u,defaultDataSource:i(u).keys().first(),name:t,entityFactory:s(t,e,this),validator:new c(e.attributes)})}var e=t.prototype;return e.getDataSource=function(t){if(i.isNil(t))t=this.defaultDataSource;else if(!this.dataSources.hasOwnProperty(t))throw new Error('Unknown data source "'+t+'" in model "'+this.name+'", available are '+i.keys(this.dataSources).map(function(t){return'"'+t+'"'}).join(", "));return this.dataSources[t]},e.spawn=function(t){return new this.entityFactory(t)},e.spawnMany=function(t){var e=this;return new u(this,i.map(t,function(t){return e.spawn(t)}))},e.insert=function(t,e){var r=this;return this.getDataSource(e).insertOne(this.name,t).then(function(t){return o.resolve(new r.entityFactory(t))})},e.insertMany=function(t,e){return this.getDataSource(e).insertMany(this.name,t).then(p(this))},e.find=function(t,e,r){return h(this,!1,t,e,r)},e.findMany=function(t,e,r){return h(this,!0,t,e,r)},e.update=function(t,e,r,n){return void 0===r&&(r={}),h(this,!1,t,r,n,e)},e.updateMany=function(t,e,r,n){return void 0===r&&(r={}),h(this,!0,t,r,n,e)},e.delete=function(t,e,r){return void 0===e&&(e={}),d("deleteOne",this)(t,e,r)},e.deleteMany=function(t,e,r){return void 0===t&&(t={}),void 0===e&&(e={}),d("deleteMany",this)(t,e,r)},t}();e.exports=m},{"./dependencies":11,"./diaspora":12,"./entityFactory":13,"./set":20,"./validator":22}],20:[function(t,e,r){function n(t,e,r){return i.apply(this,arguments)}function i(){return(i=h(regeneratorRuntime.mark(function t(e,r,n){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return i=s.partial(f,this.entities,n),t.next=3,i("before");case 3:return t.next=5,a.all(this.entities.map(function(t){return t[r](e,{skipEvents:!0})}));case 5:return t.next=7,i("after");case 7:case"end":return t.stop()}},t,this)}))).apply(this,arguments)}var o=t("./dependencies"),s=o._,a=o.Promise,u=t("./diaspora"),c=t("./utils"),l=t("./errors/setValidationError"),f=function(t,e,r){return a.all(t.map(function(t,n){return t.emit(""+r+(s.isArray(e)?e[n]:e))}))},p={get:function(t,e){return e in t?t[e]:e in t.entities?t.entities[e]:"string"==typeof e&&e.match(/^-?\d+$/)&&t.entities.nth(parseInt(e))?t.entities.nth(parseInt(e)):void 0},set:function(t,e,r){if("model"===e)return new Error('Can\'t assign to read-only property "model".');"entities"===e&&(d.checkEntitiesFromModel(r,t.model),t.entities=s(r))}},d=function(){function t(e){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];n=s(n).flatten(),t.checkEntitiesFromModel(n.value(),e);var o=c.defineEnumerableProperties(this,{entities:n,model:e,length:{get:function(){return this.entities.size()}}});return new Proxy(o,p)}t.checkEntitiesFromModel=function(t,e){t.forEach(function(t,r){if(t.constructor.model!==e)throw new TypeError("Provided entity n°"+r+" "+t+" is not from model "+e+" ("+e.modelName+")")})};var e=t.prototype;return e.persist=function(){var t=h(regeneratorRuntime.mark(function t(e){var r,i,o,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=this.entities.map(function(t){return"orphan"===t.state?"Create":"Update"}).value(),i=s.partial(f,this.entities),t.next=4,i("Persist","before");case 4:return t.next=6,i("Validate","before");case 6:if(o=this.entities.map(function(t){try{t.validate()}catch(e){return console.error(e),u.logger.error("Validation failed:",{entity:t,error:e}),e}}).value(),!((a=s.compact(o).length)>0)){t.next=10;break}throw new l("Set validation failed for "+a+" elements (on "+this.length+"): ",o);case 10:return t.next=12,i("Validate","after");case 12:return t.next=14,n.call(this,e,"persist",s.map(r,function(t){return"Persist"+t}));case 14:return t.next=16,i("Persist","after");case 16:return t.abrupt("return",this);case 17:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),e.fetch=function(){var t=h(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.call(this,e,"fetch","Fetch");case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),e.destroy=function(){var t=h(regeneratorRuntime.mark(function t(e){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,n.call(this,e,"destroy","Destroy");case 2:return t.abrupt("return",this);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),e.update=function(t){return this.entities.forEach(function(e){c.applyUpdateEntity(t,e)}),this},e.toObject=function(){return this.entities.map(function(t){return t.toObject()}).value()},t}();e.exports=d},{"./dependencies":11,"./diaspora":12,"./errors/setValidationError":17,"./utils":21}],21:[function(t,e,r){(function(r){var n=t("./dependencies")._;e.exports={defineEnumerableProperties:function(t,e){var r=n.mapValues(e,function(t){(n.isNil(t)||"object"!=typeof t||Object.getPrototypeOf(t)!==Object.prototype)&&(t={value:t});var e={enumerable:!0};return t.hasOwnProperty("get")||(e.writable=!1),n.defaults(t,e),t});return Object.defineProperties(t,r)},applyUpdateEntity:function(t,e){return n.forEach(t,function(t,r){n.isUndefined(t)?delete e[r]:e[r]=t}),e},generateUUID:function(){var t=(new Date).getTime();r.performance&&"function"==typeof r.performance.now&&(t+=r.performance.now());return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?r:3&r|8).toString(16)})},applyOptionsToSet:function(t,e){return n.defaults(e,{limit:1/0,skip:0}),(t=t.slice(e.skip)).length>e.limit&&(t=t.slice(0,e.limit)),t}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./dependencies":11}],22:[function(t,e,r){var n=t("./dependencies"),i=t("./diaspora").components.Errors.EntityValidationError,o=n._,s=function(t){return function(e,r,n){if(!t(n))return{type:e.toValidatePath()+' expected to be a "'+r.type+'"'}}},a={TYPE:{string:s(o.isString),integer:s(o.isInteger),float:s(o.isNumber),date:s(o.isDate),boolean:s(o.isBoolean),object:function(t,e,r){var n=this;if(!o.isObject(r))return{type:t.toValidatePath()+' expected to be a "'+e.type+'"'};var i=o.isObject(e.attributes)?o(o.assign({},e.attributes,r)).mapValues(function(e,i){var o=r[i];return n.check(o,t.clone().pushValidationProp("attributes").pushProp(i),{getProps:!1})}).omitBy(o.isEmpty).value():{};return o.isEmpty(i)?void 0:{children:i}},array:function(t,e,r){if(!o.isArray(r))return{type:t.toValidatePath()+' expected to be a "'+e.type+'"'};var n=o.isObject(e.of)?o(r).map(function(t,e,r){return function(n,i){if(e.hasOwnProperty("of")){var s=o.castArray(e.of),a=o(s).map(function(s,a){return t.check(n,r.clone().pushValidationProp("of",o.isArray(e.of)?a:void 0).pushEntityProp(i),{getProps:!1})});if(!o.isArray(e.of))return a.get(0);if(a.compact().value().length===s.length)return a.toPlainObject().omitBy(o.isNil).value()}return{}}}(this,e,t)).omitBy(o.isEmpty).value():{};return o.isEmpty(n)?void 0:{children:n}},any:function(t,e,r){if(!o.stubTrue(r))return{type:t.toValidatePath()+" expected to be assigned with any type"}},_:function(t,e){return{type:t.toValidatePath()+' requires to be unhandled type "'+e.type+'"'}}}};o.assign(a.TYPE,{bool:a.TYPE.boolean,int:a.TYPE.integer,str:a.TYPE.string,text:a.TYPE.string});var u=[function(t){var e=this,r=t.error,n=t.fieldDesc,i=t.keys,s=t.value;o(n.validate).castArray().compact().forEach(function(t){t.call(e,s,n)||(r.validate=i.toValidatePath()+" custom validation failed")})},function(t){var e=t.error,r=t.fieldDesc,n=t.keys,i=t.value;o.isNil(r.type)||o.isNil(r.model)?!0===r.required&&o.isNil(i)?e.required=n.toValidatePath()+' is a required property of type "'+r.type+'"':o.isNil(i)||(o.isString(r.type)?o.assign(e,o.get(a,["TYPE",r.type],a.TYPE._).call(this,n,r,i)):e.spec=n.toValidatePath()+' spec "type" must be a string'):e.spec=n.toValidatePath()+" spec can't have both a type and a model"},function(t){var e=t.error,r=t.fieldDesc,n=t.keys,i=t.value;if(!o.isNil(i)&&!o.isNil(r.enum)){!1===o.some(r.enum,function(t){return t instanceof RegExp?null!==i.match(t):i===t})&&(e.enum=n.toValidatePath()+' expected to have one of enumerated values "'+JSON.stringify(r.enum)+'"')}}],c=Symbol("PRIVATE"),l=function(){function t(t,e){void 0===t&&(t=[]),void 0===e&&(e=[]),o.assign(this,{segmentsEntity:t,segmentsValidation:e})}var e=t.prototype;return e.pushEntityProp=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.segmentsEntity=o(this.segmentsEntity).concat(e).filter(o.isNil).value(),this},e.pushValidationProp=function(){for(var t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return this.segmentsValidation=o(this.segmentsValidation).concat(e).filter(function(t){return!o.isNil(t)}).value(),this},e.pushProp=function(){var t;return(t=this.pushEntityProp.apply(this,arguments)).pushValidationProp.apply(t,arguments)},e.toValidatePath=function(){return this.segmentsEntity.join(".")},e.toArray=function(){return[this.segmentsEntity.slice(),this.segmentsValidation.slice()]},e.clone=function(){return new(Function.prototype.bind.apply(t,[null].concat(this.toArray())))},t}(),f=function(){function t(t){var e={modelDesc:t};this[c]=e}var e=t.prototype;return e.validate=function(t){var e=this,r=o(this[c].modelDesc).mapValues(function(r,n){return e.check(t[n],(new l).pushProp(n),{getProps:!1})}).omitBy(o.isEmpty).value();if(!o.isNil(r)&&!o.isEmpty(r))throw new i(r,"Validation failed")},e.check=function(t,e,r){var n=this;void 0===r&&(r={}),o.defaults(r,{getProps:!0}),e instanceof l||(e=new l(e));var i=r.getProps?o.get(t,e.segmentsEntity):t,s=o.get(this[c].modelDesc,e.segmentsValidation);if(o.isObject(s)){o.defaults(s,{required:!1});var a={},f={error:a,fieldDesc:s,keys:e,value:i};return o.forEach(u,function(t){return t.call(n,f)}),o.isEmpty(a)?null:(a.value=t,a)}},p(t,[{key:"modelDesc",get:function(){return o.cloneDeep(this[c].modelDesc)}}],[{key:"PathStack",get:function(){return l}}]),t}();e.exports=f},{"./dependencies":11,"./diaspora":12}],23:[function(t,e,r){(function(t){function e(t,e){for(var r=0,n=t.length-1;n>=0;n--){var i=t[n];"."===i?t.splice(n,1):".."===i?(t.splice(n,1),r++):r&&(t.splice(n,1),r--)}if(e)for(;r--;r)t.unshift("..");return t}function n(t,e){if(t.filter)return t.filter(e);for(var r=[],n=0;n<t.length;n++)e(t[n],n,t)&&r.push(t[n]);return r}var i=/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/,o=function(t){return i.exec(t).slice(1)};r.resolve=function(){for(var r="",i=!1,o=arguments.length-1;o>=-1&&!i;o--){var s=o>=0?arguments[o]:t.cwd();if("string"!=typeof s)throw new TypeError("Arguments to path.resolve must be strings");s&&(r=s+"/"+r,i="/"===s.charAt(0))}return r=e(n(r.split("/"),function(t){return!!t}),!i).join("/"),(i?"/":"")+r||"."},r.normalize=function(t){var i=r.isAbsolute(t),o="/"===s(t,-1);return(t=e(n(t.split("/"),function(t){return!!t}),!i).join("/"))||i||(t="."),t&&o&&(t+="/"),(i?"/":"")+t},r.isAbsolute=function(t){return"/"===t.charAt(0)},r.join=function(){var t=Array.prototype.slice.call(arguments,0);return r.normalize(n(t,function(t,e){if("string"!=typeof t)throw new TypeError("Arguments to path.join must be strings");return t}).join("/"))},r.relative=function(t,e){function n(t){for(var e=0;e<t.length&&""===t[e];e++);for(var r=t.length-1;r>=0&&""===t[r];r--);return e>r?[]:t.slice(e,r-e+1)}t=r.resolve(t).substr(1),e=r.resolve(e).substr(1);for(var i=n(t.split("/")),o=n(e.split("/")),s=Math.min(i.length,o.length),a=s,u=0;u<s;u++)if(i[u]!==o[u]){a=u;break}var c=[];for(u=a;u<i.length;u++)c.push("..");return(c=c.concat(o.slice(a))).join("/")},r.sep="/",r.delimiter=":",r.dirname=function(t){var e=o(t),r=e[0],n=e[1];return r||n?(n&&(n=n.substr(0,n.length-1)),r+n):"."},r.basename=function(t,e){var r=o(t)[2];return e&&r.substr(-1*e.length)===e&&(r=r.substr(0,r.length-e.length)),r},r.extname=function(t){return o(t)[3]};var s="b"==="ab".substr(-1)?function(t,e,r){return t.substr(e,r)}:function(t,e,r){return e<0&&(e=t.length+e),t.substr(e,r)}}).call(this,t("_process"))},{_process:24}],24:[function(t,e,r){function n(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(t){if(l===setTimeout)return setTimeout(t,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(t,0);try{return l(t,0)}catch(e){try{return l.call(null,t,0)}catch(e){return l.call(this,t,0)}}}function s(){y&&d&&(y=!1,d.length?h=d.concat(h):m=-1,h.length&&a())}function a(){if(!y){var t=o(s);y=!0;for(var e=h.length;e;){for(d=h,h=[];++m<e;)d&&d[m].run();m=-1,e=h.length}d=null,y=!1,function(t){if(f===clearTimeout)return clearTimeout(t);if((f===i||!f)&&clearTimeout)return f=clearTimeout,clearTimeout(t);try{f(t)}catch(e){try{return f.call(null,t)}catch(e){return f.call(this,t)}}}(t)}}function u(t,e){this.fun=t,this.array=e}function c(){}var l,f,p=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(t){l=n}try{f="function"==typeof clearTimeout?clearTimeout:i}catch(t){f=i}}();var d,h=[],y=!1,m=-1;p.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)e[r-1]=arguments[r];h.push(new u(t,e)),1!==h.length||y||o(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=c,p.addListener=c,p.once=c,p.off=c,p.removeListener=c,p.removeAllListeners=c,p.emit=c,p.prependListener=c,p.prependOnceListener=c,p.listeners=function(t){return[]},p.binding=function(t){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(t){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},{}],25:[function(t,e,r){!function(t){function r(t,e,r,o){var s=e&&e.prototype instanceof i?e:i,a=Object.create(s.prototype),u=new p(o||[]);return a._invoke=function(t,e,r){var i=S;return function(o,s){if(i===j)throw new Error("Generator is already running");if(i===N){if("throw"===o)throw s;return h()}for(r.method=o,r.arg=s;;){var a=r.delegate;if(a){var u=c(a,r);if(u){if(u===k)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===S)throw i=N,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=j;var l=n(t,e,r);if("normal"===l.type){if(i=r.done?N:P,l.arg===k)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(i=N,r.method="throw",r.arg=l.arg)}}}(t,r,u),a}function n(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}function i(){}function o(){}function s(){}function a(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function u(t){function e(r,i,o,s){var a=n(t[r],t,i);if("throw"!==a.type){var u=a.arg,c=u.value;return c&&"object"==typeof c&&v.call(c,"__await")?Promise.resolve(c.__await).then(function(t){e("next",t,o,s)},function(t){e("throw",t,o,s)}):Promise.resolve(c).then(function(t){u.value=t,o(u)},s)}s(a.arg)}var r;this._invoke=function(t,n){function i(){return new Promise(function(r,i){e(t,n,r,i)})}return r=r?r.then(i,i):i()}}function c(t,e){var r=t.iterator[e.method];if(r===y){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=y,c(t,e),"throw"===e.method))return k;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return k}var i=n(r,t.iterator,e.arg);if("throw"===i.type)return e.method="throw",e.arg=i.arg,e.delegate=null,k;var o=i.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=y),e.delegate=null,k):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,k)}function l(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function f(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(l,this),this.reset(!0)}function d(t){if(t){var e=t[b];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,n=function e(){for(;++r<t.length;)if(v.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=y,e.done=!0,e};return n.next=n}}return{next:h}}function h(){return{value:y,done:!0}}var y,m=Object.prototype,v=m.hasOwnProperty,g="function"==typeof Symbol?Symbol:{},b=g.iterator||"@@iterator",w=g.asyncIterator||"@@asyncIterator",E=g.toStringTag||"@@toStringTag",x="object"==typeof e,O=t.regeneratorRuntime;if(O)x&&(e.exports=O);else{(O=t.regeneratorRuntime=x?e.exports:{}).wrap=r;var S="suspendedStart",P="suspendedYield",j="executing",N="completed",k={},T={};T[b]=function(){return this};var A=Object.getPrototypeOf,D=A&&A(A(d([])));D&&D!==m&&v.call(D,b)&&(T=D);var _=s.prototype=i.prototype=Object.create(T);o.prototype=_.constructor=s,s.constructor=o,s[E]=o.displayName="GeneratorFunction",O.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===o||"GeneratorFunction"===(e.displayName||e.name))},O.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,s):(t.__proto__=s,E in t||(t[E]="GeneratorFunction")),t.prototype=Object.create(_),t},O.awrap=function(t){return{__await:t}},a(u.prototype),u.prototype[w]=function(){return this},O.AsyncIterator=u,O.async=function(t,e,n,i){var o=new u(r(t,e,n,i));return O.isGeneratorFunction(e)?o:o.next().then(function(t){return t.done?t.value:o.next()})},a(_),_[E]="Generator",_[b]=function(){return this},_.toString=function(){return"[object Generator]"},O.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},O.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=y,this.done=!1,this.delegate=null,this.method="next",this.arg=y,this.tryEntries.forEach(f),!t)for(var e in this)"t"===e.charAt(0)&&v.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=y)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){function e(e,n){return o.type="throw",o.arg=t,r.next=e,n&&(r.method="next",r.arg=y),!!n}if(this.done)throw t;for(var r=this,n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n],o=i.completion;if("root"===i.tryLoc)return e("end");if(i.tryLoc<=this.prev){var s=v.call(i,"catchLoc"),a=v.call(i,"finallyLoc");if(s&&a){if(this.prev<i.catchLoc)return e(i.catchLoc,!0);if(this.prev<i.finallyLoc)return e(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return e(i.catchLoc,!0)}else{if(!a)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return e(i.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&v.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=e,i?(this.method="next",this.next=i.finallyLoc,k):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),k},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),f(r),k}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var i=n.arg;f(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:d(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=y),k}}}}(function(){return this}()||Function("return this")())},{}]},{},[1])(1)})});
//# sourceMappingURL=diaspora.min.js.map